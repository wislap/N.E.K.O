<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="api.settingsTitle">API Key è®¾ç½® - Project N.E.K.O.</title>
    <!-- i18next åŠ è½½å™¨ï¼ˆç»Ÿä¸€å¤„ç† CDN åŠ è½½å’Œåˆå§‹åŒ–ï¼‰ -->
    <script src="/static/i18n-i18next.js"></script>
    <style>
        *:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #f7f8fa;
            color: #222;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        .container {
            max-width: 800px;
            margin: 40px auto 0 auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 32px 24px 24px 24px;
        }

        h2 {
            margin-top: 0;
            font-size: 1.5rem;
            color: #333;
        }

        .section {
            margin-bottom: 32px;
        }

        .field-row {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .field-row label {
            min-width: auto;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .field-row label em {
            font-weight: normal;
        }

        .field-row input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
        }

        .field-row input:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #ced4da;
            opacity: 0.8;
            font-style: italic;
        }

        .field-row select:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #ced4da;
            opacity: 0.8;
            font-style: italic;
        }

        .field-row select option:disabled {
            color: #999;
        }

        .field-row input::placeholder {
            font-size: 0.9rem;
            color: #999;
        }

        .field-row input:focus {
            outline: none;
            border-color: #4f8cff;
            box-shadow: 0 0 0 2px rgba(79, 140, 255, 0.2);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            background: #4f8cff;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 12px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2662c8;
        }

        .btn:active {
            background: #1e4a9e;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #545b62;
        }

        .tips {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            margin-top: 16px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        #current-api-key {
            background: #e7f3ff;
            color: #0d6efd;
            border: 1px solid #b3d9ff;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .api-key-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .api-key-info h3 {
            margin-top: 0;
            color: #495057;
            font-size: 1.1em;
        }

        .api-key-info ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .api-key-info li {
            margin-bottom: 4px;
            color: #6c757d;
        }

        /* å¼¹å‡ºå¼è­¦å‘Šæ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-warning {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            margin: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .modal-warning h3 {
            margin-top: 0;
            color: #d63031;
            font-size: 1.2em;
        }

        .modal-warning ul {
            margin: 16px 0;
            padding-left: 20px;
        }

        .modal-warning li {
            margin-bottom: 8px;
            color: #495057;
            line-height: 1.4;
        }

        .modal-buttons {
            text-align: right;
            margin-top: 20px;
        }

        .modal-buttons .btn {
            margin-left: 10px;
        }

        /* æ‚¬æµ®æç¤ºçª—æ ·å¼ */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #4f8cff;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            cursor: help;
            margin-left: 8px;
            font-weight: bold;
        }

        .tooltip-content {
            position: fixed;
            background: #333;
        }

        /* è‡ªå®šä¹‰APIæŠ˜å æ ·å¼ */
        .custom-api-container {
            transition: all 0.3s ease-in-out;
        }

        .model-config-container {
            margin-bottom: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }

        .model-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s ease-in-out;
        }

        .model-header:hover {
            background: #e9ecef;
        }

        .model-title {
            font-weight: bold;
            color: #495057;
            font-size: 0.95rem;
        }

        .toggle-icon {
            transition: transform 0.3s ease-in-out;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .model-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .model-content.expanded {
            max-height: 1000px;
        }

        .model-content .field-row {
            margin: 0;
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .model-content .field-row:last-child {
            border-bottom: none;
        }

        .model-content .field-row label {
            font-weight: normal;
            color: #666;
            font-size: 0.9rem;
        }

        .model-content .field-row input {
            max-width: 600px;
            margin-top: 4px;
        }

        .tooltip-content {
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.85em;
            line-height: 1.4;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            max-width: min(500px, calc(100vw - 40px));
            white-space: normal;
            pointer-events: none;
        }

        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: var(--arrow-left, 50%);
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip-content[data-position="bottom"]::after {
            top: auto;
            bottom: 100%;
            border-color: transparent transparent #333 transparent;
        }

        @media (max-width: 800px) {
            .container {
                padding: 20px 16px;
                margin: 20px 16px;
            }

            .tooltip-content {
                max-width: calc(100vw - 40px);
                font-size: 0.8em;
            }
        }
    </style>
</head>

<body>
    <!-- åŠ è½½é®ç½©å±‚ - æ¨¡ä»¿ä¸»ç•Œé¢"æ­£åœ¨å¯åŠ¨éº¦å…‹é£"æ ·å¼ -->
    <div id="loading-overlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; justify-content: center; align-items: center; z-index: 9999;">
        <div id="voice-preparing-toast" style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-image: url('/static/icons/reminder_blue.png');
        background-size: 100% 100%;
        background-position: center;
        background-repeat: no-repeat;
        background-color: transparent;
        color: white;
        padding: 20px 32px;
        border-radius: 16px;
        font-size: 16px;
        font-weight: 600;
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: voiceToastFadeIn 0.3s ease;
        pointer-events: none;
        width: 320px;
        box-sizing: border-box;
        justify-content: center;
    ">
            <div style="
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        "></div>
            <span>ğŸ“‹ æ­£åœ¨åŠ è½½é…ç½®...</span>
        </div>
    </div>

    <style>
        @keyframes voiceToastFadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- ä¸»å†…å®¹å®¹å™¨ - ç›´æ¥æ˜¾ç¤ºåŸæœ‰UIï¼Œé€šè¿‡é®ç½©å±‚åŠé€æ˜è¦†ç›– -->
    <div id="main-content">
        <div class="container">
            <h2 data-i18n="api.settings">API Key è®¾ç½®</h2>

            <div class="api-key-info">
                <h3 data-i18n="api.quickStart">ğŸ“‹ å¿«é€Ÿå¼€å§‹</h3>
                <ul>
                    <li><strong data-i18n="api.freeVersion">å…è´¹ç‰ˆï¼ˆæ¨èæ–°æ‰‹ï¼‰ï¼š</strong><span
                            data-i18n="api.freeVersionDesc">æ— éœ€æ³¨å†Œï¼Œåœ¨ä¸‹æ–¹é«˜çº§é€‰é¡¹ä¸­é€‰æ‹©"å…è´¹ç‰ˆ"å³å¯ä½¿ç”¨</span></li>
                    <li><strong data-i18n="api.fullVersion">å®Œæ•´ç‰ˆï¼ˆè·å–API Keyï¼‰ï¼š</strong></li>
                    <li style="margin-left: 20px;">1. <span data-i18n="api.step1">åœ¨é˜¿é‡Œäº‘æ³¨å†Œè´¦å·å¹¶</span> <a
                            href="https://myaccount.console.aliyun.com/overview" target="_blank"
                            data-i18n="api.step1Link">å®Œæˆå®åè®¤è¯</a></li>
                    <li style="margin-left: 20px;">2. <span data-i18n="api.step2">è®¿é—®é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°</span> <a
                            href="https://bailian.console.aliyun.com/api-key?tab=model#/api-key" target="_blank"
                            data-i18n="api.step2Link">API Keyç®¡ç†é¡µé¢</a></li>
                    <li style="margin-left: 20px;">3. <span data-i18n="api.step3">åˆ›å»ºæ–°çš„API Keyå¹¶ç‚¹å‡»å¤åˆ¶æŒ‰é’®</span></li>
                    <li style="margin-left: 20px;">4. <span data-i18n="api.step4">å°†API Keyç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†ä¸­</span></li>
                </ul>
            </div>



            <div class="section">
                <div
                    style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 16px; margin-bottom: 16px; font-size: 0.95em; color: #155724; line-height: 1.5;">
                    <strong data-i18n="api.newbieRecommend">ğŸ‰ æ–°æ‰‹æ¨èï¼šå¦‚æœæ‚¨è¿˜æ²¡æœ‰API
                        Keyï¼Œå¯ä»¥ç›´æ¥åœ¨ä¸‹æ–¹é«˜çº§é€‰é¡¹ä¸­é€‰æ‹©"å…è´¹ç‰ˆ"å¼€å§‹ä½¿ç”¨ï¼Œæ— éœ€æ³¨å†Œä»»ä½•è´¦å·ï¼</strong>
                </div>
                <div class="tips">
                    <span data-i18n="api.tip">ğŸ’¡ è¯·ç¡®ä¿API Keyæ ¼å¼æ­£ç¡®ã€‚ä¿å­˜åéœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆã€‚</span><br>
                    <span data-i18n="api.tip2">ğŸ“ ä¸ªäººä½¿ç”¨ç¯å¢ƒï¼ŒAPI Keyå°†å®Œæ•´æ˜¾ç¤ºä»¥ä¾¿å¤åˆ¶ä½¿ç”¨ã€‚</span>
                </div>

                <form id="api-key-form">
                    <div class="field-row">
                        <label><span data-i18n="api.coreApiKey">æ ¸å¿ƒAPI Key</span><span id="freeVersionHint"
                                style="color: #28a745; font-weight: normal; display: none;"
                                data-i18n="api.freeVersionHint">ï¼ˆå…è´¹ç‰ˆæ— éœ€å¡«å†™ï¼‰</span></label>
                        <input type="text" id="apiKeyInput" data-i18n-placeholder="api.coreApiPlaceholder"
                            placeholder="è¯·è¾“å…¥æ‚¨çš„API Key" required style="max-width: 600px;">
                    </div>

                    <div style="margin-top: 20px;">
                        <button type="submit" class="btn" data-i18n="api.saveSettings">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                        <button type="button" class="btn secondary" onclick="closeApiKeySettings()"
                            data-i18n="api.closeSettings">âŒ å…³é—­</button>
                    </div>
                </form>

                <div id="current-api-key" class="status info" style="display: none;"></div>
                <div id="status" class="status"></div>
            </div>

            <div id="advanced-section" class="section" style="margin-top: 0;">
                <div style="margin-bottom: 8px; cursor: pointer; user-select: none; display: flex; align-items: center;"
                    onclick="toggleAdvancedOptions()">
                    <span id="advanced-arrow"
                        style="font-size: 1.2em; margin-right: 6px; transition: transform 0.2s;">â–¶</span>
                    <span style="font-weight: bold; color: #333;" data-i18n="api.advancedOptions">é«˜çº§é€‰é¡¹ï¼ˆå¯é€‰ï¼‰</span>
                    <div class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <div class="tooltip-content">
                            <strong data-i18n="api.providerDescription">APIæœåŠ¡å•†è¯´æ˜ï¼š</strong><br>
                            â€¢ <strong data-i18n="api.coreApiDesc">æ ¸å¿ƒAPIï¼šè´Ÿè´£å¯¹è¯åŠŸèƒ½</strong><br>
                            â€¢ <strong data-i18n="api.assistApiDesc">è¾…åŠ©APIï¼šè´Ÿè´£è®°å¿†ç®¡ç†å’Œè‡ªå®šä¹‰è¯­éŸ³</strong><br><br>
                            <strong data-i18n="api.providerFeatures">å„æœåŠ¡å•†ç‰¹ç‚¹ï¼š</strong><br>
                            â€¢ <span data-i18n="api.aliFeature">é˜¿é‡Œï¼šæœ‰å…è´¹é¢åº¦ï¼Œæ”¯æŒè‡ªå®šä¹‰è¯­éŸ³</span><br>
                            â€¢ <span data-i18n="api.glmFeature">æ™ºè°±ï¼šå…è´¹é¢åº¦å¤šï¼Œå†…ç½®è”ç½‘æœç´¢åŠŸèƒ½</span><br>
                            â€¢ <span data-i18n="api.stepFeature">é˜¶è·ƒæ˜Ÿè¾°ï¼šæœ‰å…è´¹é¢åº¦ï¼Œä¸æ”¯æŒè§†é¢‘</span><br>
                            â€¢ <span data-i18n="api.openaiFeature">OpenAIï¼šéœ€è¦ç¿»å¢™ï¼Œä»·æ ¼è´µï¼Œæ™ºèƒ½æ°´å¹³é«˜</span><br>
                            â€¢ <span data-i18n="api.siliconFeature">ç¡…åŸºæµåŠ¨ï¼šæ€§ä»·æ¯”é«˜ï¼ŒåŠŸèƒ½å°‘ï¼Œåªä½œä¸ºè¾…åŠ©APIä½¿ç”¨</span>
                        </div>
                    </div>
                </div>
                <div id="advanced-options" style="display: none; padding: 12px 0 0 0; border-top: 1px solid #eee;">
                    <div
                        style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 6px; padding: 16px; margin-bottom: 16px; font-size: 0.9em; color: #0d6efd; line-height: 1.5;">
                        <strong data-i18n="api.configSuggestion">ğŸ’¡ é…ç½®å»ºè®®ï¼š</strong><br>
                        â€¢ <span data-i18n="api.freeVersionSuggestion">å…è´¹ç‰ˆï¼šå®Œå…¨å…è´¹ï¼Œæ— éœ€API
                            Keyï¼Œé€‚åˆæ–°æ‰‹ä½“éªŒï¼ˆä¸æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³ã€Agentæ¨¡å¼å’Œè§†é¢‘å¯¹è¯ï¼‰</span><br>
                        â€¢ <span data-i18n="api.coreApiSuggestion">æ ¸å¿ƒAPIï¼šè´Ÿè´£å¯¹è¯åŠŸèƒ½ï¼Œå»ºè®®æ ¹æ®é¢„ç®—å’Œéœ€æ±‚é€‰æ‹©</span><br>
                        â€¢ <span data-i18n="api.assistApiSuggestion">è¾…åŠ©APIï¼šè´Ÿè´£è®°å¿†ç®¡ç†å’Œè‡ªå®šä¹‰è¯­éŸ³ï¼Œåªæœ‰é˜¿é‡Œæ”¯æŒè‡ªå®šä¹‰è¯­éŸ³</span><br>
                    </div>
                    <div class="field-row">
                        <label for="coreApiSelect">
                            <span data-i18n="api.coreApiProvider">æ ¸å¿ƒAPIæœåŠ¡å•†</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong data-i18n="api.coreApiTitle">æ ¸å¿ƒAPIè´Ÿè´£å¯¹è¯åŠŸèƒ½ï¼š</strong><br>
                                    â€¢ <span data-i18n="api.freeVersionCore">å…è´¹ç‰ˆï¼šå®Œå…¨å…è´¹ï¼Œæ— éœ€API
                                        Keyï¼Œä½†ä¸æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³ã€Agentæ¨¡å¼å’Œè§†é¢‘å¯¹è¯</span><br>
                                    â€¢ <span data-i18n="api.aliCore">é˜¿é‡Œï¼šæœ‰å…è´¹é¢åº¦ï¼ŒåŠŸèƒ½å…¨é¢</span><br>
                                    â€¢ <span data-i18n="api.glmCore">æ™ºè°±ï¼šæœ‰å…è´¹é¢åº¦ï¼Œä½†éœ€å……å€¼1å…ƒï¼Œå†…ç½®è”ç½‘æœç´¢åŠŸèƒ½</span><br>
                                    â€¢ <span data-i18n="api.stepCore">é˜¶è·ƒæ˜Ÿè¾°ï¼šå®Œå…¨å…è´¹ï¼Œä½†ä¸æ”¯æŒè§†é¢‘</span><br>
                                    â€¢ <span data-i18n="api.openaiCore">OpenAIï¼šæ™ºèƒ½æ°´å¹³æœ€é«˜ï¼Œä½†éœ€è¦ç¿»å¢™ä¸”ä»·æ ¼æ˜‚è´µ</span>
                                </div>
                            </div>
                        </label>
                        <select id="coreApiSelect"
                            style="width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem;">
                            <!-- é€‰é¡¹å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                        </select>
                    </div>
                    <div class="field-row">
                        <label for="assistApiSelect">
                            <span data-i18n="api.assistApiProvider">è¾…åŠ©APIï¼ˆè®°å¿†ç®¡ç†/è‡ªå®šä¹‰è¯­éŸ³/æ–‡æœ¬èŠå¤©ï¼‰</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong data-i18n="api.assistApiTitle">è¾…åŠ©APIè´Ÿè´£è®°å¿†ç®¡ç†å’Œè‡ªå®šä¹‰è¯­éŸ³ï¼š</strong><br>
                                    â€¢ <span data-i18n="api.freeVersionAssist">å…è´¹ç‰ˆï¼šå®Œå…¨å…è´¹ï¼Œæ— éœ€API Keyï¼Œä½†ä¸æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³</span><br>
                                    â€¢ <span data-i18n="api.aliAssist">é˜¿é‡Œï¼šæ¨èé€‰æ‹©ï¼Œæ”¯æŒè‡ªå®šä¹‰è¯­éŸ³</span><br>
                                    â€¢ <span data-i18n="api.glmAssist">æ™ºè°±ï¼šæ”¯æŒAgentæ¨¡å¼</span><br>
                                    â€¢ <span data-i18n="api.stepAssist">é˜¶è·ƒæ˜Ÿè¾°ï¼šä»·æ ¼ç›¸å¯¹ä¾¿å®œ</span><br>
                                    â€¢ <span data-i18n="api.siliconAssist">ç¡…åŸºæµåŠ¨ï¼šæ€§ä»·æ¯”é«˜</span><br>
                                    â€¢ <span data-i18n="api.openaiAssist">OpenAIï¼šè®°å¿†ç®¡ç†èƒ½åŠ›å¼º</span><br>
                                    <strong data-i18n="api.assistApiNote">æ³¨æ„ï¼šåªæœ‰é˜¿é‡Œæ”¯æŒè‡ªå®šä¹‰è¯­éŸ³åŠŸèƒ½</strong>
                                </div>
                            </div>
                        </label>
                        <select id="assistApiSelect"
                            style="width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem;">
                            <!-- é€‰é¡¹å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                        </select>
                    </div>
                    <div class="field-row">
                        <label for="assistApiKeyInputQwen"><span data-i18n="api.assistApiKeyQwen">è¾…åŠ©API Key -
                                é˜¿é‡Œ</span><em data-i18n="api.assistApiKeyHint"
                                data-i18n-params='{"providerKey":"ali"}'>ï¼ˆä»…å½“è¾…åŠ©APIä¸ºé˜¿é‡Œæ—¶éœ€è¦å¡«å†™ï¼‰</em></label>
                        <input type="text" id="assistApiKeyInputQwen"
                            data-i18n-placeholder="api.assistApiKeyPlaceholder" placeholder="å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key" value=""
                            style="max-width: 600px;">
                    </div>
                    <div class="field-row">
                        <label for="assistApiKeyInputOpenai"><span data-i18n="api.assistApiKeyOpenai">è¾…åŠ©API Key -
                                OpenAI</span><em data-i18n="api.assistApiKeyHint"
                                data-i18n-params='{"providerKey":"openai"}'>ï¼ˆä»…å½“è¾…åŠ©APIä¸ºOpenAIæ—¶éœ€è¦å¡«å†™ï¼‰</em></label>
                        <input type="text" id="assistApiKeyInputOpenai"
                            data-i18n-placeholder="api.assistApiKeyPlaceholder" placeholder="å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key" value=""
                            style="max-width: 600px;">
                    </div>
                    <div class="field-row">
                        <label for="assistApiKeyInputGlm"><span data-i18n="api.assistApiKeyGlm">è¾…åŠ©API Key - æ™ºè°±</span><em
                                data-i18n="api.assistApiKeyHint"
                                data-i18n-params='{"providerKey":"glm"}'>ï¼ˆä»…å½“è¾…åŠ©APIä¸ºæ™ºè°±æ—¶éœ€è¦å¡«å†™ï¼‰</em></label>
                        <input type="text" id="assistApiKeyInputGlm" data-i18n-placeholder="api.assistApiKeyPlaceholder"
                            placeholder="å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key" value="" style="max-width: 600px;">
                    </div>
                    <div class="field-row">
                        <label for="assistApiKeyInputStep"><span data-i18n="api.assistApiKeyStep">è¾…åŠ©API Key -
                                é˜¶è·ƒæ˜Ÿè¾°</span><em data-i18n="api.assistApiKeyHint"
                                data-i18n-params='{"providerKey":"step"}'>ï¼ˆä»…å½“è¾…åŠ©APIä¸ºé˜¶è·ƒæ˜Ÿè¾°æ—¶éœ€è¦å¡«å†™ï¼‰</em></label>
                        <input type="text" id="assistApiKeyInputStep"
                            data-i18n-placeholder="api.assistApiKeyPlaceholder" placeholder="å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key" value=""
                            style="max-width: 600px;">
                    </div>
                    <div class="field-row">
                        <label for="assistApiKeyInputSilicon"><span data-i18n="api.assistApiKeySilicon">è¾…åŠ©API Key -
                                ç¡…åŸºæµåŠ¨</span><em data-i18n="api.assistApiKeyHint"
                                data-i18n-params='{"providerKey":"silicon"}'>ï¼ˆä»…å½“è¾…åŠ©APIä¸ºç¡…åŸºæµåŠ¨æ—¶éœ€è¦å¡«å†™ï¼‰</em></label>
                        <input type="text" id="assistApiKeyInputSilicon"
                            data-i18n-placeholder="api.assistApiKeyPlaceholder" placeholder="å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key" value=""
                            style="max-width: 600px;">
                    </div>

                    <!-- MCP Router Tokenè®¾ç½®ï¼ˆä»…ä¿ç•™è¾“å…¥æ¡†ï¼‰ -->
                    <div class="field-row" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #6c757d;">
                        <label for="mcpTokenInput">
                            <span data-i18n="api.mcpRouterToken">MCP Router Token</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong data-i18n="api.mcpRouterTokenDesc">MCP Router Tokenè¯´æ˜ï¼š</strong><br>
                                    <span data-i18n="api.mcpRouterTokenDescText">ç”¨äºè®¿é—®MCP
                                        RouteræœåŠ¡çš„è®¤è¯ä»¤ç‰Œï¼Œå¯ç”¨MCPåŠŸèƒ½æ—¶éœ€è¦å¡«å†™ã€‚å¦‚æœæ‚¨çš„MCP Routerä¸éœ€è¦è®¤è¯ï¼Œå¯ä»¥ç•™ç©ºã€‚</span>
                                </div>
                            </div>
                            <span
                                style="font-weight: normal; font-size: 0.9em; color: #666; display: block; margin-top: 4px;"><span
                                    data-i18n="api.mcpRouterNoteBefore">å½“å‰ç‰ˆæœ¬è¯·è‡ªè¡Œè·å–å¹¶é…ç½®</span> <a
                                    href="https://mcp-router.net/" target="_blank" style="color: #4f8cff;">MCP
                                    Router</a><span data-i18n="api.mcpRouterNoteAfter">ï¼Œåç»­ç‰ˆæœ¬ä¼šä¼˜åŒ–ã€‚</span></span>
                        </label>
                        <input type="text" id="mcpTokenInput" data-i18n-placeholder="api.mcpRouterTokenPlaceholder"
                            placeholder="è¯·è¾“å…¥MCP Router Tokenï¼ˆå¯é€‰ï¼‰" value=""
                            style="width: 100%; max-width: 600px; padding: 10px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; font-family: 'Courier New', monospace;">
                    </div>

                    <!-- ç”¨æˆ·è‡ªå®šä¹‰APIé…ç½®ï¼ˆä½äºé«˜çº§é€‰é¡¹å†…éƒ¨æœ€ä¸‹æ–¹ï¼‰ -->
                    <div id="custom-api-section"
                        style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #6c757d;">
                        <div style="margin-bottom: 8px; cursor: pointer; user-select: none; display: flex; align-items: center;"
                            onclick="toggleCustomApiSection()">
                            <span id="custom-api-arrow"
                                style="font-size: 1.2em; margin-right: 6px; transition: transform 0.2s;">â–¶</span>
                            <span style="font-weight: bold; color: #6c757d;"
                                data-i18n="api.customApiConfig">è‡ªå®šä¹‰APIé…ç½®</span>
                        </div>
                        <div id="custom-api-options"
                            style="display: none; padding: 12px 0 0 0; border-top: 1px solid #eee;">
                            <div
                                style="background: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 6px; padding: 16px; margin-bottom: 16px; font-size: 0.9em; color: #0d6efd; line-height: 1.5;">
                                <strong data-i18n="api.customApiDescription">ğŸ’¡ è‡ªå®šä¹‰APIè¯´æ˜ï¼š</strong><br>
                                <span
                                    data-i18n="api.customApiDescriptionText">è¿™äº›APIç”¨äºç‰¹å®šçš„åŠŸèƒ½æ¨¡å—ï¼Œå¦‚æ‘˜è¦ç”Ÿæˆã€æ–‡æœ¬çº é”™ã€æƒ…æ„Ÿåˆ†æã€è§†è§‰è¯†åˆ«ã€å…¨æ¨¡æ€å¯¹è¯å’Œè¯­éŸ³åˆæˆã€‚æ¯ä¸ªAPIéƒ½éœ€è¦å•ç‹¬é…ç½®ä¾›åº”å•†ã€URLã€æ¨¡å‹IDå’ŒAPI
                                    Keyã€‚</span><br>
                                <strong data-i18n="api.customApiWarning">âš ï¸
                                    æ³¨æ„ï¼šå¯ç”¨è‡ªå®šä¹‰APIåï¼Œå°†ä¼˜å…ˆä½¿ç”¨ä¸‹æ–¹çš„è‡ªå®šä¹‰é…ç½®ï¼Œæ ¸å¿ƒAPIå’Œè¾…åŠ©APIä»å¯å•ç‹¬è°ƒæ•´ã€‚</strong>
                            </div>

                            <!-- å¯ç”¨è‡ªå®šä¹‰APIå¼€å…³ -->
                            <div class="field-row" style="margin-bottom: 20px;">
                                <label for="enableCustomApi"
                                    style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="enableCustomApi"
                                        style="margin-right: 8px; width: 18px; height: 18px;">
                                    <span style="font-weight: bold;" data-i18n="api.enableCustomApi">å¯ç”¨è‡ªå®šä¹‰APIé…ç½®</span>
                                </label>
                                <div style="color: #666; font-size: 0.9em; margin-top: 4px;"
                                    data-i18n="api.enableCustomApiNote">
                                    å¯ç”¨åå°†ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰APIé…ç½®ï¼Œä¸å†å¼ºåˆ¶ç»‘å®šæ ¸å¿ƒAPIä¸è¾…åŠ©APIï¼Œä½†ä»å¯æ‰‹åŠ¨è°ƒæ•´å®ƒä»¬
                                </div>
                            </div>

                            <!-- è‡ªå®šä¹‰APIæŠ˜å å®¹å™¨ -->
                            <div id="custom-api-container" class="custom-api-container" style="display: none;">

                                <!-- æ‘˜è¦æ¨¡å‹é…ç½® -->
                                <div class="model-config-container">
                                    <div class="model-header" onclick="toggleModelConfig('summary')">
                                        <span class="model-title" data-i18n="api.summaryModelConfig">ğŸ“ æ‘˜è¦æ¨¡å‹é…ç½®</span>
                                        <span class="toggle-icon">â–¼</span>
                                    </div>
                                    <div id="summary-model-content" class="model-content">
                                        <div class="field-row">
                                            <label for="summaryModelProvider" data-i18n="api.provider">ä¾›åº”å•†</label>
                                            <input type="text" id="summaryModelProvider"
                                                data-i18n-placeholder="api.providerPlaceholder"
                                                placeholder="å¦‚ï¼šopenaiã€azureã€custom" value="" style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="summaryModelUrl" data-i18n="api.apiUrl">API URL</label>
                                            <input type="text" id="summaryModelUrl"
                                                data-i18n-placeholder="api.apiUrlPlaceholder"
                                                placeholder="å¦‚ï¼šhttps://api.openai.com/v1" value=""
                                                style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="summaryModelId" data-i18n="api.modelId">æ¨¡å‹ID</label>
                                            <input type="text" id="summaryModelId"
                                                data-i18n-placeholder="api.modelIdPlaceholder"
                                                placeholder="å¦‚ï¼šgpt-3.5-turboã€qwen-turboã€glm-4-flash" value=""
                                                style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="summaryModelApiKey" data-i18n="api.apiKey">API Key</label>
                                            <input type="text" id="summaryModelApiKey"
                                                data-i18n-placeholder="api.summaryModelApiKeyPlaceholder"
                                                placeholder="è¯·è¾“å…¥æ‘˜è¦æ¨¡å‹çš„API Key" value="" style="max-width: 600px;">
                                        </div>
                                    </div>
                                </div>

                                <!-- çº é”™æ¨¡å‹é…ç½® -->
                                <div class="model-config-container">
                                    <div class="model-header" onclick="toggleModelConfig('correction')">
                                        <span class="model-title" data-i18n="api.correctionModelConfig">âœï¸ çº é”™æ¨¡å‹é…ç½®</span>
                                        <span class="toggle-icon">â–¼</span>
                                    </div>
                                    <div id="correction-model-content" class="model-content">
                                        <div class="field-row">
                                            <label for="correctionModelProvider" data-i18n="api.provider">ä¾›åº”å•†</label>
                                            <input type="text" id="correctionModelProvider"
                                                data-i18n-placeholder="api.providerPlaceholder"
                                                placeholder="å¦‚ï¼šopenaiã€azureã€custom" value="" style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="correctionModelUrl" data-i18n="api.apiUrl">API URL</label>
                                            <input type="text" id="correctionModelUrl"
                                                data-i18n-placeholder="api.apiUrlPlaceholder"
                                                placeholder="å¦‚ï¼šhttps://api.openai.com/v1" value=""
                                                style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="correctionModelId" data-i18n="api.modelId">æ¨¡å‹ID</label>
                                            <input type="text" id="correctionModelId"
                                                data-i18n-placeholder="api.modelIdPlaceholder"
                                                placeholder="å¦‚ï¼šgpt-3.5-turboã€qwen-turboã€glm-4-flash" value=""
                                                style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="correctionModelApiKey" data-i18n="api.apiKey">API Key</label>
                                            <input type="text" id="correctionModelApiKey"
                                                data-i18n-placeholder="api.correctionModelApiKeyPlaceholder"
                                                placeholder="è¯·è¾“å…¥çº é”™æ¨¡å‹çš„API Key" value="" style="max-width: 600px;">
                                        </div>
                                    </div>
                                </div>

                                <!-- æƒ…æ„Ÿæ¨¡å‹é…ç½® -->
                                <div class="model-config-container">
                                    <div class="model-header" onclick="toggleModelConfig('emotion')">
                                        <span class="model-title" data-i18n="api.emotionModelConfig">ğŸ˜Š æƒ…æ„Ÿæ¨¡å‹é…ç½®</span>
                                        <span class="toggle-icon">â–¼</span>
                                    </div>
                                    <div id="emotion-model-content" class="model-content">
                                        <div class="field-row">
                                            <label for="emotionModelProvider" data-i18n="api.provider">ä¾›åº”å•†</label>
                                            <input type="text" id="emotionModelProvider"
                                                data-i18n-placeholder="api.providerPlaceholder"
                                                placeholder="å¦‚ï¼šopenaiã€azureã€custom" value="" style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="emotionModelUrl" data-i18n="api.apiUrl">API URL</label>
                                            <input type="text" id="emotionModelUrl"
                                                data-i18n-placeholder="api.apiUrlPlaceholder"
                                                placeholder="å¦‚ï¼šhttps://api.openai.com/v1" value=""
                                                style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="emotionModelId" data-i18n="api.modelId">æ¨¡å‹ID</label>
                                            <input type="text" id="emotionModelId"
                                                data-i18n-placeholder="api.modelIdPlaceholder"
                                                placeholder="å¦‚ï¼šgpt-3.5-turboã€qwen-turboã€glm-4-flash" value=""
                                                style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="emotionModelApiKey" data-i18n="api.apiKey">API Key</label>
                                            <input type="text" id="emotionModelApiKey"
                                                data-i18n-placeholder="api.emotionModelApiKeyPlaceholder"
                                                placeholder="è¯·è¾“å…¥æƒ…æ„Ÿæ¨¡å‹çš„API Key" value="" style="max-width: 600px;">
                                        </div>
                                    </div>
                                </div>

                                <!-- è§†è§‰æ¨¡å‹é…ç½® -->
                                <div class="model-config-container">
                                    <div class="model-header" onclick="toggleModelConfig('vision')">
                                        <span class="model-title" data-i18n="api.visionModelConfig">ğŸ‘ï¸ è§†è§‰æ¨¡å‹é…ç½®</span>
                                        <span class="toggle-icon">â–¼</span>
                                    </div>
                                    <div id="vision-model-content" class="model-content">
                                        <div class="field-row">
                                            <label for="visionModelProvider" data-i18n="api.provider">ä¾›åº”å•†</label>
                                            <input type="text" id="visionModelProvider"
                                                data-i18n-placeholder="api.providerPlaceholder"
                                                placeholder="å¦‚ï¼šopenaiã€azureã€custom" value="" style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="visionModelUrl" data-i18n="api.apiUrl">API URL</label>
                                            <input type="text" id="visionModelUrl"
                                                data-i18n-placeholder="api.apiUrlPlaceholder"
                                                placeholder="å¦‚ï¼šhttps://api.openai.com/v1" value=""
                                                style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="visionModelId" data-i18n="api.modelId">æ¨¡å‹ID</label>
                                            <input type="text" id="visionModelId"
                                                data-i18n-placeholder="api.modelIdPlaceholder"
                                                placeholder="å¦‚ï¼šgpt-4-vision-previewã€qwen-vl-plus" value=""
                                                style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="visionModelApiKey" data-i18n="api.apiKey">API Key</label>
                                            <input type="text" id="visionModelApiKey"
                                                data-i18n-placeholder="api.visionModelApiKeyPlaceholder"
                                                placeholder="è¯·è¾“å…¥è§†è§‰æ¨¡å‹çš„API Key" value="" style="max-width: 600px;">
                                        </div>
                                    </div>
                                </div>

                                <!-- å…¨æ¨¡æ€æ¨¡å‹é…ç½® -->
                                <div class="model-config-container">
                                    <div class="model-header" onclick="toggleModelConfig('omni')">
                                        <span class="model-title" data-i18n="api.realtimeModelConfig">ğŸŒ å®æ—¶æ¨¡å‹é…ç½®</span>
                                        <span class="toggle-icon">â–¼</span>
                                    </div>
                                    <div id="omni-model-content" class="model-content">
                                        <div class="field-row">
                                            <label for="omniModelProvider" data-i18n="api.provider">ä¾›åº”å•†</label>
                                            <input type="text" id="omniModelProvider"
                                                data-i18n-placeholder="api.providerPlaceholder"
                                                placeholder="å¦‚ï¼šaliyunã€custom" value="" style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="omniModelUrl">API URL<em
                                                    data-i18n="api.omniApiUrlNote">ï¼ˆå¿…é¡»æ˜¯WebSocketåœ°å€ï¼Œä»¥ws://æˆ–wss://å¼€å¤´ï¼‰</em></label>
                                            <input type="text" id="omniModelUrl"
                                                data-i18n-placeholder="api.omniApiUrlPlaceholder"
                                                placeholder="å¦‚ï¼šwss://dashscope.aliyuncs.com/api-ws/v1/realtime" value=""
                                                style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="omniModelId" data-i18n="api.modelId">æ¨¡å‹ID</label>
                                            <input type="text" id="omniModelId"
                                                data-i18n-placeholder="api.modelIdPlaceholder"
                                                placeholder="å¦‚ï¼šqwen-realtime-plus" value="" style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="omniModelApiKey" data-i18n="api.apiKey">API Key</label>
                                            <input type="text" id="omniModelApiKey"
                                                data-i18n-placeholder="api.omniModelApiKeyPlaceholder"
                                                placeholder="è¯·è¾“å…¥å…¨æ¨¡æ€æ¨¡å‹çš„API Key" value="" style="max-width: 600px;">
                                        </div>
                                    </div>
                                </div>

                                <!-- TTSæ¨¡å‹é…ç½® -->
                                <div class="model-config-container">
                                    <div class="model-header" onclick="toggleModelConfig('tts')">
                                        <span class="model-title" data-i18n="api.ttsModelConfig">ğŸ”Š TTSæ¨¡å‹é…ç½®</span>
                                        <span class="toggle-icon">â–¼</span>
                                    </div>
                                    <div id="tts-model-content" class="model-content">
                                        <div class="field-row">
                                            <label for="ttsModelProvider" data-i18n="api.provider">ä¾›åº”å•†</label>
                                            <input type="text" id="ttsModelProvider"
                                                data-i18n-placeholder="api.providerPlaceholder"
                                                placeholder="å¦‚ï¼šaliyunã€azureã€custom" value="" style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="ttsModelUrl" data-i18n="api.apiUrl">API URL</label>
                                            <input type="text" id="ttsModelUrl"
                                                data-i18n-placeholder="api.apiUrlPlaceholder"
                                                placeholder="å¦‚ï¼šhttps://dashscope.aliyuncs.com/api/v1/services/aigc/tts/chat"
                                                value="" style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="ttsModelId" data-i18n="api.modelId">æ¨¡å‹ID</label>
                                            <input type="text" id="ttsModelId"
                                                data-i18n-placeholder="api.modelIdPlaceholder"
                                                placeholder="å¦‚ï¼štts-1ã€speech-01-turbo" value=""
                                                style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="ttsModelApiKey" data-i18n="api.apiKey">API Key</label>
                                            <input type="text" id="ttsModelApiKey"
                                                data-i18n-placeholder="api.ttsModelApiKeyPlaceholder"
                                                placeholder="è¯·è¾“å…¥TTSæ¨¡å‹çš„API Key" value="" style="max-width: 600px;">
                                        </div>
                                        <div class="field-row">
                                            <label for="ttsVoiceId">
                                                <span data-i18n="api.ttsVoiceId">Voice ID</span>
                                                <em data-i18n="api.ttsVoiceIdHint">ï¼ˆå¯é€‰ï¼Œè§’è‰²æœªè®¾ç½®æ—¶çš„å›é€€éŸ³è‰²ï¼‰</em>
                                            </label>
                                            <input type="text" id="ttsVoiceId"
                                                data-i18n-placeholder="api.ttsVoiceIdPlaceholder"
                                                placeholder="å¦‚ï¼šä¸­æ–‡å¥³ã€alloy" value="" style="max-width: 600px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¼¹å‡ºå¼è­¦å‘Š -->
            <div id="warning-modal" class="modal-overlay" onclick="closeWarningModal()">
                <div class="modal-warning" onclick="event.stopPropagation()">
                    <h3 data-i18n="api.apiKeyChangeWarning.title">âš ï¸ é‡è¦æé†’</h3>
                    <p data-i18n="api.apiKeyChangeWarning.message">æ£€æµ‹åˆ°æ‚¨æ­£åœ¨æ›´æ¢ API Keyï¼Œè¯·æ³¨æ„ä»¥ä¸‹äº‹é¡¹ï¼š</p>
                    <ul>
                        <li data-i18n="api.apiKeyChangeWarning.voiceIdBinding">Voice ID ä¸æ‚¨çš„ API Key ç»‘å®šï¼Œæ›´æ¢ API Key
                            åæ‰€æœ‰å·²æ³¨å†Œçš„ Voice ID å°†å¤±æ•ˆ</li>
                        <li data-i18n="api.apiKeyChangeWarning.reRegisterVoice">å»ºè®®åœ¨æ›´æ¢ API Key åé‡æ–°æ³¨å†Œæ‰€éœ€çš„éŸ³è‰²</li>
                    </ul>
                    <div class="modal-buttons">
                        <button type="button" class="btn secondary" onclick="closeWarningModal()"
                            data-i18n="api.apiKeyChangeWarning.cancel">å–æ¶ˆ</button>
                        <button type="button" class="btn" onclick="confirmApiKeyChange()"
                            data-i18n="api.apiKeyChangeWarning.continue">ç»§ç»­ä¿å­˜</button>
                    </div>
                </div>
            </div>

            <script>

                function showStatus(message, type = 'info') {
                    const statusDiv = document.getElementById('status');
                    statusDiv.textContent = message;
                    statusDiv.className = `status ${type}`;
                    statusDiv.style.display = 'block';

                    if (type === 'success') {
                        setTimeout(() => {
                            statusDiv.style.display = 'none';
                        }, 3000);
                    }
                }

                function showCurrentApiKey(message) {
                    const currentApiKeyDiv = document.getElementById('current-api-key');
                    currentApiKeyDiv.textContent = message;
                    currentApiKeyDiv.style.display = 'block';
                }

                async function clearVoiceIds() {
                    try {
                        const response = await fetch('/api/characters/clear_voice_ids', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        const data = await response.json();

                        if (data.success) {
                            console.log(`API Keyå·²æ›´æ”¹ï¼Œå·²è‡ªåŠ¨æ¸…é™¤ ${data.cleared_count} ä¸ªè§’è‰²çš„Voice IDè®°å½•`);
                        } else {
                            console.error('è‡ªåŠ¨æ¸…é™¤Voice IDè®°å½•å¤±è´¥:', data.error);
                        }
                    } catch (error) {
                        console.error('è‡ªåŠ¨æ¸…é™¤Voice IDè®°å½•æ—¶å‡ºé”™:', error);
                    }
                }

                // åŠ è½½APIæœåŠ¡å•†é€‰é¡¹
                async function loadApiProviders() {
                    try {
                        const response = await fetch('/api/config/api_providers');
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                // å¡«å……æ ¸å¿ƒAPIä¸‹æ‹‰æ¡†
                                const coreSelect = document.getElementById('coreApiSelect');
                                if (coreSelect) {
                                    coreSelect.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹
                                    data.core_api_providers.forEach(provider => {
                                        const option = document.createElement('option');
                                        option.value = provider.key;
                                        // ä½¿ç”¨ç¿»è¯‘é”®è·å–æ˜¾ç¤ºåç§°
                                        const translationKey = `api.coreProviderNames.${provider.key}`;
                                        if (window.t) {
                                            const translatedName = window.t(translationKey);
                                            // å¦‚æœç¿»è¯‘é”®å­˜åœ¨ä¸”ä¸æ˜¯é”®æœ¬èº«ï¼Œä½¿ç”¨ç¿»è¯‘ï¼›å¦åˆ™ä½¿ç”¨åŸå§‹åç§°
                                            console.log(translatedName);
                                            option.textContent = (translatedName !== translationKey) ? translatedName : provider.name;
                                        } else {
                                            option.textContent = provider.name;
                                        }
                                        coreSelect.appendChild(option);
                                    });
                                }

                                // å¡«å……è¾…åŠ©APIä¸‹æ‹‰æ¡†
                                const assistSelect = document.getElementById('assistApiSelect');
                                if (assistSelect) {
                                    assistSelect.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹
                                    data.assist_api_providers.forEach(provider => {
                                        const option = document.createElement('option');
                                        option.value = provider.key;
                                        // ä½¿ç”¨ç¿»è¯‘é”®è·å–æ˜¾ç¤ºåç§°
                                        const translationKey = `api.assistProviderNames.${provider.key}`;
                                        if (window.t) {
                                            const translatedName = window.t(translationKey);
                                            // å¦‚æœç¿»è¯‘é”®å­˜åœ¨ä¸”ä¸æ˜¯é”®æœ¬èº«ï¼Œä½¿ç”¨ç¿»è¯‘ï¼›å¦åˆ™ä½¿ç”¨åŸå§‹åç§°
                                            option.textContent = (translatedName !== translationKey) ? translatedName : provider.name;
                                        } else {
                                            option.textContent = provider.name;
                                        }
                                        assistSelect.appendChild(option);
                                    });
                                }

                                console.log('APIæœåŠ¡å•†é€‰é¡¹åŠ è½½æˆåŠŸ');
                                return true;
                            } else {
                                console.error('åŠ è½½APIæœåŠ¡å•†é…ç½®å¤±è´¥:', data.error);
                                // åŠ è½½å¤±è´¥æ—¶ï¼Œç¡®ä¿ä¸‹æ‹‰æ¡†ä¸ºç©º
                                const coreSelect = document.getElementById('coreApiSelect');
                                const assistSelect = document.getElementById('assistApiSelect');
                                if (coreSelect) {
                                    coreSelect.innerHTML = '';
                                    coreSelect.value = '';
                                }
                                if (assistSelect) {
                                    assistSelect.innerHTML = '';
                                    assistSelect.value = '';
                                }
                                return false;
                            }
                        } else {
                            console.error('è·å–APIæœåŠ¡å•†é…ç½®å¤±è´¥ï¼ŒHTTPçŠ¶æ€:', response.status);
                            // åŠ è½½å¤±è´¥æ—¶ï¼Œç¡®ä¿ä¸‹æ‹‰æ¡†ä¸ºç©º
                            const coreSelect = document.getElementById('coreApiSelect');
                            const assistSelect = document.getElementById('assistApiSelect');
                            if (coreSelect) {
                                coreSelect.innerHTML = '';
                                coreSelect.value = '';
                            }
                            if (assistSelect) {
                                assistSelect.innerHTML = '';
                                assistSelect.value = '';
                            }
                            return false;
                        }
                    } catch (error) {
                        console.error('åŠ è½½APIæœåŠ¡å•†é…ç½®æ—¶å‡ºé”™:', error);
                        // åŠ è½½å¤±è´¥æ—¶ï¼Œç¡®ä¿ä¸‹æ‹‰æ¡†ä¸ºç©º
                        const coreSelect = document.getElementById('coreApiSelect');
                        const assistSelect = document.getElementById('assistApiSelect');
                        if (coreSelect) {
                            coreSelect.innerHTML = '';
                            coreSelect.value = '';
                        }
                        if (assistSelect) {
                            assistSelect.innerHTML = '';
                            assistSelect.value = '';
                        }
                        return false;
                    }
                }

                async function loadCurrentApiKey() {
                    // å…ˆæ¸…ç©ºè¾“å…¥æ¡†å’Œä¸‹æ‹‰æ¡†ï¼Œé¿å…æ˜¾ç¤ºé”™è¯¯çš„é»˜è®¤å€¼
                    const apiKeyInput = document.getElementById('apiKeyInput');
                    const coreApiSelect = document.getElementById('coreApiSelect');
                    const assistApiSelect = document.getElementById('assistApiSelect');

                    if (apiKeyInput) {
                        apiKeyInput.value = '';
                    }
                    if (coreApiSelect) {
                        coreApiSelect.value = '';
                    }
                    if (assistApiSelect) {
                        assistApiSelect.value = '';
                    }

                    try {
                        const response = await fetch('/api/config/core_api');
                        if (response.ok) {
                            const data = await response.json();
                            // è®¾ç½®API Keyæ˜¾ç¤º
                            if (data.enableCustomApi) {
                                showCurrentApiKey(window.t ? window.t('api.currentUsingCustomApi') : 'ğŸ”§ å½“å‰ä½¿ç”¨ï¼šè‡ªå®šä¹‰APIæ¨¡å¼');
                            } else if (data.api_key) {
                                if (data.api_key === 'free-access' || data.coreApi === 'free' || data.assistApi === 'free') {
                                    showCurrentApiKey(window.t ? window.t('api.currentUsingFreeVersion') : 'ğŸ“‹ å½“å‰ä½¿ç”¨ï¼šå…è´¹ç‰ˆï¼ˆæ— éœ€API Keyï¼‰');
                                } else {
                                    showCurrentApiKey(window.t ? window.t('api.currentApiKey', { key: data.api_key }) : `ğŸ“‹ å½“å‰API Key: ${data.api_key}`);
                                }
                            } else {
                                showCurrentApiKey(window.t ? window.t('api.currentNoApiKey') : 'ğŸ“‹ å½“å‰æš‚æœªè®¾ç½®API Key');
                            }

                            // è®¾ç½®æ ¸å¿ƒAPI Keyè¾“å…¥æ¡†çš„å€¼ï¼ˆé‡è¦ï¼šå¿…é¡»åœ¨æ˜¾ç¤ºæç¤ºåè®¾ç½®ï¼‰
                            if (apiKeyInput && data.api_key) {
                                if (data.api_key === 'free-access' || data.coreApi === 'free' || data.assistApi === 'free') {
                                    // å…è´¹ç‰ˆæœ¬ï¼šæ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„æ–‡æœ¬
                                    apiKeyInput.value = window.t ? window.t('api.freeVersionNoApiKey') : 'å…è´¹ç‰ˆæ— éœ€API Key';
                                } else {
                                    apiKeyInput.value = data.api_key;
                                }
                            }
                            // è®¾ç½®é«˜çº§è®¾å®šçš„å€¼ï¼ˆç¡®ä¿ä¸‹æ‹‰æ¡†å·²åŠ è½½é€‰é¡¹ï¼‰
                            if (data.coreApi && coreApiSelect) {
                                // æ£€æŸ¥é€‰é¡¹æ˜¯å¦å·²åŠ è½½
                                if (coreApiSelect.options.length > 0) {
                                    // éªŒè¯é€‰é¡¹å€¼æ˜¯å¦å­˜åœ¨
                                    const optionExists = Array.from(coreApiSelect.options).some(opt => opt.value === data.coreApi);
                                    if (optionExists) {
                                        coreApiSelect.value = data.coreApi;
                                    }
                                } else {
                                    // å¦‚æœé€‰é¡¹æœªåŠ è½½ï¼Œç­‰å¾…ä¸€ä¸‹å†è®¾ç½®
                                    setTimeout(() => {
                                        if (coreApiSelect.options.length > 0) {
                                            const optionExists = Array.from(coreApiSelect.options).some(opt => opt.value === data.coreApi);
                                            if (optionExists) {
                                                coreApiSelect.value = data.coreApi;
                                            }
                                        }
                                    }, 100);
                                }
                            }
                            if (data.assistApi && assistApiSelect) {
                                // æ£€æŸ¥é€‰é¡¹æ˜¯å¦å·²åŠ è½½
                                if (assistApiSelect.options.length > 0) {
                                    // éªŒè¯é€‰é¡¹å€¼æ˜¯å¦å­˜åœ¨
                                    const optionExists = Array.from(assistApiSelect.options).some(opt => opt.value === data.assistApi);
                                    if (optionExists) {
                                        assistApiSelect.value = data.assistApi;
                                    }
                                } else {
                                    // å¦‚æœé€‰é¡¹æœªåŠ è½½ï¼Œç­‰å¾…ä¸€ä¸‹å†è®¾ç½®
                                    setTimeout(() => {
                                        if (assistApiSelect.options.length > 0) {
                                            const optionExists = Array.from(assistApiSelect.options).some(opt => opt.value === data.assistApi);
                                            if (optionExists) {
                                                assistApiSelect.value = data.assistApi;
                                            }
                                        }
                                    }, 100);
                                }
                            }
                            if (typeof data.assistApiKeyQwen === 'string' && document.getElementById('assistApiKeyInputQwen')) {
                                document.getElementById('assistApiKeyInputQwen').value = data.assistApiKeyQwen;
                                document.getElementById('assistApiKeyInputQwen').placeholder = data.assistApiKeyQwen || (window.t ? window.t('api.assistApiKeyPlaceholder') : 'å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key');
                            }
                            if (typeof data.assistApiKeyOpenai === 'string' && document.getElementById('assistApiKeyInputOpenai')) {
                                document.getElementById('assistApiKeyInputOpenai').value = data.assistApiKeyOpenai;
                                document.getElementById('assistApiKeyInputOpenai').placeholder = data.assistApiKeyOpenai || (window.t ? window.t('api.assistApiKeyPlaceholder') : 'å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key');
                            }
                            if (typeof data.assistApiKeyGlm === 'string' && document.getElementById('assistApiKeyInputGlm')) {
                                document.getElementById('assistApiKeyInputGlm').value = data.assistApiKeyGlm;
                                document.getElementById('assistApiKeyInputGlm').placeholder = data.assistApiKeyGlm || (window.t ? window.t('api.assistApiKeyPlaceholder') : 'å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key');
                            }
                            if (typeof data.assistApiKeyStep === 'string' && document.getElementById('assistApiKeyInputStep')) {
                                document.getElementById('assistApiKeyInputStep').value = data.assistApiKeyStep;
                                document.getElementById('assistApiKeyInputStep').placeholder = data.assistApiKeyStep || (window.t ? window.t('api.assistApiKeyPlaceholder') : 'å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key');
                            }
                            if (typeof data.assistApiKeySilicon === 'string' && document.getElementById('assistApiKeyInputSilicon')) {
                                document.getElementById('assistApiKeyInputSilicon').value = data.assistApiKeySilicon;
                                document.getElementById('assistApiKeyInputSilicon').placeholder = data.assistApiKeySilicon || (window.t ? window.t('api.assistApiKeyPlaceholder') : 'å¯é€‰ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒAPI Key');
                            }

                            // åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰APIé…ç½®
                            if (typeof data.summaryModelProvider === 'string' && document.getElementById('summaryModelProvider')) {
                                document.getElementById('summaryModelProvider').value = data.summaryModelProvider;
                            }
                            if (typeof data.summaryModelUrl === 'string' && document.getElementById('summaryModelUrl')) {
                                document.getElementById('summaryModelUrl').value = data.summaryModelUrl;
                            }
                            if (typeof data.summaryModelId === 'string' && document.getElementById('summaryModelId')) {
                                document.getElementById('summaryModelId').value = data.summaryModelId;
                            }
                            if (typeof data.summaryModelApiKey === 'string' && document.getElementById('summaryModelApiKey')) {
                                document.getElementById('summaryModelApiKey').value = data.summaryModelApiKey;
                            }

                            if (typeof data.correctionModelProvider === 'string' && document.getElementById('correctionModelProvider')) {
                                document.getElementById('correctionModelProvider').value = data.correctionModelProvider;
                            }
                            if (typeof data.correctionModelUrl === 'string' && document.getElementById('correctionModelUrl')) {
                                document.getElementById('correctionModelUrl').value = data.correctionModelUrl;
                            }
                            if (typeof data.correctionModelId === 'string' && document.getElementById('correctionModelId')) {
                                document.getElementById('correctionModelId').value = data.correctionModelId;
                            }
                            if (typeof data.correctionModelApiKey === 'string' && document.getElementById('correctionModelApiKey')) {
                                document.getElementById('correctionModelApiKey').value = data.correctionModelApiKey;
                            }

                            if (typeof data.emotionModelProvider === 'string' && document.getElementById('emotionModelProvider')) {
                                document.getElementById('emotionModelProvider').value = data.emotionModelProvider;
                            }
                            if (typeof data.emotionModelUrl === 'string' && document.getElementById('emotionModelUrl')) {
                                document.getElementById('emotionModelUrl').value = data.emotionModelUrl;
                            }
                            if (typeof data.emotionModelId === 'string' && document.getElementById('emotionModelId')) {
                                document.getElementById('emotionModelId').value = data.emotionModelId;
                            }
                            if (typeof data.emotionModelApiKey === 'string' && document.getElementById('emotionModelApiKey')) {
                                document.getElementById('emotionModelApiKey').value = data.emotionModelApiKey;
                            }

                            if (typeof data.visionModelProvider === 'string' && document.getElementById('visionModelProvider')) {
                                document.getElementById('visionModelProvider').value = data.visionModelProvider;
                            }
                            if (typeof data.visionModelUrl === 'string' && document.getElementById('visionModelUrl')) {
                                document.getElementById('visionModelUrl').value = data.visionModelUrl;
                            }
                            if (typeof data.visionModelId === 'string' && document.getElementById('visionModelId')) {
                                document.getElementById('visionModelId').value = data.visionModelId;
                            }
                            if (typeof data.visionModelApiKey === 'string' && document.getElementById('visionModelApiKey')) {
                                document.getElementById('visionModelApiKey').value = data.visionModelApiKey;
                            }

                            if (typeof data.omniModelProvider === 'string' && document.getElementById('omniModelProvider')) {
                                document.getElementById('omniModelProvider').value = data.omniModelProvider;
                            }
                            if (typeof data.omniModelUrl === 'string' && document.getElementById('omniModelUrl')) {
                                document.getElementById('omniModelUrl').value = data.omniModelUrl;
                            }
                            if (typeof data.omniModelId === 'string' && document.getElementById('omniModelId')) {
                                document.getElementById('omniModelId').value = data.omniModelId;
                            }
                            if (typeof data.omniModelApiKey === 'string' && document.getElementById('omniModelApiKey')) {
                                document.getElementById('omniModelApiKey').value = data.omniModelApiKey;
                            }

                            if (typeof data.ttsModelProvider === 'string' && document.getElementById('ttsModelProvider')) {
                                document.getElementById('ttsModelProvider').value = data.ttsModelProvider;
                            }
                            if (typeof data.ttsModelUrl === 'string' && document.getElementById('ttsModelUrl')) {
                                document.getElementById('ttsModelUrl').value = data.ttsModelUrl;
                            }
                            if (typeof data.ttsModelId === 'string' && document.getElementById('ttsModelId')) {
                                document.getElementById('ttsModelId').value = data.ttsModelId;
                            }
                            if (typeof data.ttsModelApiKey === 'string' && document.getElementById('ttsModelApiKey')) {
                                document.getElementById('ttsModelApiKey').value = data.ttsModelApiKey;
                            }
                            if (typeof data.ttsVoiceId === 'string' && document.getElementById('ttsVoiceId')) {
                                document.getElementById('ttsVoiceId').value = data.ttsVoiceId;
                            }

                            // åŠ è½½MCPR_TOKEN
                            if (typeof data.mcpToken === 'string' && document.getElementById('mcpTokenInput')) {
                                document.getElementById('mcpTokenInput').value = data.mcpToken;
                            }

                            // åŠ è½½è‡ªå®šä¹‰APIå¯ç”¨çŠ¶æ€
                            if (typeof data.enableCustomApi === 'boolean' && document.getElementById('enableCustomApi')) {
                                document.getElementById('enableCustomApi').checked = data.enableCustomApi;
                                // å»¶è¿Ÿåº”ç”¨çŠ¶æ€ï¼Œç¡®ä¿API Keyå·²æ­£ç¡®åŠ è½½
                                setTimeout(() => {
                                    toggleCustomApi();
                                }, 100);
                            }
                        } else {
                            showCurrentApiKey('ğŸ“‹ è·å–å½“å‰API Keyå¤±è´¥');
                        }
                    } catch (error) {
                        showCurrentApiKey('ğŸ“‹ è·å–å½“å‰API Keyæ—¶å‡ºé”™');
                    }

                    // è¿”å›Promiseï¼Œä»¥ä¾¿è°ƒç”¨è€…å¯ä»¥åœ¨è·å–å®Œæˆåæ‰§è¡Œå…¶ä»–æ“ä½œ
                    return Promise.resolve();
                }

                // å…¨å±€å˜é‡å­˜å‚¨å¾…ä¿å­˜çš„API Key
                let pendingApiKey = null;

                // åˆ‡æ¢è‡ªå®šä¹‰APIå¯ç”¨çŠ¶æ€
                function toggleCustomApi() {
                    const enableCustomApi = document.getElementById('enableCustomApi');
                    const coreApiSelect = document.getElementById('coreApiSelect');
                    const assistApiSelect = document.getElementById('assistApiSelect');
                    const apiKeyInput = document.getElementById('apiKeyInput');

                    const isCustomEnabled = enableCustomApi.checked;
                    const isFreeVersion = coreApiSelect && coreApiSelect.value === 'free';

                    // ç¦ç”¨æˆ–å¯ç”¨ç›¸å…³æ§ä»¶
                    // è‡ªå®šä¹‰APIæ¨¡å¼ï¼šä¸å½±å“å…¶ä»–æ§ä»¶
                    // å…è´¹ç‰ˆæœ¬ï¼šåªç¦ç”¨API Keyè¾“å…¥æ¡†å’Œè¾…åŠ©APIé€‰æ‹©æ¡†ï¼Œæ ¸å¿ƒAPIé€‰æ‹©æ¡†ä¿æŒå¯ç”¨
                    if (isFreeVersion) {
                        // å…è´¹ç‰ˆæœ¬ï¼šåªç¦ç”¨API Keyè¾“å…¥æ¡†å’Œè¾…åŠ©APIé€‰æ‹©æ¡†
                        if (assistApiSelect) assistApiSelect.disabled = true;
                        if (apiKeyInput) {
                            apiKeyInput.disabled = true;
                            apiKeyInput.required = false;
                        }

                        // æ ¸å¿ƒAPIé€‰æ‹©æ¡†ä¿æŒå¯ç”¨ï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥åˆ‡æ¢å›ä»˜è´¹ç‰ˆæœ¬
                        if (coreApiSelect) coreApiSelect.disabled = false;

                        // è¾…åŠ©API Keyè¾“å…¥æ¡†ä¿æŒå¯ç”¨ï¼Œå…è®¸ä¿å­˜é¢å¤–Key
                        setAssistApiInputsDisabled(false);
                    } else if (isCustomEnabled) {
                        // è‡ªå®šä¹‰APIæ¨¡å¼ï¼šå¯ç”¨æ‰€æœ‰æ§ä»¶ï¼Œä½†å–æ¶ˆAPI Keyçš„å¿…å¡«é™åˆ¶
                        if (coreApiSelect) coreApiSelect.disabled = false;
                        if (assistApiSelect) assistApiSelect.disabled = false;
                        if (apiKeyInput) {
                            apiKeyInput.disabled = false;
                            apiKeyInput.required = false;
                        }

                        // å¯ç”¨æ‰€æœ‰è¾…åŠ©API Keyè¾“å…¥æ¡†ï¼ˆç»Ÿä¸€å¤„ç†ï¼‰
                        setAssistApiInputsDisabled(false);
                    } else {
                        // ä»˜è´¹ç‰ˆæœ¬ä¸”æœªå¯ç”¨è‡ªå®šä¹‰APIï¼šå¯ç”¨æ‰€æœ‰æ§ä»¶ï¼ŒAPI Keyä¸ºå¿…å¡«
                        if (coreApiSelect) coreApiSelect.disabled = false;
                        if (assistApiSelect) assistApiSelect.disabled = false;
                        if (apiKeyInput) {
                            apiKeyInput.disabled = false;
                            apiKeyInput.required = true;
                        }

                        // å¯ç”¨æ‰€æœ‰è¾…åŠ©API Keyè¾“å…¥æ¡†ï¼ˆç»Ÿä¸€å¤„ç†ï¼‰
                        setAssistApiInputsDisabled(false);
                    }

                    // æ§åˆ¶è‡ªå®šä¹‰APIå®¹å™¨çš„æŠ˜å çŠ¶æ€
                    const customApiContainer = document.getElementById('custom-api-container');
                    if (customApiContainer) {
                        if (isCustomEnabled) {
                            customApiContainer.style.display = 'block';
                            // å±•å¼€æ‰€æœ‰æ¨¡å‹é…ç½®
                            const modelContainers = document.querySelectorAll('.model-config-container');
                            modelContainers.forEach(container => {
                                container.style.display = 'block';
                            });
                        } else {
                            customApiContainer.style.display = 'none';
                            // æŠ˜å æ‰€æœ‰æ¨¡å‹é…ç½®
                            const modelContainers = document.querySelectorAll('.model-config-container');
                            modelContainers.forEach(container => {
                                container.style.display = 'none';
                            });
                        }
                    }

                    // æ›´æ–°æç¤ºä¿¡æ¯
                    const freeVersionHint = document.getElementById('freeVersionHint');
                    if (freeVersionHint) {
                        if (isCustomEnabled) {
                            // è‡ªå®šä¹‰ API å·²å¯ç”¨ï¼Œæ˜¾ç¤ºå¯¹åº”æç¤ºï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
                            freeVersionHint.textContent = window.t ? window.t('api.customApiEnabledHint') : 'ï¼ˆè‡ªå®šä¹‰APIå·²å¯ç”¨ï¼‰';
                            freeVersionHint.style.color = '#ff6b35';
                            freeVersionHint.style.display = 'inline';
                        } else if (isFreeVersion) {
                            // ä»…å½“æ ¸å¿ƒ API çœŸæ­£ä¸ºå…è´¹ç‰ˆæ—¶æ˜¾ç¤ºå…è´¹æç¤º
                            freeVersionHint.textContent = window.t ? window.t('api.freeVersionHint') : 'ï¼ˆå…è´¹ç‰ˆæ— éœ€å¡«å†™ï¼‰';
                            freeVersionHint.style.color = '#28a745';
                            freeVersionHint.style.display = 'inline';
                        } else {
                            // å…¶ä»–æƒ…å†µéšè—æç¤ºï¼Œé¿å…è¯¯å¯¼ç”¨æˆ·
                            freeVersionHint.style.display = 'none';
                        }
                    }

                    // æ›´æ–°é«˜çº§é€‰é¡¹çš„æç¤º
                    const advancedTips = document.querySelector('#advanced-options > div:first-child');
                    if (advancedTips) {
                        if (isCustomEnabled) {
                            advancedTips.innerHTML = `<strong>${window.t ? window.t('api.customApiEnabled') : 'ğŸ’¡ é…ç½®çŠ¶æ€ï¼š'}</strong><br>â€¢ <strong>${window.t ? window.t('api.customApiEnabledDesc') : 'è‡ªå®šä¹‰APIå·²å¯ç”¨'}</strong><br>â€¢ ${window.t ? window.t('api.customApiEnabledNote') : 'è¯·åœ¨ä¸‹æ–¹çš„è‡ªå®šä¹‰APIé…ç½®ä¸­è®¾ç½®å„åŠŸèƒ½æ¨¡å—çš„API'}`;
                            advancedTips.style.background = '#fff3cd';
                            advancedTips.style.borderColor = '#ffeaa7';
                            advancedTips.style.color = '#856404';
                        } else {
                            advancedTips.innerHTML = `<strong>${window.t ? window.t('api.configSuggestionFull') : 'ğŸ’¡ é…ç½®å»ºè®®ï¼š'}</strong><br>â€¢ <strong>${window.t ? window.t('api.freeVersion') : 'å…è´¹ç‰ˆ'}</strong>ï¼š${window.t ? window.t('api.freeVersionSuggestionFull') : 'å®Œå…¨å…è´¹ï¼Œæ— éœ€API Keyï¼Œé€‚åˆæ–°æ‰‹ä½“éªŒï¼ˆä¸æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³ã€Agentæ¨¡å¼å’Œè§†é¢‘å¯¹è¯ï¼‰'}<br>â€¢ <strong>${window.t ? window.t('api.coreApiProvider') : 'æ ¸å¿ƒAPI'}</strong>ï¼š${window.t ? window.t('api.coreApiSuggestionFull') : 'è´Ÿè´£å¯¹è¯åŠŸèƒ½ï¼Œå»ºè®®æ ¹æ®é¢„ç®—å’Œéœ€æ±‚é€‰æ‹©'}<br>â€¢ <strong>${window.t ? window.t('api.assistApiProvider') : 'è¾…åŠ©API'}</strong>ï¼š${window.t ? window.t('api.assistApiSuggestionFull') : 'è´Ÿè´£è®°å¿†ç®¡ç†å’Œè‡ªå®šä¹‰è¯­éŸ³ï¼Œåªæœ‰é˜¿é‡Œæ”¯æŒè‡ªå®šä¹‰è¯­éŸ³'}`;
                            advancedTips.style.background = '#e7f3ff';
                            advancedTips.style.borderColor = '#b3d9ff';
                            advancedTips.style.color = '#0d6efd';
                        }
                    }
                }

                // è‡ªå®šä¹‰APIæŠ˜å åˆ‡æ¢å‡½æ•°
                function toggleCustomApiSection() {
                    const customApiOptions = document.getElementById('custom-api-options');
                    const arrow = document.getElementById('custom-api-arrow');
                    if (customApiOptions.style.display === 'none') {
                        customApiOptions.style.display = 'block';
                        arrow.style.transform = 'rotate(90deg)';
                    } else {
                        customApiOptions.style.display = 'none';
                        arrow.style.transform = 'rotate(0deg)';
                    }
                }

                // ä¸ºè‡ªå®šä¹‰APIå¼€å…³æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                document.addEventListener('DOMContentLoaded', function () {
                    const enableCustomApi = document.getElementById('enableCustomApi');
                    if (enableCustomApi) {
                        enableCustomApi.addEventListener('change', toggleCustomApi);
                    }
                });

                document.getElementById('api-key-form').addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const apiKeyInput = document.getElementById('apiKeyInput');

                    // è·å–é«˜çº§è®¾å®šçš„å€¼
                    // å³ä½¿é€‰æ‹©å™¨è¢«ç¦ç”¨ï¼Œä¹Ÿè¦ç¡®ä¿èƒ½æ­£ç¡®è·å–å½“å‰é€‰æ‹©çš„å€¼
                    const coreApiSelect = document.getElementById('coreApiSelect');
                    const assistApiSelect = document.getElementById('assistApiSelect');

                    // è·å–è‡ªå®šä¹‰APIå¯ç”¨çŠ¶æ€ï¼ˆç”¨äºæ¨æ–­é€»è¾‘ï¼Œä¼˜å…ˆåˆ¤æ–­éè‡ªå®šä¹‰æ¨¡å¼ï¼‰
                    const enableCustomApi = document.getElementById('enableCustomApi') ? document.getElementById('enableCustomApi').checked : false;

                    // ä¼˜å…ˆä»é€‰æ‹©å™¨è·å–å€¼ï¼Œå¦‚æœé€‰æ‹©å™¨è¢«ç¦ç”¨æˆ–å€¼ä¸ºç©ºï¼Œåˆ™ä»å½“å‰æ˜¾ç¤ºçŠ¶æ€æ¨æ–­
                    let coreApi = coreApiSelect ? coreApiSelect.value : '';
                    let assistApi = assistApiSelect ? assistApiSelect.value : '';

                    // å¦‚æœæ ¸å¿ƒAPIé€‰æ‹©å™¨è¢«ç¦ç”¨ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯å› ä¸ºå…è´¹ç‰ˆæœ¬
                    if (coreApiSelect && coreApiSelect.disabled && coreApi === '') {
                        // ä»…åœ¨éè‡ªå®šä¹‰APIæ¨¡å¼ä¸‹ï¼Œæ ¹æ® select çš„å®é™…å€¼åˆ¤æ–­æ˜¯å¦ä¸ºå…è´¹ç‰ˆ
                        if (!enableCustomApi && coreApiSelect.value === 'free') {
                            coreApi = 'free';
                        }
                    }

                    // å¦‚æœè¾…åŠ©APIé€‰æ‹©å™¨è¢«ç¦ç”¨ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯å› ä¸ºå…è´¹ç‰ˆæœ¬
                    if (assistApiSelect && assistApiSelect.disabled && assistApi === '') {
                        // ä»…åœ¨éè‡ªå®šä¹‰APIæ¨¡å¼ä¸‹ï¼Œå¦‚æœæ ¸å¿ƒ API å·²ç¡®å®šä¸º freeï¼Œåˆ™è¾…åŠ© API ä¹Ÿå¼ºåˆ¶ä¸º 'free'
                        if (!enableCustomApi && coreApi === 'free') {
                            assistApi = 'free';
                        }
                    }

                    // å¤„ç†API Keyï¼šè¯»å–ç”¨æˆ·è¾“å…¥ï¼ˆæš‚ä¸åœ¨è¿™é‡Œè½¬æ¢å…è´¹ç‰ˆå±•ç¤ºæ–‡æœ¬ï¼Œç»Ÿä¸€åœ¨ä¿å­˜å±‚å¤„ç†ï¼‰
                    let apiKey = apiKeyInput.value ? apiKeyInput.value.trim() : '';
                    const assistApiKeyQwen = document.getElementById('assistApiKeyInputQwen') ? document.getElementById('assistApiKeyInputQwen').value.trim() : '';
                    const assistApiKeyOpenai = document.getElementById('assistApiKeyInputOpenai') ? document.getElementById('assistApiKeyInputOpenai').value.trim() : '';
                    const assistApiKeyGlm = document.getElementById('assistApiKeyInputGlm') ? document.getElementById('assistApiKeyInputGlm').value.trim() : '';
                    const assistApiKeyStep = document.getElementById('assistApiKeyInputStep') ? document.getElementById('assistApiKeyInputStep').value.trim() : '';
                    const assistApiKeySilicon = document.getElementById('assistApiKeyInputSilicon') ? document.getElementById('assistApiKeyInputSilicon').value.trim() : '';

                    // è·å–ç”¨æˆ·è‡ªå®šä¹‰APIé…ç½®
                    const summaryModelProvider = document.getElementById('summaryModelProvider') ? document.getElementById('summaryModelProvider').value.trim() : '';
                    const summaryModelUrl = document.getElementById('summaryModelUrl') ? document.getElementById('summaryModelUrl').value.trim() : '';
                    const summaryModelId = document.getElementById('summaryModelId') ? document.getElementById('summaryModelId').value.trim() : '';
                    const summaryModelApiKey = document.getElementById('summaryModelApiKey') ? document.getElementById('summaryModelApiKey').value.trim() : '';

                    const correctionModelProvider = document.getElementById('correctionModelProvider') ? document.getElementById('correctionModelProvider').value.trim() : '';
                    const correctionModelUrl = document.getElementById('correctionModelUrl') ? document.getElementById('correctionModelUrl').value.trim() : '';
                    const correctionModelId = document.getElementById('correctionModelId') ? document.getElementById('correctionModelId').value.trim() : '';
                    const correctionModelApiKey = document.getElementById('correctionModelApiKey') ? document.getElementById('correctionModelApiKey').value.trim() : '';

                    const emotionModelProvider = document.getElementById('emotionModelProvider') ? document.getElementById('emotionModelProvider').value.trim() : '';
                    const emotionModelUrl = document.getElementById('emotionModelUrl') ? document.getElementById('emotionModelUrl').value.trim() : '';
                    const emotionModelId = document.getElementById('emotionModelId') ? document.getElementById('emotionModelId').value.trim() : '';
                    const emotionModelApiKey = document.getElementById('emotionModelApiKey') ? document.getElementById('emotionModelApiKey').value.trim() : '';

                    const visionModelProvider = document.getElementById('visionModelProvider') ? document.getElementById('visionModelProvider').value.trim() : '';
                    const visionModelUrl = document.getElementById('visionModelUrl') ? document.getElementById('visionModelUrl').value.trim() : '';
                    const visionModelId = document.getElementById('visionModelId') ? document.getElementById('visionModelId').value.trim() : '';
                    const visionModelApiKey = document.getElementById('visionModelApiKey') ? document.getElementById('visionModelApiKey').value.trim() : '';

                    const omniModelProvider = document.getElementById('omniModelProvider') ? document.getElementById('omniModelProvider').value.trim() : '';
                    const omniModelUrl = document.getElementById('omniModelUrl') ? document.getElementById('omniModelUrl').value.trim() : '';
                    const omniModelId = document.getElementById('omniModelId') ? document.getElementById('omniModelId').value.trim() : '';
                    const omniModelApiKey = document.getElementById('omniModelApiKey') ? document.getElementById('omniModelApiKey').value.trim() : '';

                    const ttsModelProvider = document.getElementById('ttsModelProvider') ? document.getElementById('ttsModelProvider').value.trim() : '';
                    const ttsModelUrl = document.getElementById('ttsModelUrl') ? document.getElementById('ttsModelUrl').value.trim() : '';
                    const ttsModelId = document.getElementById('ttsModelId') ? document.getElementById('ttsModelId').value.trim() : '';
                    const ttsModelApiKey = document.getElementById('ttsModelApiKey') ? document.getElementById('ttsModelApiKey').value.trim() : '';
                    const ttsVoiceId = document.getElementById('ttsVoiceId') ? document.getElementById('ttsVoiceId').value.trim() : '';

                    const mcpToken = document.getElementById('mcpTokenInput') ? document.getElementById('mcpTokenInput').value.trim() : '';

                    // å…è´¹ç‰ˆå’Œå¯ç”¨è‡ªå®šä¹‰APIæ—¶ä¸éœ€è¦API Keyæ£€æŸ¥
                    if (!enableCustomApi && coreApi !== 'free' && assistApi !== 'free' && !apiKey) {
                        showStatus(window.t ? window.t('api.pleaseEnterApiKeyError') : 'è¯·è¾“å…¥API Key', 'error');
                        return;
                    }

                    // æ£€æŸ¥æ˜¯å¦å·²æœ‰API Keyï¼Œå¦‚æœæœ‰åˆ™æ˜¾ç¤ºè­¦å‘Š
                    const currentApiKeyDiv = document.getElementById('current-api-key');
                    if (currentApiKeyDiv.style.display !== 'none') {
                        // å·²æœ‰API Keyï¼Œæ˜¾ç¤ºè­¦å‘Šå¼¹çª—
                        pendingApiKey = {
                            apiKey, coreApi, assistApi,
                            assistApiKeyQwen, assistApiKeyOpenai, assistApiKeyGlm, assistApiKeyStep, assistApiKeySilicon,
                            summaryModelProvider, summaryModelUrl, summaryModelId, summaryModelApiKey,
                            correctionModelProvider, correctionModelUrl, correctionModelId, correctionModelApiKey,
                            emotionModelProvider, emotionModelUrl, emotionModelId, emotionModelApiKey,
                            visionModelProvider, visionModelUrl, visionModelId, visionModelApiKey,
                            omniModelProvider, omniModelUrl, omniModelId, omniModelApiKey,
                            ttsModelProvider, ttsModelUrl, ttsModelId, ttsModelApiKey, ttsVoiceId,
                            mcpToken, enableCustomApi
                        };
                        showWarningModal();
                    } else {
                        // æ²¡æœ‰ç°æœ‰API Keyï¼Œç›´æ¥ä¿å­˜
                        await saveApiKey({
                            apiKey, coreApi, assistApi,
                            assistApiKeyQwen, assistApiKeyOpenai, assistApiKeyGlm, assistApiKeyStep, assistApiKeySilicon,
                            summaryModelProvider, summaryModelUrl, summaryModelId, summaryModelApiKey,
                            correctionModelProvider, correctionModelUrl, correctionModelId, correctionModelApiKey,
                            emotionModelProvider, emotionModelUrl, emotionModelId, emotionModelApiKey,
                            visionModelProvider, visionModelUrl, visionModelId, visionModelApiKey,
                            omniModelProvider, omniModelUrl, omniModelId, omniModelApiKey,
                            ttsModelProvider, ttsModelUrl, ttsModelId, ttsModelApiKey, ttsVoiceId,
                            mcpToken, enableCustomApi
                        });
                    }
                });

                async function saveApiKey({ apiKey, coreApi, assistApi, assistApiKeyQwen, assistApiKeyOpenai, assistApiKeyGlm, assistApiKeyStep, assistApiKeySilicon, summaryModelProvider, summaryModelUrl, summaryModelId, summaryModelApiKey, correctionModelProvider, correctionModelUrl, correctionModelId, correctionModelApiKey, emotionModelProvider, emotionModelUrl, emotionModelId, emotionModelApiKey, visionModelProvider, visionModelUrl, visionModelId, visionModelApiKey, omniModelProvider, omniModelUrl, omniModelId, omniModelApiKey, ttsModelProvider, ttsModelUrl, ttsModelId, ttsModelApiKey, ttsVoiceId, mcpToken, enableCustomApi }) {
                    // ç»Ÿä¸€å¤„ç†å…è´¹ç‰ˆ API Key çš„ä¿å­˜å€¼ï¼šå¦‚æœæ ¸å¿ƒæˆ–è¾…åŠ© API ä¸º freeï¼Œåˆ™ä¿å­˜å€¼åº”ä¸º 'free-access'
                    if (!enableCustomApi && (coreApi === 'free' || assistApi === 'free')) {
                        // æ— è®ºç”¨æˆ·åœ¨ UI ä¸­çœ‹åˆ°çš„æ˜¯ç¿»è¯‘æ–‡æœ¬è¿˜æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œä¿å­˜æ—¶éƒ½ä½¿ç”¨ 'free-access'
                        apiKey = 'free-access';
                    }

                    // ç¡®ä¿apiKeyæ˜¯æœ‰æ•ˆçš„å­—ç¬¦ä¸²ï¼ˆå¯ç”¨è‡ªå®šä¹‰APIæˆ–å…è´¹ç‰ˆæ—¶ä¸éœ€è¦API Keyï¼‰
                    if (!enableCustomApi && coreApi !== 'free' && assistApi !== 'free' && (!apiKey || typeof apiKey !== 'string')) {
                        showStatus('API Keyæ— æ•ˆ', 'error');
                        return;
                    }

                    try {
                        const response = await fetch('/api/config/core_api', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                coreApiKey: apiKey,
                                coreApi: coreApi || undefined,
                                assistApi: assistApi || undefined,
                                assistApiKeyQwen: assistApiKeyQwen || undefined,
                                assistApiKeyOpenai: assistApiKeyOpenai || undefined,
                                assistApiKeyGlm: assistApiKeyGlm || undefined,
                                assistApiKeyStep: assistApiKeyStep || undefined,
                                assistApiKeySilicon: assistApiKeySilicon || undefined,
                                summaryModelProvider: summaryModelProvider || undefined,
                                summaryModelUrl: summaryModelUrl || undefined,
                                summaryModelId: summaryModelId || undefined,
                                summaryModelApiKey: summaryModelApiKey || undefined,
                                correctionModelProvider: correctionModelProvider || undefined,
                                correctionModelUrl: correctionModelUrl || undefined,
                                correctionModelId: correctionModelId || undefined,
                                correctionModelApiKey: correctionModelApiKey || undefined,
                                emotionModelProvider: emotionModelProvider || undefined,
                                emotionModelUrl: emotionModelUrl || undefined,
                                emotionModelId: emotionModelId || undefined,
                                emotionModelApiKey: emotionModelApiKey || undefined,
                                visionModelProvider: visionModelProvider || undefined,
                                visionModelUrl: visionModelUrl || undefined,
                                visionModelId: visionModelId || undefined,
                                visionModelApiKey: visionModelApiKey || undefined,
                                omniModelProvider: omniModelProvider || undefined,
                                omniModelUrl: omniModelUrl || undefined,
                                omniModelId: omniModelId || undefined,
                                omniModelApiKey: omniModelApiKey || undefined,
                                ttsModelProvider: ttsModelProvider || undefined,
                                ttsModelUrl: ttsModelUrl || undefined,
                                ttsModelId: ttsModelId || undefined,
                                ttsModelApiKey: ttsModelApiKey || undefined,
                                ttsVoiceId: ttsVoiceId || undefined,
                                mcpToken: mcpToken || undefined,
                                enableCustomApi: enableCustomApi || false
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                let statusMessage = 'API Keyä¿å­˜æˆåŠŸï¼';
                                if (result.sessions_ended && result.sessions_ended > 0) {
                                    statusMessage += ` å·²é‡ç½® ${result.sessions_ended} ä¸ªæ´»è·ƒå¯¹è¯ï¼Œå¯¹è¯é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ã€‚`;
                                } else {
                                    statusMessage += ' é…ç½®å·²é‡æ–°åŠ è½½ï¼Œæ–°é…ç½®å°†åœ¨ä¸‹æ¬¡å¯¹è¯æ—¶ç”Ÿæ•ˆã€‚';
                                }
                                showStatus(statusMessage, 'success');
                                document.getElementById('apiKeyInput').value = '';

                                // æ¸…é™¤æœ¬åœ°Voice IDè®°å½•
                                await clearVoiceIds();
                                // é€šçŸ¥å…¶ä»–é¡µé¢API Keyå·²æ›´æ”¹
                                if (window.parent !== window) {
                                    window.parent.postMessage({
                                        type: 'api_key_changed',
                                        timestamp: Date.now()
                                    }, '*');
                                } else {
                                    // å¦‚æœæ˜¯ç›´æ¥æ‰“å¼€çš„é¡µé¢ï¼Œå¹¿æ’­ç»™æ‰€æœ‰å­çª—å£
                                    const iframes = document.querySelectorAll('iframe');
                                    iframes.forEach(iframe => {
                                        try {
                                            iframe.contentWindow.postMessage({
                                                type: 'api_key_changed',
                                                timestamp: Date.now()
                                            }, '*');
                                        } catch (e) {
                                            // è·¨åŸŸiframeä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¿½ç•¥
                                        }
                                    });
                                }
                            } else {
                                const errorMsg = result.error || (window.t ? window.t('common.unknownError') : 'æœªçŸ¥é”™è¯¯');
                                showStatus(window.t ? window.t('api.saveFailed', { error: errorMsg }) : 'ä¿å­˜å¤±è´¥: ' + errorMsg, 'error');
                            }
                        } else {
                            showStatus('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                        }

                        // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½é‡æ–°åŠ è½½å½“å‰API Key
                        await loadCurrentApiKey();
                    } catch (error) {
                        showStatus('ä¿å­˜æ—¶å‡ºé”™: ' + error.message, 'error');
                        // å³ä½¿å‡ºé”™ä¹Ÿå°è¯•é‡æ–°åŠ è½½å½“å‰API Key
                        await loadCurrentApiKey();
                    }
                }

                function showWarningModal() {
                    document.getElementById('warning-modal').style.display = 'flex';
                }

                function closeWarningModal() {
                    document.getElementById('warning-modal').style.display = 'none';
                    // ä¸åœ¨è¿™é‡Œæ¸…ç©º pendingApiKeyï¼Œè®©è°ƒç”¨è€…å†³å®šä½•æ—¶æ¸…ç©º
                }

                function confirmApiKeyChange() {
                    if (pendingApiKey && typeof pendingApiKey === 'object') {
                        const apiKeyToSave = pendingApiKey; // ä¿å­˜å½“å‰å€¼
                        closeWarningModal();
                        pendingApiKey = null; // æ¸…ç©ºå…¨å±€å˜é‡
                        saveApiKey(apiKeyToSave); // ä½¿ç”¨ä¿å­˜çš„å€¼
                    } else {
                        showStatus('API Keyæ— æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥', 'error');
                        closeWarningModal();
                        pendingApiKey = null; // æ¸…ç©ºå…¨å±€å˜é‡
                    }
                }

                function toggleAdvancedOptions() {
                    const adv = document.getElementById('advanced-options');
                    const arrow = document.getElementById('advanced-arrow');
                    if (adv.style.display === 'none') {
                        adv.style.display = 'block';
                        arrow.style.transform = 'rotate(90deg)';
                    } else {
                        adv.style.display = 'none';
                        arrow.style.transform = 'rotate(0deg)';
                    }
                }

                // Helper: åˆ¤æ–­ä¸€ä¸ªå€¼æ˜¯å¦è¡¨ç¤ºå…è´¹ç‰ˆï¼ˆæ”¯æŒå­˜å‚¨å€¼ 'free-access' å’Œå½“å‰è¯­è¨€çš„ç¿»è¯‘æ–‡æœ¬ï¼‰
                function isFreeVersionText(value) {
                    if (typeof value !== 'string') return false;
                    const v = value.trim();
                    if (!v) return false;
                    // å­˜å‚¨å±‚æ ‡è®°
                    if (v === 'free-access') return true;
                    // UI å±•ç¤ºçš„ç¿»è¯‘æ–‡æœ¬
                    const translated = (window.t ? window.t('api.freeVersionNoApiKey') : 'å…è´¹ç‰ˆæ— éœ€API Key');
                    if (v === translated) return true;
                    return false;
                }

                // ç»Ÿä¸€ç¦ç”¨/å¯ç”¨æ‰€æœ‰è¾…åŠ©API Keyè¾“å…¥æ¡†
                function setAssistApiInputsDisabled(disabled) {
                    const assistApiKeyInputs = [
                        'assistApiKeyInputQwen', 'assistApiKeyInputOpenai', 'assistApiKeyInputGlm',
                        'assistApiKeyInputStep', 'assistApiKeyInputSilicon'
                    ];
                    assistApiKeyInputs.forEach(id => {
                        const input = document.getElementById(id);
                        if (!input) return;
                        input.disabled = !!disabled;
                        // å¯ç”¨æ—¶æ¸…ç†è¡¨ç¤ºå…è´¹ç‰ˆçš„å ä½å€¼
                        if (!disabled && isFreeVersionText(input.value)) {
                            input.value = '';
                        }
                    });
                }

                // æ ¹æ®æ ¸å¿ƒAPIé€‰æ‹©æ›´æ–°è¾…åŠ©APIçš„æç¤ºå’Œå»ºè®®
                function updateAssistApiRecommendation() {
                    const coreApiSelect = document.getElementById('coreApiSelect');
                    const assistApiSelect = document.getElementById('assistApiSelect');

                    if (!coreApiSelect || !assistApiSelect) return;

                    const selectedCoreApi = coreApiSelect.value;
                    const selectedAssistApi = assistApiSelect.value;
                    let recommendation = '';

                    // æ§åˆ¶API Keyè¾“å…¥æ¡†å’Œå…è´¹ç‰ˆæç¤º
                    const apiKeyInput = document.getElementById('apiKeyInput');
                    const freeVersionHint = document.getElementById('freeVersionHint');

                    if (selectedCoreApi === 'free') {
                        // æ ¸å¿ƒAPIé€‰æ‹©å…è´¹ç‰ˆæ—¶ï¼Œè‡ªåŠ¨å±è”½è¾…åŠ©APIé€‰æ‹©ï¼Œå¼ºåˆ¶ä½¿ç”¨å…è´¹ç‰ˆ
                        if (apiKeyInput) {
                            apiKeyInput.disabled = true;
                            apiKeyInput.placeholder = window.t ? window.t('api.freeVersionNoApiKey') : 'å…è´¹ç‰ˆæ— éœ€API Key';
                            apiKeyInput.required = false;
                            apiKeyInput.value = window.t ? window.t('api.freeVersionNoApiKey') : 'å…è´¹ç‰ˆæ— éœ€API Key';
                        }
                        if (freeVersionHint) {
                            freeVersionHint.style.display = 'inline';
                        }

                        // ç¦ç”¨è¾…åŠ©APIé€‰æ‹©æ¡†ï¼Œå¼ºåˆ¶ä¸ºå…è´¹ç‰ˆ
                        assistApiSelect.disabled = true;
                        assistApiSelect.value = 'free';

                        // è¾…åŠ©APIè¾“å…¥æ¡†ä¿æŒå¯ç”¨ï¼Œå…è®¸ç”¨æˆ·å¡«å†™å¤‡ç”¨Key
                        setAssistApiInputsDisabled(false);

                        recommendation = window.t ? window.t('api.freeVersionConfig') : 'å…è´¹ç‰ˆé…ç½®ï¼šæ”¯æŒè¯­éŸ³å¯¹è¯ã€æ–‡æœ¬å¯¹è¯å’Œè®°å¿†ç®¡ç†ï¼Œä¸æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³ã€Agentæ¨¡å¼å’Œè§†é¢‘å¯¹è¯';
                    } else {
                        // æ ¸å¿ƒAPIä¸æ˜¯å…è´¹ç‰ˆ
                        if (apiKeyInput) {
                            apiKeyInput.disabled = false;
                            apiKeyInput.placeholder = window.t ? window.t('api.pleaseEnterApiKey') : 'è¯·è¾“å…¥æ‚¨çš„API Key';
                            apiKeyInput.required = true;
                            if (isFreeVersionText(apiKeyInput.value)) {
                                apiKeyInput.value = '';
                            }
                        }
                        if (freeVersionHint) {
                            freeVersionHint.style.display = 'none';
                        }

                        // å¯ç”¨è¾…åŠ©APIé€‰æ‹©æ¡†ï¼Œä½†ç¦ç”¨å…è´¹ç‰ˆé€‰é¡¹
                        assistApiSelect.disabled = false;
                        const freeOption = assistApiSelect.querySelector('option[value="free"]');
                        if (freeOption) {
                            freeOption.disabled = true;
                            freeOption.textContent = window.t ? window.t('api.freeVersionOnlyWhenCoreFree') : 'å…è´¹ç‰ˆï¼ˆä»…æ ¸å¿ƒAPIä¸ºå…è´¹ç‰ˆæ—¶å¯ç”¨ï¼‰';
                        }

                        // å¯ç”¨æ‰€æœ‰è¾…åŠ©APIè¾“å…¥æ¡†ï¼ˆç»Ÿä¸€å¤„ç†ï¼Œå¯ç”¨æ—¶æ¸…ç†æ˜¾ç¤ºä¸ºå…è´¹ç‰ˆçš„å ä½å€¼ï¼‰
                        setAssistApiInputsDisabled(false);

                        // å¦‚æœå½“å‰é€‰æ‹©çš„æ˜¯å…è´¹ç‰ˆï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ¨èçš„API
                        if (selectedAssistApi === 'free') {
                            assistApiSelect.value = 'qwen'; // é»˜è®¤åˆ‡æ¢åˆ°é˜¿é‡Œ
                        }

                        switch (selectedCoreApi) {
                            case 'qwen':
                                recommendation = window.t ? window.t('api.qwenRecommendation') : 'é˜¿é‡Œä½œä¸ºæ ¸å¿ƒAPIæ—¶ï¼Œå»ºè®®è¾…åŠ©APIä¹Ÿé€‰æ‹©é˜¿é‡Œä»¥è·å¾—æœ€ä½³çš„è‡ªå®šä¹‰è¯­éŸ³ä½“éªŒ';
                                break;
                            case 'glm':
                                recommendation = window.t ? window.t('api.glmRecommendation') : 'æ™ºè°±ä½œä¸ºæ ¸å¿ƒAPIæ—¶ï¼Œå»ºè®®è¾…åŠ©APIé€‰æ‹©é˜¿é‡Œä»¥æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³åŠŸèƒ½';
                                break;
                            case 'openai':
                                recommendation = window.t ? window.t('api.openaiRecommendation') : 'OpenAIä½œä¸ºæ ¸å¿ƒAPIæ—¶ï¼Œå»ºè®®è¾…åŠ©APIé€‰æ‹©é˜¿é‡Œä»¥æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³åŠŸèƒ½';
                                break;
                            case 'step':
                                recommendation = window.t ? window.t('api.stepRecommendation') : 'é˜¶è·ƒæ˜Ÿè¾°ä½œä¸ºæ ¸å¿ƒAPIæ—¶ï¼Œå»ºè®®è¾…åŠ©APIé€‰æ‹©é˜¿é‡Œä»¥æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³åŠŸèƒ½';
                                break;
                        }
                    }

                    // æ›´æ–°è¾…åŠ©APIé€‰æ‹©æ¡†çš„æç¤º
                    const assistApiTooltip = assistApiSelect.parentElement.querySelector('label .tooltip-content');
                    if (assistApiTooltip) {
                        assistApiTooltip.innerHTML = `
            <strong>${window.t ? window.t('api.assistApiTitle') : 'è¾…åŠ©APIè´Ÿè´£è®°å¿†ç®¡ç†å’Œè‡ªå®šä¹‰è¯­éŸ³ï¼š'}</strong><br>
            â€¢ <span>${window.t ? window.t('api.freeVersionAssist') : 'å…è´¹ç‰ˆï¼šå®Œå…¨å…è´¹ï¼Œæ— éœ€API Keyï¼Œä½†ä¸æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³'}</span><br>
            â€¢ <span>${window.t ? window.t('api.aliAssist') : 'é˜¿é‡Œï¼šæ¨èé€‰æ‹©ï¼Œæ”¯æŒè‡ªå®šä¹‰è¯­éŸ³'}</span><br>
            â€¢ <span>${window.t ? window.t('api.glmAssist') : 'æ™ºè°±ï¼šæ”¯æŒAgentæ¨¡å¼'}</span><br>
            â€¢ <span>${window.t ? window.t('api.stepAssist') : 'é˜¶è·ƒæ˜Ÿè¾°ï¼šä»·æ ¼ç›¸å¯¹ä¾¿å®œ'}</span><br>
            â€¢ <span>${window.t ? window.t('api.siliconAssist') : 'ç¡…åŸºæµåŠ¨ï¼šæ€§ä»·æ¯”é«˜'}</span><br>
            â€¢ <span>${window.t ? window.t('api.openaiAssist') : 'OpenAIï¼šè®°å¿†ç®¡ç†èƒ½åŠ›å¼º'}</span><br>
            <strong>${window.t ? window.t('api.assistApiNote') : 'æ³¨æ„ï¼šåªæœ‰é˜¿é‡Œæ”¯æŒè‡ªå®šä¹‰è¯­éŸ³åŠŸèƒ½'}</strong><br>
            <strong>${window.t ? window.t('api.currentSuggestion') : 'ğŸ’¡å½“å‰å»ºè®®ï¼š'}</strong>${recommendation}
        `;
                    }

                    // è°ƒç”¨è‡ªåŠ¨å¡«å……æ ¸å¿ƒAPI Keyçš„å‡½æ•°
                    autoFillCoreApiKey();
                }

                // è‡ªåŠ¨å¡«å……æ ¸å¿ƒAPI Keyåˆ°æ ¸å¿ƒAPI Keyè¾“å…¥æ¡†
                function autoFillCoreApiKey() {
                    const coreApiSelect = document.getElementById('coreApiSelect');
                    const assistApiSelect = document.getElementById('assistApiSelect');
                    const apiKeyInput = document.getElementById('apiKeyInput');

                    if (!coreApiSelect || !assistApiSelect || !apiKeyInput) return;

                    const selectedCoreApi = coreApiSelect.value;
                    const selectedAssistApi = assistApiSelect.value;

                    // å¦‚æœé€‰æ‹©çš„æ˜¯å…è´¹ç‰ˆï¼Œä¸éœ€è¦å¡«å……
                    if (selectedCoreApi === 'free') {
                        return;
                    }

                    // è·å–å½“å‰æ ¸å¿ƒAPI Keyè¾“å…¥æ¡†çš„å€¼
                    const currentApiKey = apiKeyInput.value.trim();

                    // å¦‚æœæ ¸å¿ƒAPI Keyè¾“å…¥æ¡†ä¸ºç©ºï¼Œå°è¯•è‡ªåŠ¨å¡«å……
                    if (!currentApiKey) {
                        let sourceApiKey = '';

                        // ç­–ç•¥1ï¼šä»current-api-keyè·å–
                        const currentApiKeyDiv = document.getElementById('current-api-key');
                        if (currentApiKeyDiv && currentApiKeyDiv.style.display !== 'none') {
                            const currentApiKeyText = currentApiKeyDiv.textContent.trim();
                            // ä»current-api-keyæ–‡æœ¬ä¸­æå–API Key
                            if (currentApiKeyText.includes('å½“å‰API Key:')) {
                                // æ ¼å¼ï¼š"ğŸ“‹ å½“å‰API Key: sk-xxx..."
                                const match = currentApiKeyText.match(/å½“å‰API Key:\s*([^\s]+)/);
                                if (match && match[1]) {
                                    sourceApiKey = match[1];
                                }
                            }
                        }

                        // å¦‚æœæ‰¾åˆ°äº†æœ‰æ•ˆçš„API Keyï¼Œè‡ªåŠ¨å¡«å……åˆ°æ ¸å¿ƒAPI Keyè¾“å…¥æ¡†
                        if (sourceApiKey) {
                            apiKeyInput.value = sourceApiKey;
                            console.log(`å·²è‡ªåŠ¨å°†API Keyå¡«å……åˆ°æ ¸å¿ƒAPI Keyè¾“å…¥æ¡†`);

                            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                            showStatus(`å·²è‡ªåŠ¨å¡«å……æ ¸å¿ƒAPI Key`, 'info');
                            setTimeout(() => {
                                const statusDiv = document.getElementById('status');
                                if (statusDiv.textContent.includes('å·²è‡ªåŠ¨å¡«å……æ ¸å¿ƒAPI Key')) {
                                    statusDiv.style.display = 'none';
                                }
                            }, 2000);
                        }
                    }
                }

                // BeaconåŠŸèƒ½ - é¡µé¢å…³é—­æ—¶å‘é€ä¿¡å·ç»™æœåŠ¡å™¨ï¼ˆä»…åœ¨ç›´æ¥æ‰“å¼€æ—¶å‘é€ï¼Œiframeä¸­ä¸å‘é€ï¼‰
                let beaconSent = false;

                function sendBeacon() {
                    // å¦‚æœåœ¨iframeä¸­ï¼Œä¸å‘é€beacon
                    if (window.parent !== window) {
                        return;
                    }

                    if (beaconSent) return; // é˜²æ­¢é‡å¤å‘é€
                    beaconSent = true;

                    try {
                        // ä½¿ç”¨navigator.sendBeaconç¡®ä¿ä¿¡å·ä¸è¢«æ‹¦æˆª
                        const success = navigator.sendBeacon('/api/beacon/shutdown', JSON.stringify({
                            timestamp: Date.now(),
                            action: 'shutdown'
                        }));

                        if (success) {
                            console.log('Beaconä¿¡å·å·²å‘é€');
                        } else {
                            console.warn('Beaconå‘é€å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨fetch');
                            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨fetch
                            fetch('/api/beacon/shutdown', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    timestamp: Date.now(),
                                    action: 'shutdown'
                                }),
                                keepalive: true // ç¡®ä¿è¯·æ±‚åœ¨é¡µé¢å…³é—­æ—¶ä»èƒ½å‘é€
                            }).catch(err => console.log('å¤‡ç”¨beaconå‘é€å¤±è´¥:', err));
                        }
                    } catch (e) {
                        console.log('Beaconå‘é€å¼‚å¸¸:', e);
                    }
                }

                // ç›‘å¬é¡µé¢å…³é—­äº‹ä»¶ï¼ˆä»…åœ¨ç›´æ¥æ‰“å¼€æ—¶ï¼‰
                if (window.parent === window) {
                    window.addEventListener('beforeunload', sendBeacon);
                    window.addEventListener('unload', sendBeacon);
                }

                // Tooltip åŠ¨æ€å®šä½åŠŸèƒ½
                function positionTooltip(iconElement, tooltipElement) {
                    const iconRect = iconElement.getBoundingClientRect();
                    const tooltipRect = tooltipElement.getBoundingClientRect();

                    // è®¡ç®—tooltipçš„åˆå§‹ä½ç½®ï¼ˆåœ¨å›¾æ ‡ä¸Šæ–¹å±…ä¸­ï¼‰
                    let left = iconRect.left + iconRect.width / 2 - tooltipRect.width / 2;
                    let top = iconRect.top - tooltipRect.height - 10; // 10pxé—´è·

                    // è®¡ç®—å›¾æ ‡ä¸­å¿ƒç›¸å¯¹äºtooltipå·¦è¾¹çš„ä½ç½®
                    let iconCenter = iconRect.left + iconRect.width / 2;

                    // æ£€æŸ¥å·¦è¾¹ç•Œ
                    if (left < 20) {
                        left = 20;
                    }

                    // æ£€æŸ¥å³è¾¹ç•Œ
                    if (left + tooltipRect.width > window.innerWidth - 20) {
                        left = window.innerWidth - tooltipRect.width - 20;
                    }

                    // è®¡ç®—ç®­å¤´ä½ç½®ï¼ˆç›¸å¯¹äºtooltipï¼‰
                    let arrowLeft = iconCenter - left;
                    // é™åˆ¶ç®­å¤´ä½ç½®åœ¨tooltipèŒƒå›´å†…
                    arrowLeft = Math.max(15, Math.min(arrowLeft, tooltipRect.width - 15));

                    // æ£€æŸ¥ä¸Šè¾¹ç•Œï¼ˆå¦‚æœä¸Šæ–¹ç©ºé—´ä¸è¶³ï¼Œæ˜¾ç¤ºåœ¨ä¸‹æ–¹ï¼‰
                    if (top < 20) {
                        top = iconRect.bottom + 10;
                        tooltipElement.setAttribute('data-position', 'bottom');
                    } else {
                        tooltipElement.setAttribute('data-position', 'top');
                    }

                    tooltipElement.style.left = left + 'px';
                    tooltipElement.style.top = top + 'px';
                    tooltipElement.style.setProperty('--arrow-left', arrowLeft + 'px');
                }

                // äºŒçº§æŠ˜å åŠŸèƒ½ï¼šåˆ‡æ¢æ¨¡å‹é…ç½®çš„å±•å¼€/æŠ˜å çŠ¶æ€
                function toggleModelConfig(modelType) {
                    const content = document.getElementById(`${modelType}-model-content`);
                    const header = document.querySelector(`#${modelType}-model-content`).previousElementSibling;
                    const icon = header.querySelector('.toggle-icon');

                    if (content.classList.contains('expanded')) {
                        // æŠ˜å 
                        content.classList.remove('expanded');
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        // å±•å¼€
                        content.classList.add('expanded');
                        icon.style.transform = 'rotate(180deg)';
                    }
                }

                // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æŠ˜å çŠ¶æ€
                document.addEventListener('DOMContentLoaded', function () {
                    // åˆå§‹åŒ–æ‰€æœ‰æ¨¡å‹é…ç½®ä¸ºæŠ˜å çŠ¶æ€
                    const modelTypes = ['summary', 'correction', 'emotion', 'vision', 'omni', 'tts'];
                    modelTypes.forEach(modelType => {
                        const content = document.getElementById(`${modelType}-model-content`);
                        if (content) {
                            const header = content.previousElementSibling;
                            const icon = header?.querySelector('.toggle-icon');

                            if (content && icon) {
                                content.classList.remove('expanded');
                                icon.style.transform = 'rotate(0deg)';
                            }
                        }
                    });

                    // æ ¹æ®è‡ªå®šä¹‰APIå¯ç”¨çŠ¶æ€è®¾ç½®åˆå§‹æŠ˜å çŠ¶æ€
                    const enableCustomApi = document.getElementById('enableCustomApi');
                    if (enableCustomApi) {
                        toggleCustomApi(); // è°ƒç”¨ä¸€æ¬¡ä»¥è®¾ç½®åˆå§‹çŠ¶æ€
                    }
                });


                // åˆå§‹åŒ–æ‰€æœ‰tooltip
                function initTooltips() {
                    const tooltipContainers = document.querySelectorAll('.tooltip-container');

                    tooltipContainers.forEach(container => {
                        const icon = container.querySelector('.tooltip-icon');
                        const tooltip = container.querySelector('.tooltip-content');

                        if (!icon || !tooltip) return;

                        icon.addEventListener('mouseenter', function () {
                            // å…ˆè®©tooltipå¯è§ä½†ä¿æŒé€æ˜ï¼Œä»¥ä¾¿è®¡ç®—å°ºå¯¸
                            tooltip.style.visibility = 'visible';
                            tooltip.style.opacity = '0';

                            // ä½¿ç”¨requestAnimationFrameç¡®ä¿DOMå·²æ›´æ–°
                            requestAnimationFrame(() => {
                                positionTooltip(icon, tooltip);
                                // å†è®¾ç½®é€æ˜åº¦ï¼Œäº§ç”Ÿæ·¡å…¥æ•ˆæœ
                                tooltip.style.opacity = '1';
                            });
                        });

                        icon.addEventListener('mouseleave', function () {
                            tooltip.style.opacity = '0';
                            // ç­‰å¾…transitionå®Œæˆåå†éšè—
                            setTimeout(() => {
                                if (tooltip.style.opacity === '0') {
                                    tooltip.style.visibility = 'hidden';
                                }
                            }, 300);
                        });
                    });

                    // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°å®šä½
                    let resizeTimeout;
                    window.addEventListener('resize', function () {
                        clearTimeout(resizeTimeout);
                        resizeTimeout = setTimeout(() => {
                            const visibleTooltips = document.querySelectorAll('.tooltip-content[style*="visibility: visible"]');
                            visibleTooltips.forEach(tooltip => {
                                const container = tooltip.closest('.tooltip-container');
                                if (container) {
                                    const icon = container.querySelector('.tooltip-icon');
                                    if (icon) {
                                        positionTooltip(icon, tooltip);
                                    }
                                }
                            });
                        }, 100);
                    });
                }

                // ç­‰å¾… i18n åˆå§‹åŒ–å®Œæˆ
                async function waitForI18n(timeout = 3000) {
                    const startTime = Date.now();
                    while (!window.t && Date.now() - startTime < timeout) {
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                    return !!window.t;
                }

                // é¡µé¢åˆå§‹åŒ–å‡½æ•° - å…ˆåŠ è½½é…ç½®å†æ˜¾ç¤ºUI
                async function initializePage() {
                    // é˜²æ­¢é‡å¤åˆå§‹åŒ–
                    if (window.apiKeySettingsInitialized) {
                        console.log('API Keyè®¾ç½®é¡µé¢å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤æ‰§è¡Œ');
                        return;
                    }

                    try {
                        // æ˜¾ç¤ºåŠ è½½é®ç½©ï¼ˆåŠé€æ˜è¦†ç›–åœ¨åŸæœ‰UIä¸Šï¼‰
                        const loadingOverlay = document.getElementById('loading-overlay');

                        if (loadingOverlay) {
                            loadingOverlay.style.display = 'flex';
                        }

                        // ç­‰å¾… i18n åˆå§‹åŒ–å®Œæˆ
                        await waitForI18n();

                        // ç¬¬ä¸€æ­¥ï¼šåŠ è½½APIæœåŠ¡å•†é€‰é¡¹
                        const providersLoaded = await loadApiProviders();

                        if (!providersLoaded) {
                            throw new Error('åŠ è½½APIæœåŠ¡å•†é€‰é¡¹å¤±è´¥');
                        }

                        // ç¬¬äºŒæ­¥ï¼šåŠ è½½å½“å‰APIé…ç½®
                        await loadCurrentApiKey();

                        // ç¬¬ä¸‰æ­¥ï¼šç­‰å¾…æ‰€æœ‰é…ç½®åŠ è½½å®Œæˆï¼Œç„¶ååˆå§‹åŒ–UIçŠ¶æ€
                        await new Promise(resolve => setTimeout(resolve, 300));

                        // åˆå§‹åŒ–tooltips
                        initTooltips();

                        // ç¡®ä¿APIè¾“å…¥æ¡†çŠ¶æ€ä¸å½“å‰é…ç½®ä¸€è‡´
                        const coreApiSelect = document.getElementById('coreApiSelect');
                        const apiKeyInput = document.getElementById('apiKeyInput');
                        const freeVersionHint = document.getElementById('freeVersionHint');

                        if (coreApiSelect && apiKeyInput && freeVersionHint) {
                            const selectedCoreApi = coreApiSelect.value;

                            // é‡æ–°ç¡®è®¤APIè¾“å…¥æ¡†çŠ¶æ€æ˜¯å¦ä¸å½“å‰é…ç½®ä¸€è‡´
                            if (selectedCoreApi === 'free') {
                                // å¦‚æœæ˜¯å…è´¹ç‰ˆï¼Œç¡®ä¿è¾“å…¥æ¡†è¢«ç¦ç”¨
                                apiKeyInput.disabled = true;
                                apiKeyInput.placeholder = window.t ? window.t('api.freeVersionNoApiKey') : 'å…è´¹ç‰ˆæ— éœ€API Key';
                                apiKeyInput.required = false;
                                apiKeyInput.value = window.t ? window.t('api.freeVersionNoApiKey') : 'å…è´¹ç‰ˆæ— éœ€API Key';
                                freeVersionHint.style.display = 'inline';
                            } else {
                                // å¦‚æœä¸æ˜¯å…è´¹ç‰ˆï¼Œç¡®ä¿è¾“å…¥æ¡†å¯ç”¨
                                apiKeyInput.disabled = false;
                                apiKeyInput.placeholder = window.t ? window.t('api.pleaseEnterApiKey') : 'è¯·è¾“å…¥æ‚¨çš„API Key';
                                apiKeyInput.required = true;
                                if (isFreeVersionText(apiKeyInput.value)) {
                                    apiKeyInput.value = '';
                                }
                                freeVersionHint.style.display = 'none';
                            }

                            // å¼ºåˆ¶æ›´æ–°è¾…åŠ©APIæ¨èå’Œé”å®šçŠ¶æ€
                            updateAssistApiRecommendation();

                            // é¡µé¢åŠ è½½å®Œæˆåç«‹å³å°è¯•è‡ªåŠ¨å¡«å……æ ¸å¿ƒAPI Key
                            autoFillCoreApiKey();
                        }

                        // æ·»åŠ æ ¸å¿ƒAPIå’Œè¾…åŠ©APIé€‰æ‹©å˜åŒ–çš„äº‹ä»¶ç›‘å¬å™¨
                        if (coreApiSelect) {
                            coreApiSelect.addEventListener('change', function () {
                                updateAssistApiRecommendation();
                                autoFillCoreApiKey();
                            });
                        }

                        const assistApiSelect = document.getElementById('assistApiSelect');
                        if (assistApiSelect) {
                            assistApiSelect.addEventListener('change', function () {
                                updateAssistApiRecommendation();
                                autoFillCoreApiKey();
                            });
                        }

                        // åˆå§‹åŒ–æ—¶ä¹Ÿæ›´æ–°ä¸€æ¬¡å»ºè®®
                        updateAssistApiRecommendation();

                        // ç›‘å¬è¯­è¨€åˆ‡æ¢äº‹ä»¶ï¼Œæ›´æ–°ä¸‹æ‹‰é€‰é¡¹
                        window.addEventListener('localechange', async () => {
                            // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
                            const selectedCoreApi = coreApiSelect ? coreApiSelect.value : '';
                            const selectedAssistApi = assistApiSelect ? assistApiSelect.value : '';

                            // é‡æ–°åŠ è½½ä¸‹æ‹‰é€‰é¡¹ï¼ˆä¼šä½¿ç”¨æ–°çš„è¯­è¨€ï¼‰
                            await loadApiProviders();

                            // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼
                            if (coreApiSelect && selectedCoreApi) {
                                coreApiSelect.value = selectedCoreApi;
                            }
                            if (assistApiSelect && selectedAssistApi) {
                                assistApiSelect.value = selectedAssistApi;
                            }
                        });

                        // æ‰€æœ‰é…ç½®åŠ è½½å®Œæˆï¼Œéšè—åŠ è½½é®ç½©
                        if (loadingOverlay) {
                            loadingOverlay.style.display = 'none';
                        }

                        console.log('API Keyè®¾ç½®é¡µé¢åˆå§‹åŒ–å®Œæˆ');

                        // æ ‡è®°é¡µé¢å·²åˆå§‹åŒ–å®Œæˆï¼Œé˜²æ­¢é‡å¤æ‰§è¡Œ
                        window.apiKeySettingsInitialized = true;

                        // é¡µé¢åˆå§‹åŒ–å®Œæˆåç«‹å³åº”ç”¨è‡ªå®šä¹‰APIçŠ¶æ€ï¼Œç¡®ä¿æ˜¾ç¤ºæ­£ç¡®çš„ç¦ç”¨çŠ¶æ€
                        setTimeout(() => {
                            toggleCustomApi();
                        }, 0);

                    } catch (error) {
                        console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);

                        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        showStatus(window.t ? window.t('api.loadConfigFailed') : 'åŠ è½½é…ç½®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');

                        // éšè—åŠ è½½é®ç½©ï¼ˆå³ä½¿æœ‰é”™è¯¯ä¹Ÿè¦æ˜¾ç¤ºUIï¼‰
                        const loadingOverlay = document.getElementById('loading-overlay');

                        if (loadingOverlay) {
                            loadingOverlay.style.display = 'none';
                        }
                    }
                }

                // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹åˆå§‹åŒ–
                document.addEventListener('DOMContentLoaded', initializePage);

                // å…¼å®¹æ€§ï¼šé˜²æ­¢åœ¨æŸäº›æƒ…å†µä¸‹DOMContentLoadedä¸è§¦å‘ï¼ˆå¦‚æ ·å¼è¡¨é˜»å¡ï¼‰ï¼Œæ·»åŠ loadä½œä¸ºåå¤‡
                window.addEventListener('load', () => {
                    if (!window.apiKeySettingsInitialized) {
                        initializePage();
                    }
                    // Electronç™½å±ä¿®å¤ï¼šå¼ºåˆ¶é‡ç»˜
                    if (document.body) {
                        void document.body.offsetHeight;
                    }
                });

                // ç«‹å³æ‰§è¡Œä¸€æ¬¡ç™½å±ä¿®å¤ï¼ˆé’ˆå¯¹Electronï¼‰
                (function () {
                    const fixWhiteScreen = () => {
                        if (document.body) {
                            void document.body.offsetHeight;
                            // å¾®å°é€æ˜åº¦å˜åŒ–è§¦å‘é‡ç»˜
                            const currentOpacity = document.body.style.opacity || '1';
                            document.body.style.opacity = '0.99';
                            requestAnimationFrame(() => {
                                document.body.style.opacity = currentOpacity;
                            });
                        }
                    };
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', fixWhiteScreen);
                    } else {
                        fixWhiteScreen();
                    }
                })();

                // å…³é—­API Keyè®¾ç½®é¡µé¢
                function closeApiKeySettings() {
                    // å¦‚æœåœ¨iframeä¸­ï¼Œé€šçŸ¥çˆ¶é¡µé¢å…³é—­å¼¹çª—
                    if (window.parent !== window) {
                        window.parent.postMessage({
                            type: 'close_api_key_settings'
                        }, '*');
                    } else {
                        window.close();
                    }
                }
            </script>
        </div> <!-- å…³é—­ main-content -->
</body>

</html>