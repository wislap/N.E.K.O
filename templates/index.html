<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/static/xiaoba_192.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title data-i18n="app.title">Project N.E.K.O.</title>
    <!-- i18next åŠ è½½å™¨ï¼ˆç»Ÿä¸€å¤„ç† CDN åŠ è½½å’Œåˆå§‹åŒ–ï¼‰ -->
    <script src="/static/i18n-i18next.js"></script>
    <script src="/static/common_dialogs.js"></script>
    <style>
        *:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            /*background: #fff;*/
            background: transparent;
            color: #222;
            font-family: 'Segoe UI', Arial, sans-serif;
            pointer-events: none;
            /* å…è®¸é¼ æ ‡äº‹ä»¶ç©¿é€ */
            overflow: hidden;
            /* é˜²æ­¢å‡ºç°æ»šåŠ¨æ¡ */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 0.85;
                transform: translateY(0);
            }
        }

        /* Status æ°”æ³¡æ¡†æ ·å¼ - æ›´æ˜¾çœ¼çš„æ ·å¼ */
        #status-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 99999;
            max-width: 500px;
            min-width: 280px;
            padding: 18px 24px;
            padding-left: 50px;
            /* ä¸ºå·¦ä¸Šè§’çš„çŒ«çˆªç•™å‡ºç©ºé—´ */
            /* è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡ */
            background-image: url('/static/icons/toast_background.png');
            /* å›¾ç‰‡è·¯å¾„ */
            background-size: 100% 100%;
            /* å¼ºåˆ¶æ‹‰ä¼¸åˆ°100%è¦†ç›–ï¼Œé¿å…è¾¹ç¼˜éœ²å‡º */
            background-position: center;
            /* å±…ä¸­æ˜¾ç¤º */
            background-repeat: no-repeat;
            /* ä¸é‡å¤ */
            background-origin: border-box;
            /* èƒŒæ™¯ä»è¾¹æ¡†åŒºåŸŸå¼€å§‹ */
            background-clip: border-box;
            /* èƒŒæ™¯è£å‰ªåˆ°è¾¹æ¡†åŒºåŸŸ */
            /* å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨èƒŒæ™¯è‰² */
            background-color: transparent;
            /* ç§»é™¤å¤‡ç”¨èƒŒæ™¯è‰²ï¼Œé¿å…ç™½è‰²è¾¹æ¡† */
            color: #fff;
            /* çº¯ç™½è‰²æ–‡å­— */
            text-shadow: none;
            /* ç§»é™¤æ–‡å­—é˜´å½± */
            border-radius: 12px;
            font-size: 18px;
            /* å­—ä½“å¤§å° */
            font-weight: 500;
            line-height: 1.6;
            box-shadow: none;
            /* ç§»é™¤é˜´å½± */
            border: none;
            /* ç§»é™¤è¾¹æ¡†ï¼Œé¿å…ç™½è‰²è¾¹æ¡†é—®é¢˜ */
            overflow: hidden;
            /* ç¡®ä¿èƒŒæ™¯å›¾ç‰‡ä¸ä¼šè¶…å‡ºåœ†è§’ */
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            /* é»˜è®¤ä¸å“åº”äº‹ä»¶ */
            word-wrap: break-word;
            white-space: pre-wrap;
            display: flex;
            /* ä½¿ç”¨flexå¸ƒå±€ */
            align-items: center;
            /* å‚ç›´å±…ä¸­å¯¹é½ */
            visibility: visible;
            /* ç¡®ä¿å…ƒç´ å¯è§ */
            text-align: center;
        }

        /* æ·»åŠ é®ç½©å±‚ä»¥ç¡®ä¿æ–‡å­—å¯è¯»æ€§ï¼ˆå¯é€‰ï¼‰ */
        #status-toast::after {
            content: '';
            position: absolute;
            top: -1px;
            /* ç¨å¾®è¶…å‡ºï¼Œç¡®ä¿å®Œå…¨è¦†ç›– */
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: rgba(0, 0, 0, 0.1);
            /* åŠé€æ˜é»‘è‰²é®ç½©ï¼Œå¢å¼ºæ–‡å­—å¯¹æ¯”åº¦ */
            border-radius: 12px;
            z-index: 0;
            /* åœ¨èƒŒæ™¯å›¾ç‰‡ä¹‹ä¸Šï¼Œæ–‡å­—å’ŒçŒ«çˆªä¹‹ä¸‹ */
            pointer-events: none;
        }

        /* å·¦ä¸Šè§’çš„å°çŒ«çˆªçˆª */
        #status-toast::before {
            content: 'ğŸ¾';
            position: absolute;
            top: 50%;
            /* å‚ç›´å±…ä¸­ */
            left: 12px;
            transform: translateY(-50%);
            /* é…åˆtop: 50%å®ç°å‚ç›´å±…ä¸­ */
            font-size: 50px;
            /* å¢å¤§çŒ«çˆªå›¾æ ‡ */
            line-height: 1;
            opacity: 1;
            filter: brightness(0) invert(1);
            /* å°†emojiå˜æˆçº¯ç™½è‰²ï¼Œç§»é™¤é˜´å½± */
            animation: pawBounce 1.5s ease-in-out infinite;
            z-index: 1;
            /* ç¡®ä¿çŒ«çˆªåœ¨é®ç½©å±‚ä¹‹ä¸Š */
        }

        @keyframes pawBounce {

            0%,
            100% {
                transform: translateY(-50%) rotate(0deg);
                /* ä¿æŒå‚ç›´å±…ä¸­ */
            }

            25% {
                transform: translateY(calc(-50% - 3px)) rotate(-5deg);
                /* ä¿æŒå‚ç›´å±…ä¸­å¹¶æ·»åŠ åŠ¨ç”» */
            }

            75% {
                transform: translateY(calc(-50% - 3px)) rotate(5deg);
                /* ä¿æŒå‚ç›´å±…ä¸­å¹¶æ·»åŠ åŠ¨ç”» */
            }
        }

        #status-toast.show {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
            animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes slideIn {
            0% {
                opacity: 0;
                transform: translateY(-20px) scale(0.8);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        #status-toast.hide {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
            animation: none;
        }

        @media (max-width: 600px) {
            #status-toast {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                font-size: 17px;
                /* ç§»åŠ¨ç«¯å­—ä½“å¤§å° */
                padding: 16px 20px;
                padding-left: 45px;
                /* ä¸ºå·¦ä¸Šè§’çš„çŒ«çˆªç•™å‡ºç©ºé—´ */
            }

            #status-toast::before {
                top: 6px;
                left: 10px;
                font-size: 40px;
                /* å¢å¤§ç§»åŠ¨ç«¯çŒ«çˆªå›¾æ ‡ */
            }

            #status-toast.show {
                transform: translateY(0) scale(1);
            }

            #status-toast.hide {
                transform: translateY(-20px) scale(0.95);
            }
        }

        /* å…¨å±€æŒ‰é’®æ ·å¼ - é˜²æ­¢æ–‡å­—è¢«é€‰ä¸­ */
        button {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* é˜²æ­¢æ‰€æœ‰å›¾æ ‡ã€å›¾ç‰‡ã€æŒ‰é’®å†…å®¹è¢«é€‰ä¸­å’Œæ‹–åŠ¨ */
        img {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            pointer-events: none;
            /* å›¾æ ‡ä¸å“åº”é¼ æ ‡äº‹ä»¶ */
        }

        /* æŒ‰é’®å†…çš„æ‰€æœ‰å†…å®¹ï¼ˆåŒ…æ‹¬emojiå›¾æ ‡ï¼‰ä¸å¯é€‰ä¸­ */
        button * {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            pointer-events: none;
            /* æŒ‰é’®å†…éƒ¨å…ƒç´ ä¸å“åº”äº‹ä»¶ï¼Œç”±æŒ‰é’®æœ¬èº«å¤„ç† */
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .container {
                width: 100%;
                height: 100%;
            }
        }

        #live2d-container {
            position: fixed;
            right: 0px;
            bottom: 0px;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            background: none;
            opacity: 1;
            overflow: hidden;
            visibility: visible;
            transition: all 1s ease-in-out, height 0ms 1s, width 0ms 1s, visibility 0ms 1s;
        }

        #live2d-container.minimized {
            right: -800px;
            /* å‘å³ä¾§ç§»å‡ºå±å¹• */
            opacity: 0;
            visibility: hidden;
        }

        #live2d-container.locked-hover-fade {
            opacity: 0.12;
        }

        #live2d-canvas {
            right: 0;
            bottom: 0;
            pointer-events: none;
            /*width: auto;*/
            /*height: auto;*/
            display: block;
            opacity: 1;
            visibility: visible;
            background: transparent;
        }

        #live2d-canvas.minimized {
            opacity: 0;
            visibility: hidden;
        }

        #vrm-container {
            position: fixed;
            right: 0px;
            bottom: 0px;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            background: none;
            opacity: 1;
            overflow: hidden;
            visibility: visible;
            transition: all 1s ease-in-out;
        }

        #vrm-container.minimized {
            right: -800px;
            opacity: 0;
            visibility: hidden;
        }

        #vrm-canvas {
            right: 0;
            bottom: 0;
            pointer-events: auto;
            display: block;
            opacity: 1;
            visibility: visible;
            background: transparent;
            width: 100%;
            height: 100%;
        }

        #vrm-canvas.minimized {
            opacity: 0;
            visibility: hidden;
        }

        #chat-container {
            margin-bottom: 50px;
            pointer-events: auto;
            /* æ¢å¤é¼ æ ‡äº¤äº’ */
            position: fixed;
            left: 20px;
            bottom: 20px;
            width: 400px;
            max-height: 500px;
            height: 500px;
            /* Fluent Design Acrylic æè´¨ */
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: saturate(180%) blur(20px);
            /* Fluent Design æ ‡å‡†æ¨¡ç³Šå€¼ */
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-radius: 8px;
            /* Fluent Design æ ‡å‡†åœ†è§’ */
            border: 1px solid rgba(255, 255, 255, 0.18);
            /* å¾®å¦™çš„é«˜å…‰è¾¹æ¡† */
            padding: 0;
            box-sizing: border-box;
            overflow: hidden;
            z-index: 20;
            /* Fluent Design å¤šå±‚é˜´å½±åˆ›é€ æ·±åº¦ */
            box-shadow:
                0 2px 4px rgba(0, 0, 0, 0.04),
                0 8px 16px rgba(0, 0, 0, 0.08),
                0 16px 32px rgba(0, 0, 0, 0.04);
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease, height 0.3s ease, max-height 0.3s ease, padding 0.3s ease, box-shadow 0.2s ease;
        }

        /* å†…éƒ¨å†…å®¹åŒ…è£¹å™¨ï¼Œè´Ÿè´£æ»šåŠ¨ - Fluent Design */
        #chat-content-wrapper {
            pointer-events: auto;
            flex-grow: 1;
            padding: 16px;
            padding-top: 48px;
            overflow-y: auto;
            scroll-behavior: smooth;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            opacity: 1;
            visibility: visible;
            background: rgba(249, 249, 249, 0.7);
            /* Fluent Design èƒŒæ™¯å±‚ */
        }

        /* åˆ‡æ¢æŒ‰é’®æ ·å¼ - æ›´é†’ç›®çš„è®¾è®¡ */
        #toggle-chat-btn {
            pointer-events: auto;
            /* æ¢å¤é¼ æ ‡äº¤äº’ */
            position: absolute;
            /* ç»å¯¹å®šä½äºå®¹å™¨å†… */
            top: 8px;
            right: 8px;
            width: 24px;
            /* æŒ‰é’®å°ºå¯¸ä»¥å®¹çº³å›¾æ ‡ */
            height: 24px;
            /* æŒ‰é’®å°ºå¯¸ä»¥å®¹çº³å›¾æ ‡ */
            background: transparent;
            /* é€æ˜èƒŒæ™¯ï¼Œå»æ‰æ·±è“è‰²æ–¹æ¡† */
            opacity: 1;
            border: none;
            /* å»æ‰è¾¹æ¡† */
            border-radius: 0;
            /* å»æ‰åœ†è§’ */
            cursor: grab;
            /* æ‹–æ‹½æ‰‹åŠ¿ */
            font-weight: bold;
            font-size: 14px;
            /* æ”¹ä¸ºå›ºå®šåƒç´ å€¼ï¼Œç¡®ä¿ä¸€è‡´æ€§ */
            line-height: 24px;
            /* ä¸æŒ‰é’®é«˜åº¦ä¸€è‡´ï¼Œç¡®ä¿å‚ç›´å±…ä¸­ */
            text-align: center;
            color: #fff;
            z-index: 21;
            /* ç¡®ä¿åœ¨å†…å®¹ä¹‹ä¸Š */
            padding: 0;
            user-select: none;
            box-shadow: none;
            /* å»æ‰é˜´å½± */
            transition: all 0.3s ease;
        }

        #toggle-chat-btn:hover {
            transform: scale(1.1);
        }

        /* èŠå¤©æ¡†æ ‡é¢˜ - Fluent Design é£æ ¼ */
        #chat-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: rgba(255, 255, 255, 0.5);
            /* æ›´é€æ˜çš„ Mica æ•ˆæœ */
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            /* Fluent Design ä¸­æ€§åˆ†éš”çº¿ */
            display: flex;
            align-items: center;
            padding: 0 16px;
            box-sizing: border-box;
            z-index: 21;
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* æ ‡é¢˜æ å†…çš„æ‰€æœ‰å…ƒç´ éƒ½ä¸å¯é€‰ä¸­ */
        #chat-header * {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        #chat-title {
            font-size: 0.875rem;
            /* Fluent Design æ ‡å‡†å­—å· 14px */
            font-weight: 600;
            color: rgba(0, 0, 0, 0.9);
            /* Fluent Design é«˜å¯¹æ¯”åº¦æ–‡æœ¬ */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* å¯¹è¯åŒºæç¤ºæ¡† */
        #chat-tooltip {
            position: absolute;
            top: 60px;
            left: 16px;
            background: rgba(68, 183, 254, 0.95);
            /* ä¸ä¸»è‰²è°ƒä¸€è‡´ #44b7fe */
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(68, 183, 254, 0.4);
            z-index: 22;
            pointer-events: none;
            animation: slideInBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        #chat-tooltip.hidden {
            opacity: 0;
            transform: translateX(-20px);
            pointer-events: none;
        }

        #chat-tooltip::after {
            content: '';
            position: absolute;
            top: -6px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid rgba(68, 183, 254, 0.95);
        }

        @keyframes slideInBounce {
            0% {
                opacity: 0;
                transform: translateX(-30px) scale(0.8);
            }

            60% {
                opacity: 1;
                transform: translateX(5px) scale(1.05);
            }

            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        /* èŠå¤©æ¶ˆæ¯æ ·å¼ */
        #chatContainer {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 0.95rem;
            animation: fadeIn 0.3s ease;
        }

        .message.user {
            align-self: flex-end;
            background: #44b7fe;
            /* ä¸æŒ‰é’®ä¸€è‡´çš„æµ…è“è‰² */
            color: #fff;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.gemini {
            align-self: flex-start;
            background: rgba(68, 183, 254, 0.12);
            /* ä¸ä¸»è‰²è°ƒåè°ƒçš„æµ…è“èƒŒæ™¯ */
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œï¼Œé…åˆ textContent ä½¿ç”¨é¿å… XSS é£é™© */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æ–‡æœ¬è¾“å…¥åŒºåŸŸæ ·å¼ - Fluent Design */
        #text-input-area {
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.5);
            /* Fluent Acrylic */
            border-top: 1px solid rgba(0, 0, 0, 0.06);
            /* ä¸­æ€§åˆ†éš”çº¿ */
            box-sizing: border-box;
            transition: all 0.3s ease;
            position: relative;
            z-index: 25;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* æ–‡æœ¬è¾“å…¥åŒºåŸŸå†…çš„æ‰€æœ‰å…ƒç´ ï¼ˆé™¤äº†è¾“å…¥æ¡†ï¼‰ä¸å¯é€‰ä¸­ */
        #text-input-area * {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* è¯­éŸ³æ¨¡å¼ä¸‹éšè—æ–‡æœ¬è¾“å…¥åŒº */
        #text-input-area.hidden {
            display: none;
        }

        /* å­—å¹•æç¤ºæ¡†æ ·å¼ï¼ˆæ”¾åœ¨è¾“å…¥æ¡†åŒºåŸŸä¸­ï¼Œä¸è¾“å…¥æ¡†å¯¹é½ï¼‰ */
        .subtitle-prompt-message {
            width: 100%;
            background: linear-gradient(135deg, rgba(68, 183, 254, 0.08) 0%, rgba(68, 183, 254, 0.12) 100%);
            border: 1px solid rgba(68, 183, 254, 0.2);
            border-radius: 8px;
            padding: 0;
            margin-top: 8px;
            box-shadow: 0 2px 8px rgba(68, 183, 254, 0.1);
            box-sizing: border-box;
        }

        .subtitle-prompt-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 8px 16px;
        }

        .subtitle-toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            cursor: pointer;
        }

        .subtitle-toggle-indicator {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #ccc;
            background-color: transparent;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .subtitle-toggle-indicator::after {
            content: 'âœ“';
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            line-height: 1;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            user-select: none;
        }

        .subtitle-toggle-indicator.active {
            border-color: #44b7fe;
            background-color: #44b7fe;
        }

        .subtitle-toggle-indicator.active::after {
            opacity: 1;
        }

        .subtitle-toggle-label {
            font-size: 15px;
            color: #333;
            user-select: none;
            cursor: pointer;
            font-weight: 500;
        }

        /* è¯­éŸ³æ¨¡å¼ä¸‹çš„å­—å¹•æç¤ºæ¡†æ ·å¼ï¼ˆæ”¾åœ¨ chat-container åº•éƒ¨ï¼‰ */
        .subtitle-prompt-message.voice-mode {
            width: auto;
            margin: 8px 12px;
            pointer-events: auto;
        }

        /* æœ€å°åŒ–æ—¶éšè—å­—å¹•æç¤ºæ¡† */
        #chat-container.minimized .subtitle-prompt-message {
            display: none !important;
        }


        /* å­—å¹•æ˜¾ç¤ºåŒºåŸŸæ ·å¼ï¼ˆå‚è€ƒXiao8é¡¹ç›®ä¼˜åŒ–ï¼Œæ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬ï¼‰ */
        #subtitle-display {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99998;
            max-width: 85%;
            min-width: 320px;
            padding: 20px 28px;
            background: linear-gradient(135deg, rgba(68, 183, 254, 0.95) 0%, rgba(68, 183, 254, 0.9) 50%, rgba(100, 200, 255, 0.95) 100%);
            color: #fff;
            border-radius: 20px;
            font-size: 19px;
            font-weight: 500;
            line-height: 1.7;
            text-align: center;
            word-wrap: break-word;
            white-space: pre-wrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            /* ç®€åŒ–ä¸º2å±‚shadowä»¥æå‡æ€§èƒ½ */
            box-shadow: 0 8px 32px rgba(68, 183, 254, 0.4), 
                        0 0 0 1px rgba(255, 255, 255, 0.3) inset;
            border: 2px solid rgba(255, 255, 255, 0.4);
            /* ç®€åŒ–ä¸ºå•å±‚text-shadow */
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        #subtitle-display.hidden {
            display: none;
        }

        #subtitle-display.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
            animation: subtitleFadeIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes subtitleFadeIn {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(20px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scale(1);
            }
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šç¦ç”¨backdrop-filterä»¥æå‡æ€§èƒ½ï¼Œè°ƒæ•´ä½ç½®é¿å…é‡å  */
        @media only screen and (max-width: 768px) {
            #subtitle-display {
                bottom: 80px; /* é¿å…ä¸è¾“å…¥æ¡†é‡å  */
                min-width: 280px;
                max-width: 90%;
                font-size: 17px;
                padding: 16px 20px;
            }
        }

        /* æˆªå›¾ç¼©ç•¥å›¾å®¹å™¨ - æ¨ªå‘æ»šåŠ¨å¸ƒå±€ */
        #screenshot-thumbnail-container {
            display: none;
            flex-direction: column;
            gap: 6px;
            padding: 8px;
            background: rgba(68, 183, 254, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(68, 183, 254, 0.2);
            animation: slideDown 0.3s ease;
        }

        #screenshot-thumbnail-container.show {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æˆªå›¾åˆ—è¡¨å¤´éƒ¨ */
        #screenshots-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 4px;
        }

        #screenshots-title {
            font-size: 0.85rem;
            color: #44b7fe;
            font-weight: 600;
        }

        #screenshot-count-wrapper {
            font-size: 0.85rem;
            color: #44b7fe;
            font-weight: 600;
        }

        #clear-all-screenshots {
            padding: 2px 8px;
            font-size: 0.75rem;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        #clear-all-screenshots:hover {
            background: #c82333;
        }

        /* æˆªå›¾åˆ—è¡¨ - æ¨ªå‘æ»šåŠ¨ */
        #screenshots-list {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 4px 0;
            scrollbar-width: thin;
            scrollbar-color: #ccc transparent;
        }

        #screenshots-list::-webkit-scrollbar {
            height: 6px;
        }

        #screenshots-list::-webkit-scrollbar-track {
            background: transparent;
        }

        #screenshots-list::-webkit-scrollbar-thumb {
            background: rgba(68, 183, 254, 0.4);
            border-radius: 3px;
        }

        #screenshots-list::-webkit-scrollbar-thumb:hover {
            background: rgba(68, 183, 254, 0.6);
        }

        /* å•ä¸ªæˆªå›¾å¡ç‰‡ */
        .screenshot-item {
            position: relative;
            flex-shrink: 0;
            width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: scale(1);
            }

            to {
                opacity: 0;
                transform: scale(0.8);
            }
        }

        .screenshot-thumbnail {
            width: 100px;
            height: 75px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid #ddd;
            background: white;
            transition: border-color 0.2s, transform 0.2s;
            cursor: pointer;
        }

        .screenshot-thumbnail:hover {
            border-color: #44b7fe;
            transform: scale(1.05);
        }

        .screenshot-remove {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: #dc3545;
            color: white;
            font-size: 14px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.2s;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .screenshot-remove:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .screenshot-index {
            font-size: 0.7rem;
            color: #44b7fe;
            background: white;
            padding: 2px 6px;
            border-radius: 10px;
            border: 1px solid rgba(68, 183, 254, 0.3);
        }

        #text-input-row {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            /* é¡¶éƒ¨å¯¹é½ï¼Œç¡®ä¿ä¸Šæ²¿å¯¹é½ */
            position: relative;
            z-index: 1;
        }

        #textInputBox {
            pointer-events: auto;
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 0.9rem;
            background: #fff;
            color: #222;
            resize: none;
            /* é«˜åº¦ç²¾ç¡®ç­‰äºæŒ‰é’®ç»„æ€»é«˜åº¦ï¼Œç¡®ä¿ä¸Šæ²¿å’Œä¸‹æ²¿å¯¹é½ */
            /* å‘é€æŒ‰é’®: padding 8pxä¸Šä¸‹ + border 2pxä¸Šä¸‹(é€æ˜) + å†…å®¹é«˜åº¦(å›¾æ ‡22px) = 8+2+22+2+8 = 42px */
            /* gap: 6px */
            /* æˆªå›¾æŒ‰é’®: padding 8pxä¸Šä¸‹ + border 2pxä¸Šä¸‹(è“è‰²) + å†…å®¹é«˜åº¦(å›¾æ ‡22px) = 8+2+22+2+8 = 42px */
            /* æ€»é«˜åº¦: 42px + 6px + 42px = 90px */
            /* ç”±äºbox-sizing: border-boxï¼Œè¾¹æ¡†åŒ…å«åœ¨é«˜åº¦å†… */
            height: 90px;
            box-sizing: border-box;
            cursor: text;
            caret-color: #222;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
            font-weight: 400;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* æ–‡æœ¬è¾“å…¥æ¡†éœ€è¦èƒ½å¤Ÿé€‰ä¸­æ–‡æœ¬ */
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
        }

        #textInputBox:focus {
            outline: none;
            border-color: #44b7fe;
            box-shadow: none;
        }

        #textInputBox:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        #button-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #textSendButton,
        #screenshotButton {
            pointer-events: auto;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            min-width: 80px;
            display: flex;
            align-items: center;
            /* å›¾æ ‡å’Œæ–‡å­—å‚ç›´å±…ä¸­å¯¹é½ */
            justify-content: flex-start;
            /* å†…å®¹å·¦å¯¹é½ï¼Œå›¾æ ‡åœ¨å·¦è¾¹ */
            gap: 6px;
            box-sizing: border-box;
        }

        /* ç¡®ä¿ä¸¤ä¸ªæŒ‰é’®çš„å›¾æ ‡å’Œæ–‡å­—å¯¹é½ */
        #textSendButton img,
        #screenshotButton img {
            flex-shrink: 0;
            /* å›¾æ ‡ä¸æ”¶ç¼© */
            width: 22px;
            /* ç»Ÿä¸€å›¾æ ‡å®½åº¦ï¼Œç¡®ä¿å¯¹é½ */
            height: 22px;
            object-fit: contain;
            pointer-events: none;
        }

        #textSendButton span,
        #screenshotButton span {
            flex-shrink: 0;
            /* æ–‡å­—ä¸æ”¶ç¼© */
            text-align: left;
            /* æ–‡å­—å·¦å¯¹é½ */
        }

        /* å‘é€æŒ‰é’®ï¼šè“è‰²èƒŒæ™¯ */
        #textSendButton {
            border: 2px solid transparent;
            background: #44b7fe;
            color: #fff;
        }

        #textSendButton:hover:not(:disabled) {
            background: #2ea0e0;
        }

        #textSendButton:disabled {
            background: #b0c4de;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* æˆªå›¾æŒ‰é’®ï¼šç™½è‰²èƒŒæ™¯ + è“è‰²è¾¹æ¡† */
        #screenshotButton {
            border: 2px solid #44b7fe;
            background: #fff;
            color: #44b7fe;
        }

        #screenshotButton:hover:not(:disabled) {
            background: #f0f9ff;
            border-color: #2ea0e0;
            border-width: 2px;
        }

        #screenshotButton:disabled {
            border-color: #b0c4de;
            border-width: 2px;
            color: #b0c4de;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯æ–‡æœ¬æ˜¾ç¤ºæ§åˆ¶ */
        .desktop-text {
            display: inline;
        }

        .mobile-text {
            display: none;
        }

        /* --- æœ€å°åŒ–çŠ¶æ€ --- */
        #chat-container.minimized {
            background: rgba(68, 183, 254, 0.15);
            opacity: 1;
            width: 50px;
            /* æœ€å°åŒ–å®½åº¦ï¼ˆæ­£æ–¹å½¢ï¼‰ */
            height: 50px;
            /* æœ€å°åŒ–é«˜åº¦ï¼ˆæ­£æ–¹å½¢ï¼‰ */
            max-height: 50px;
            padding: 0;
            /* ç§»é™¤å†…è¾¹è· */
            cursor: pointer;
            /* è®©æ•´ä¸ªå°æ–¹å—å¯ç‚¹å‡»ï¼ˆè™½ç„¶æŒ‰é’®ä¹Ÿåœ¨ï¼‰ */
            border-radius: 50%;
            /* åœ†å½¢ */
            animation: breathingGlow 2s ease-in-out infinite;
        }

        #chat-container.minimized #chat-header {
            display: none;
        }

        #chat-container.minimized #chat-content-wrapper {
            /* éšè—å†…å®¹åŒºåŸŸ */
            opacity: 0;
            visibility: hidden;
            height: 0;
            /* ç¡®ä¿ä¸å ç©ºé—´ */
            padding: 0;
            overflow: hidden;
            /* éšè—æ»šåŠ¨æ¡ */
        }

        #chat-container.minimized #text-input-area {
            display: none;
        }

        #chat-container.minimized #chat-tooltip {
            display: none;
        }

        #chat-container.minimized #toggle-chat-btn {
            /* å°†æŒ‰é’®å±…ä¸­æ˜¾ç¤º */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* ä¿æŒç›¸åŒçš„å­—ä½“å¤§å°è®¾ç½® */
            font-size: 14px;
            line-height: 24px;
            /* é˜²æ­¢hoveræ•ˆæœåœ¨æœ€å°åŒ–çŠ¶æ€ä¸‹æ”¾å¤§æŒ‰é’® */
        }

        #chat-container.minimized #toggle-chat-btn:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* æŠ˜å çŠ¶æ€ä¸‹çš„å‘¼å¸ç‰¹æ•ˆåŠ¨ç”» */
        @keyframes breathingGlow {

            0%,
            100% {
                box-shadow: 0 0 8px rgba(68, 183, 254, 0.6);
            }

            50% {
                box-shadow: 0 0 16px rgba(68, 183, 254, 1);
            }
        }

        #input-row {
            display: flex;
            margin-top: 12px;
        }

        #userInput {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1rem;
            background: #fff;
            color: #222;
        }

        #sendButton {
            margin-left: 8px;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            background: #44b7fe;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }

        #sendButton:active {
            background: #2ea0e0;
        }

        #sendButton:disabled {
            background: #b0c4de;
            cursor: not-allowed;
            opacity: 0.7;
        }



        @media only screen and (max-width: 768px) {

            /* æ‰‹æœºç«¯èƒŒæ™¯è®¾ä¸ºé»‘è‰² */
            html,
            body {
                background: #000 !important;
            }

            #live2d-container {
                position: fixed;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                z-index: 5;
            }

            #chat-container {
                width: 90vw;
                left: 5vw;
                bottom: 5px;
                max-height: 60vh;
                height: 60vh;
                padding: 0;
                margin-bottom: 5px;
                /* ç¦ç”¨å®¹å™¨å°ºå¯¸è¿‡æ¸¡ï¼Œé¿å…å½±å“è¾“å…¥åŒº */
                transition: none !important;
                background: transparent;
                box-shadow: none;
            }

            #chat-header {
                height: 40px;
                font-size: 0.9rem;
            }

            #chat-content-wrapper {
                padding: 12px;
                padding-top: 44px;
                /* ç¦ç”¨å†…å®¹åŒºè¿‡æ¸¡ï¼Œé¿å…æŠ˜å æ—¶å¯¹å­å…ƒç´ äº§ç”Ÿå½±å“ */
                transition: none !important;
                background: rgba(249, 249, 249, 0.5);
                /* Fluent èƒŒæ™¯å±‚ */
            }

            #text-input-area {
                padding: 8px;
                /* è¾“å…¥åŒºä¸å‚ä¸ä»»ä½•è¿‡æ¸¡åŠ¨ç”» */
                transition: none !important;
                background: rgba(255, 255, 255, 0.4);
                /* Fluent Acrylic */
                border-top: 1px solid rgba(0, 0, 0, 0.06);
                /* Fluent åˆ†éš”çº¿ */
            }

            /* è¾“å…¥åŒºå†…éƒ¨å…ƒç´ ä¹Ÿä¸å‚ä¸è¿‡æ¸¡ï¼Œé¿å…ç»†å¾®è·³åŠ¨ */
            #text-input-row,
            #textInputBox,
            #button-group {
                transition: none !important;
            }

            #textInputBox {
                font-size: 0.9rem;
                /* ç§»åŠ¨ç«¯ï¼šæŒ‰é’®ç»„é«˜åº¦ = ä¸¤ä¸ªæŒ‰é’®(6px*2+å†…å®¹) + gap(4px) */
                height: 62px;
                /* ä¿æŒç§»åŠ¨ç«¯åŸæœ‰é«˜åº¦ */
            }

            #button-group {
                gap: 4px;
            }

            #textSendButton,
            #screenshotButton {
                padding: 6px 12px;
                font-size: 0.8rem;
                min-width: 70px;
            }

            .screenshot-item {
                width: 80px;
            }

            .screenshot-thumbnail {
                width: 80px;
                height: 60px;
            }

            #screenshots-title {
                font-size: 0.8rem;
            }

            #clear-all-screenshots {
                font-size: 0.7rem;
                padding: 2px 6px;
            }

            .screenshot-index {
                font-size: 0.65rem;
            }

            .message {
                font-size: 0.9rem;
                max-width: 85%;
            }

            /* ç§»åŠ¨ç«¯æ˜¾ç¤ºæ‹ç…§ï¼Œéšè—æˆªå›¾ */
            .desktop-text {
                display: none;
            }

            .mobile-text {
                display: inline;
            }
        }

        @media only screen and (max-width: 768px) {

            /* ç§»åŠ¨ç«¯ï¼šæŠ˜å ï¼ˆmobile-collapsedï¼‰æ—¶ï¼ŒèŠå¤©æ¡†é«˜åº¦ä¸º12vh */
            #chat-container.mobile-collapsed {
                height: 12vh;
            }

            /* ç§»åŠ¨ç«¯ï¼šæŠ˜å ï¼ˆmobile-collapsedï¼‰æ—¶ï¼Œåˆ‡æ¢æŒ‰é’®å›ºå®šåˆ°å·¦ä¸Šè§’ */
            #chat-container.mobile-collapsed #toggle-chat-btn {
                left: 8px;
                right: auto;
                top: 8px;
                transform: none;
                position: relative;
            }

            /* é¿å…æŒ‰é’®è¦†ç›–è¾“å…¥åŒºé¡¶è¾¹ï¼Œç»™è¾“å…¥åŒºå¾®å°é¡¶è· */
            #chat-container.mobile-collapsed #text-input-area {
                margin-top: 6px;
            }
        }

        @media only screen and (max-width: 768px) {

            /* ç§»åŠ¨ç«¯ï¼šæœ€å°åŒ–ä»…æŠ˜å å†…å®¹åŒºï¼Œè¾“å…¥åŒºå¸¸é©»æ˜¾ç¤º */
            #chat-container.minimized #text-input-area {
                display: block;
            }

            /* ç§»åŠ¨ç«¯ï¼šæœ€å°åŒ–æ—¶ä¿æŒå®¹å™¨å°ºå¯¸ï¼Œè®©è¾“å…¥åŒºå¯è§å¯ç”¨ */
            #chat-container.minimized {
                width: 90vw;
                left: 5vw;
                bottom: 5px;
                height: auto;
                max-height: none;
                padding: 0;
                cursor: default;
                border-radius: 8px;
                /* ç§»åŠ¨ç«¯ä¿æŒçŸ©å½¢åœ†è§’ */
                animation: none;
                /* ç§»åŠ¨ç«¯ä¸éœ€è¦å‘¼å¸æ•ˆæœ */
                background: transparent;
            }
        }
    </style>
</head>

<body>

    <!-- æ—§çš„æŒ‰é’®é¢æ¿å·²è¿ç§»åˆ°æµ®åŠ¨æŒ‰é’®ç³»ç»Ÿï¼ˆlive2d.jsï¼‰ï¼Œä¿ç•™éšè—çš„æ—§æŒ‰é’®å…ƒç´ ä¾›åŠŸèƒ½è§¦å‘ä½¿ç”¨ -->
    <div id="sidebar" style="display: none;">
        <div id="sidebarbox">
            <button id="micButton" class="side-btn" data-i18n="voiceControl.startVoice">ğŸ¤ å¼€å§‹è¯­éŸ³</button>
            <button id="muteButton" class="side-btn" disabled data-i18n="voiceControl.rest">â¸ï¸ ä¼‘æ¯ä¸€ä¸‹</button>
            <button id="screenButton" class="side-btn" disabled data-i18n="voiceControl.screenShare">ğŸ–¥ï¸ å±å¹•å…±äº«</button>
            <button id="stopButton" class="side-btn" disabled data-i18n="voiceControl.stopShare">ğŸ›‘ åœæ­¢å…±äº«</button>
            <button id="resetSessionButton" class="side-btn" data-i18n="voiceControl.leave">ğŸ‘‹ è¯·å¥¹ç¦»å¼€</button>
            <button id="returnSessionButton" class="side-btn" data-i18n="voiceControl.return">ğŸ«´ è¯·å¥¹å›æ¥</button>
            <div id="status"></div>
        </div>
    </div>

    <!-- Status æ°”æ³¡æ¡† -->
    <div id="status-toast"></div>
    <div id="chat-container">
        <div id="chat-header">
            <span id="chat-title" data-i18n="chat.title">ğŸ’¬ å¯¹è¯</span>
        </div>
        <button id="toggle-chat-btn" data-i18n-title="common.minimize" title="æœ€å°åŒ–"><img
                src="/static/icons/minimize_icon.png" alt="æœ€å°åŒ–" data-i18n-alt="common.minimize"
                style="width: 24px; height: 24px; object-fit: contain; pointer-events: none;"></button>
        <div id="chat-tooltip" data-i18n="chat.tooltip">âœ¨ å¯¹è¯åŒº</div>
        <div id="chat-content-wrapper">
            <div id="chatContainer"></div>
        </div>
        <div id="text-input-area">
            <div id="screenshot-thumbnail-container">
                <div id="screenshots-header">
                    <span id="screenshots-title" data-i18n="chat.screenshotsTitle">ğŸ“¸ å¾…å‘é€æˆªå›¾</span><span
                        id="screenshot-count-wrapper"> (<span id="screenshot-count">0</span>)</span>
                    <button id="clear-all-screenshots" data-i18n="chat.clearAll">æ¸…ç©ºå…¨éƒ¨</button>
                </div>
                <div id="screenshots-list">
                    <!-- æˆªå›¾é¡¹å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
            </div>
            <div id="text-input-row">
                <textarea id="textInputBox" data-i18n-placeholder="chat.textInputPlaceholder"
                    placeholder="æ–‡å­—èŠå¤©æ¨¡å¼...å›è½¦å‘é€ï¼ŒShift+å›è½¦æ¢è¡Œ" tabindex="0"></textarea>
                <div id="button-group">
                    <button id="textSendButton"><img src="/static/icons/send_icon.png" alt=""><span
                            data-i18n="chat.send">å‘é€</span></button>
                    <button id="screenshotButton"><img src="/static/icons/screenshot_icon.png" alt=""><span
                            class="desktop-text" data-i18n="chat.screenshot">æˆªå›¾</span><span class="mobile-text"
                            data-i18n="chat.takePhoto">æ‹ç…§</span></button>
                </div>
            </div>
        </div>
        <!-- å­—å¹•æç¤ºæ¡†ç°åœ¨é€šè¿‡JavaScriptåŠ¨æ€åˆ›å»ºä¸ºç³»ç»Ÿæ¶ˆæ¯ï¼Œä¸å†éœ€è¦é™æ€HTML -->
    </div>
    <!-- å­—å¹•æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="subtitle-display" class="hidden"></div>
    <div id="live2d-container">
        <canvas id="live2d-canvas"></canvas>
    </div>
    <!-- VRMæ¨¡å‹å®¹å™¨ -->
    <div id="vrm-container" style="display: none;">
        <canvas id="vrm-canvas"></canvas>
    </div>


    <script>
        // é¡µé¢é…ç½® - ä» URL æˆ– API è·å–
        let lanlan_config = {
            lanlan_name: ""
        };
        window.lanlan_config = lanlan_config;
        let cubism4Model = "";
        let vrmModel = "";

        // VRM è·¯å¾„é…ç½®ç¼“å­˜ï¼ˆä»åç«¯è·å–ï¼‰
        let VRM_PATHS_CACHE = {
            user_vrm: '/user_vrm',
            static_vrm: '/static/vrm'
        };

        // åˆå§‹åŒ– VRM è·¯å¾„é…ç½®ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼Œç­‰å¾… vrm-init.js çš„ fetchVRMConfig å®Œæˆï¼‰
        function loadVRMPathsConfig() {
            // åˆå§‹åŒ– window.VRM_PATHSï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼Œä¾› window.convertVRMModelPath ä½¿ç”¨ï¼‰
            window.VRM_PATHS = window.VRM_PATHS || {
                user_vrm: '/user_vrm',
                static_vrm: '/static/vrm',
                isLoaded: false
            };
            
            // ä½¿ç”¨äº‹ä»¶æœºåˆ¶ç­‰å¾… vrm-init.js ä¸­çš„ fetchVRMConfig å®Œæˆ
            const handleVRMPathsLoaded = (event) => {
                const paths = event.detail?.paths || window.VRM_PATHS;
                if (paths && paths.user_vrm && paths.static_vrm) {
                    VRM_PATHS_CACHE = {
                        user_vrm: paths.user_vrm,
                        static_vrm: paths.static_vrm
                    };
                    console.log('[ä¸»é¡µ] VRM è·¯å¾„é…ç½®å·²ä» vrm-init.js åŠ è½½:', VRM_PATHS_CACHE);
                }
                window.removeEventListener('vrm-paths-loaded', handleVRMPathsLoaded);
            };
            
            // ç›‘å¬é…ç½®åŠ è½½å®Œæˆäº‹ä»¶
            window.addEventListener('vrm-paths-loaded', handleVRMPathsLoaded);
            
            // å¦‚æœé…ç½®å·²ç»åŠ è½½ï¼ˆäº‹ä»¶å¯èƒ½å·²ç»æ´¾å‘ï¼‰ï¼Œç«‹å³å¤„ç†
            if (window.VRM_PATHS && window.VRM_PATHS.isLoaded) {
                handleVRMPathsLoaded({ detail: { paths: window.VRM_PATHS } });
            } else {
                // è¶…æ—¶ä¿æŠ¤ï¼šå¦‚æœ 5 ç§’åä»æœªåŠ è½½ï¼Œä½¿ç”¨é»˜è®¤å€¼
                setTimeout(() => {
                    if (!VRM_PATHS_CACHE || !VRM_PATHS_CACHE.user_vrm) {
                        console.warn('[ä¸»é¡µ] VRM è·¯å¾„é…ç½®åŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                        window.removeEventListener('vrm-paths-loaded', handleVRMPathsLoaded);
                    }
                }, 5000);
            }
        }

        // åŒæ­¥è®¾ç½®é»˜è®¤å€¼ï¼ˆä¸é˜»å¡é¡µé¢åŠ è½½ï¼‰
        loadVRMPathsConfig();

        // å¼‚æ­¥è·å–é¡µé¢é…ç½®
        async function loadPageConfig() {
            try {
                // ä¼˜å…ˆä» URL è·å– lanlan_name
                const urlParams = new URLSearchParams(window.location.search);
                let lanlanNameFromUrl = urlParams.get('lanlan_name') || "";

                // ä»è·¯å¾„ä¸­æå– lanlan_name (ä¾‹å¦‚ /{lanlan_name})
                if (!lanlanNameFromUrl) {
                    const pathParts = window.location.pathname.split('/').filter(Boolean);
                    if (pathParts.length > 0 && !['focus', 'api', 'static', 'templates'].includes(pathParts[0])) {
                        lanlanNameFromUrl = decodeURIComponent(pathParts[0]);
                    }
                }

                // ä» API è·å–é…ç½®
                const apiUrl = lanlanNameFromUrl
                    ? `/api/config/page_config?lanlan_name=${encodeURIComponent(lanlanNameFromUrl)}`
                    : '/api/config/page_config';

                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.success) {
                    // ä½¿ç”¨ URL ä¸­çš„ lanlan_nameï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ API è¿”å›çš„
                    lanlan_config.lanlan_name = lanlanNameFromUrl || data.lanlan_name || "";
                    const modelPath = data.model_path || "";
                    // ä½¿ç”¨APIè¿”å›çš„model_typeï¼Œå¹¶è½¬æ¢ä¸ºå°å†™ä»¥é˜²åç«¯/æ—§æ•°æ®å¤§å°å†™ä¸ä¸€è‡´
                    const modelType = (data.model_type || 'live2d').toLowerCase();
                    // å°† model_type å†™å› lanlan_configï¼Œå‡å°‘å„å¤„"çŒœæ¨¡å¼"çš„åˆ†æ”¯
                    lanlan_config.model_type = modelType;
                    window.lanlan_config = lanlan_config;
                    // æ ¹æ®model_typeåˆ¤æ–­æ˜¯Live2Dè¿˜æ˜¯VRM
                    if (modelType === 'vrm') {
                        if (modelPath && 
                            modelPath !== 'undefined' && 
                            modelPath !== 'null' && 
                            typeof modelPath === 'string' && 
                            modelPath.trim() !== '') {
                            vrmModel = modelPath;
                            window.vrmModel = vrmModel;
                        } else {
                            // å¦‚æœè·¯å¾„æ— æ•ˆï¼Œè®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè®© vrm-init.js ä½¿ç”¨é»˜è®¤æ¨¡å‹
                            vrmModel = "";
                            window.vrmModel = "";
                        }
                        cubism4Model = "";
                        window.cubism4Model = "";
                    } else {
                        cubism4Model = modelPath;
                        window.cubism4Model = cubism4Model;
                        vrmModel = "";
                        window.vrmModel = "";
                    }

                    // åŠ¨æ€è®¾ç½®é¡µé¢æ ‡é¢˜
                    document.title = `${lanlan_config.lanlan_name} Terminal - Project N.E.K.O.`;

                    console.log('é¡µé¢é…ç½®åŠ è½½æˆåŠŸ:', { 
                        lanlan_name: lanlan_config.lanlan_name, 
                        live2d_model: cubism4Model,
                        vrm_model: vrmModel 
                    });
                    return true;
                } else {
                    console.error('è·å–é¡µé¢é…ç½®å¤±è´¥:', data.error);
                    // ä½¿ç”¨é»˜è®¤å€¼
                    lanlan_config.lanlan_name = "";
                    cubism4Model = "";
                    vrmModel = "";
                    return false;
                }
            } catch (error) {
                console.error('åŠ è½½é¡µé¢é…ç½®æ—¶å‡ºé”™:', error);
                // ä½¿ç”¨é»˜è®¤å€¼
                lanlan_config.lanlan_name = "";
                cubism4Model = "";
                vrmModel = "";
                return false;
            }
        }

        // æ ‡è®°é…ç½®æ˜¯å¦å·²åŠ è½½
        window.pageConfigReady = loadPageConfig();
    </script>
    <script>
        // BeaconåŠŸèƒ½ - é¡µé¢å…³é—­æ—¶å‘é€ä¿¡å·ç»™æœåŠ¡å™¨
        let beaconSent = false;

        function sendBeacon() {
            if (beaconSent) return; // é˜²æ­¢é‡å¤å‘é€
            beaconSent = true;

            try {
                // ä½¿ç”¨navigator.sendBeaconç¡®ä¿ä¿¡å·ä¸è¢«æ‹¦æˆª
                const success = navigator.sendBeacon('/api/beacon/shutdown', JSON.stringify({
                    timestamp: Date.now(),
                    action: 'shutdown'
                }));

                if (success) {
                    console.log('Beaconä¿¡å·å·²å‘é€');
                } else {
                    console.warn('Beaconå‘é€å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨fetch');
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨fetch
                    fetch('/api/beacon/shutdown', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            timestamp: Date.now(),
                            action: 'shutdown'
                        }),
                        keepalive: true // ç¡®ä¿è¯·æ±‚åœ¨é¡µé¢å…³é—­æ—¶ä»èƒ½å‘é€
                    }).catch(err => console.log('å¤‡ç”¨beaconå‘é€å¤±è´¥:', err));
                }
            } catch (e) {
                console.log('Beaconå‘é€å¼‚å¸¸:', e);
            }
        }

        // ç›‘å¬é¡µé¢å…³é—­äº‹ä»¶
        window.addEventListener('beforeunload', sendBeacon);
        window.addEventListener('unload', sendBeacon);
    </script>
    <script src="/static/libs/live2dcubismcore.min.js"></script> <!-- Cubism 4æ ¸å¿ƒåº“ï¼ˆæ”¯æŒCubism 3/4æ¨¡å‹ï¼‰ -->
    <script>
        // å…¨å±€èœå•è·Ÿè¸ªæœºåˆ¶ - å¿…é¡»åœ¨æ‰€æœ‰å…¶ä»–è„šæœ¬ä¹‹å‰å®šä¹‰
        // ç”¨äºè·Ÿè¸ªå½“å‰æ˜¯å¦æœ‰æ´»åŠ¨çš„èœå•ï¼ˆéº¦å…‹é£åˆ—è¡¨ã€Agenté¢æ¿ã€ä¾§è¾¹æ ç­‰ï¼‰
        window.activeMenuCount = 0;

        // è¾…åŠ©å‡½æ•°ï¼šæ ‡è®°èœå•æ‰“å¼€
        window.markMenuOpen = function () {
            window.activeMenuCount++;
        };

        // è¾…åŠ©å‡½æ•°ï¼šæ ‡è®°èœå•å…³é—­
        window.markMenuClosed = function () {
            window.activeMenuCount = Math.max(0, window.activeMenuCount - 1);
        };

        // ===== è·¨é¡µé¢é€šä¿¡ç³»ç»Ÿ =====
        const CHANNEL_NAME = 'neko_page_channel';
        let mainPageBroadcastChannel = null;

        // åˆå§‹åŒ– BroadcastChannelï¼ˆå¦‚æœæ”¯æŒï¼‰
        try {
            if (typeof BroadcastChannel !== 'undefined') {
                mainPageBroadcastChannel = new BroadcastChannel(CHANNEL_NAME);
                mainPageBroadcastChannel.onmessage = async (event) => {
                    if (event.data && event.data.action) {
                        console.log('[CrossPageComm] é€šè¿‡ BroadcastChannel æ”¶åˆ°æ¶ˆæ¯:', event.data.action);
                        await handleCrossPageAction(event.data);
                    }
                };
                console.log('[CrossPageComm] ä¸»é¡µ BroadcastChannel å·²åˆå§‹åŒ–');
            }
        } catch (e) {
            console.log('[CrossPageComm] ä¸»é¡µ BroadcastChannel ä¸å¯ç”¨');
        }

        /**
         * å‘é€ç¡®è®¤æ¶ˆæ¯
         * @param {string} messageId - è¦ç¡®è®¤çš„æ¶ˆæ¯ ID
         * @param {boolean} success - æ“ä½œæ˜¯å¦æˆåŠŸ
         * @param {string} [error] - é”™è¯¯æ¶ˆæ¯ï¼ˆä»…å½“ success ä¸º false æ—¶ï¼‰
         */
        function sendAcknowledgment(messageId, success = true, error = null) {
            if (!messageId) return;

            const ackData = { 
                type: 'ack', 
                messageId: messageId, 
                success: success,
                error: error,
                timestamp: Date.now() 
            };

            // é€šè¿‡ BroadcastChannel å‘é€ç¡®è®¤
            if (mainPageBroadcastChannel) {
                try {
                    mainPageBroadcastChannel.postMessage(ackData);
                    console.log('[CrossPageComm] é€šè¿‡ BroadcastChannel å‘é€ç¡®è®¤:', messageId, success ? 'æˆåŠŸ' : 'å¤±è´¥');
                } catch (e) {
                    console.log('[CrossPageComm] BroadcastChannel å‘é€ç¡®è®¤å¤±è´¥:', e);
                }
            }

            // åŒæ—¶é€šè¿‡ localStorage å‘é€ç¡®è®¤ï¼ˆåå¤‡æ–¹æ¡ˆï¼‰
            try {
                localStorage.setItem('nekopage_ack', JSON.stringify(ackData));
                localStorage.removeItem('nekopage_ack');
            } catch (e) {
                console.log('[CrossPageComm] localStorage å‘é€ç¡®è®¤å¤±è´¥:', e);
            }
        }

        /**
         * å¤„ç†è·¨é¡µé¢åŠ¨ä½œ
         * @param {Object} message - æ¶ˆæ¯å¯¹è±¡
         */
        async function handleCrossPageAction(message) {
            // éªŒè¯æ¶ˆæ¯æ ¼å¼
            if (!message || typeof message !== 'object') {
                console.warn('[CrossPageComm] æ”¶åˆ°æ— æ•ˆæ¶ˆæ¯: æ¶ˆæ¯ä¸æ˜¯å¯¹è±¡');
                return;
            }

            const { action, messageId } = message;

            // éªŒè¯ action å­—æ®µ
            if (!action || typeof action !== 'string') {
                console.warn('[CrossPageComm] æ”¶åˆ°æ— æ•ˆæ¶ˆæ¯: action ç¼ºå¤±æˆ–ä¸æ˜¯å­—ç¬¦ä¸²', message);
                if (messageId) {
                    sendAcknowledgment(messageId, false, 'Invalid action: action must be a non-empty string');
                }
                return;
            }

            try {
                switch (action) {
                    case 'hide_main_ui':
                        console.log('æ¥æ”¶åˆ°éšè—ä¸»ç•Œé¢å‘½ä»¤');
                        hideMainUI();
                        break;
                    case 'show_main_ui':
                        console.log('æ¥æ”¶åˆ°æ˜¾ç¤ºä¸»ç•Œé¢å‘½ä»¤');
                        await showMainUI();
                        break;
                    case 'reload_model_parameters':
                        console.log('æ¥æ”¶åˆ°é‡æ–°åŠ è½½æ¨¡å‹å‚æ•°å‘½ä»¤');
                        await reloadModelParameters();
                        break;
                    default:
                        console.warn('[CrossPageComm] æ”¶åˆ°æœªçŸ¥åŠ¨ä½œ:', action);
                        if (messageId) {
                            sendAcknowledgment(messageId, false, `Unknown action: ${action}`);
                        }
                        return; // æœªçŸ¥åŠ¨ä½œä¸å‘é€æˆåŠŸç¡®è®¤
                }

                // æ“ä½œæˆåŠŸå®Œæˆåå‘é€ç¡®è®¤æ¶ˆæ¯
                if (messageId) {
                    sendAcknowledgment(messageId, true);
                }
            } catch (error) {
                console.error('[CrossPageComm] æ‰§è¡ŒåŠ¨ä½œå¤±è´¥:', action, error);
                // æ“ä½œå¤±è´¥æ—¶å‘é€é”™è¯¯ç¡®è®¤
                if (messageId) {
                    sendAcknowledgment(messageId, false, error.message || 'Action execution failed');
                }
            }
        }

        // é¡µé¢é—´é€šä¿¡ï¼šç›‘å¬æ¥è‡ªæ¨¡å‹è®¾ç½®é¡µé¢çš„æ¶ˆæ¯ï¼ˆlocalStorage åå¤‡æ–¹æ¡ˆï¼‰
        async function handlePageMessage(event) {
            if (event.key === 'nekopage_message') {
                try {
                    const message = JSON.parse(event.newValue);
                    if (message && message.action) {
                        console.log('[CrossPageComm] é€šè¿‡ localStorage æ”¶åˆ°æ¶ˆæ¯:', message.action);
                        await handleCrossPageAction(message);
                    }
                } catch (e) {
                    console.log('è§£æé¡µé¢æ¶ˆæ¯å¤±è´¥:', e);
                }
            }
        }

        // éšè—ä¸»ç•Œé¢çš„å‡½æ•°
        function hideMainUI() {
            // éšè—ä¸»è¦UIå…ƒç´ 
            const live2dContainer = document.getElementById('live2d-container');
            const vrmContainer = document.getElementById('vrm-container');
            const chatContainer = document.getElementById('chat-container');

            // éšè—æ‰€æœ‰æ¨¡å‹å®¹å™¨ï¼Œç¡®ä¿ä¸ä¼šåŒæ—¶æ˜¾ç¤º
            if (live2dContainer) {
                live2dContainer.style.display = 'none';
            }
            if (vrmContainer) {
                vrmContainer.style.display = 'none';
            }
            if (chatContainer) {
                chatContainer.style.display = 'none';
            }

            // å¯ä»¥æ·»åŠ ä¸€ä¸ªæ ‡è®°ï¼Œè®°å½•å½“å‰éšè—çŠ¶æ€
            document.body.setAttribute('data-ui-hidden', 'true');
        }

        // æ˜¾ç¤ºä¸»ç•Œé¢çš„å‡½æ•°ï¼ˆä»…ç”¨äºå¼¹å‡ºçª—å£å…³é—­æ—¶æ¢å¤UIï¼‰
        // è®°å½•é¡µé¢åŠ è½½æ—¶é—´ï¼Œé˜²æ­¢åˆå§‹åŠ è½½æ—¶è¯¯è§¦å‘æ¨¡å‹é‡æ–°åŠ è½½
        const pageLoadTime = Date.now();

        // æå–å…¬å…±å‡½æ•°ï¼šæ¸…ç†Live2Dèµ„æºå¹¶åˆ‡æ¢åˆ°VRMï¼ˆç§»åˆ°å‡½æ•°å¤–éƒ¨ï¼Œé¿å…æ¯æ¬¡è°ƒç”¨éƒ½é‡æ–°åˆ›å»ºï¼‰
        function cleanupLive2DAndSwitchToVRM() {
            // æ¸…ç†Live2Dèµ„æº
            if (window.live2dManager) {
                try {
                    console.log('[ä¸»é¡µ] åˆ‡æ¢åˆ°VRMï¼Œå¼€å§‹æ¸…ç†Live2Dèµ„æº...');
                    
                    // æ¸…ç†Live2Dæ¨¡å‹
                    if (window.live2dManager.currentModel) {
                        if (typeof window.live2dManager.currentModel.destroy === 'function') {
                            window.live2dManager.currentModel.destroy();
                        }
                        window.live2dManager.currentModel = null;
                    }
                    
                    // åœæ­¢PIXIæ¸²æŸ“å¾ªç¯
                    if (window.live2dManager.pixi_app) {
                        window.live2dManager.pixi_app.ticker.stop();
                        // æ¸…ç†èˆå°
                        if (window.live2dManager.pixi_app.stage) {
                            window.live2dManager.pixi_app.stage.removeChildren();
                        }
                    }
                    
                    console.log('[ä¸»é¡µ] Live2Dèµ„æºæ¸…ç†å®Œæˆ');
                } catch (cleanupError) {
                    console.warn('[ä¸»é¡µ] Live2Dæ¸…ç†æ—¶å‡ºç°è­¦å‘Š:', cleanupError);
                }
            }
            
            // åˆ‡æ¢å®¹å™¨æ˜¾ç¤º
            const live2dContainer = document.getElementById('live2d-container');
            const vrmContainer = document.getElementById('vrm-container');
            if (live2dContainer) {
                live2dContainer.style.display = 'none';
                live2dContainer.classList.add('hidden');
            }
            if (vrmContainer) {
                vrmContainer.style.display = 'block';
                vrmContainer.classList.remove('hidden');
            }

            // æ¸…ç† Live2D çš„ UI å…ƒç´ ï¼ˆé”å›¾æ ‡ã€æµ®åŠ¨æŒ‰é’®ç­‰ï¼‰
            ['live2d-lock-icon', 'live2d-floating-buttons', 'live2d-return-button-container'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.remove();
            });
        }

        async function showMainUI() {
            // é˜²æ­¢åœ¨åˆå§‹åŠ è½½æ—¶ï¼ˆ3ç§’å†…ï¼‰è§¦å‘æ¨¡å‹æ£€æŸ¥
            const now = Date.now();
            if (now - pageLoadTime < 3000) {
                return;
            }

            // è·å–å®¹å™¨å…ƒç´ 
            const live2dContainer = document.getElementById('live2d-container');
            const vrmContainer = document.getElementById('vrm-container');
            const chatContainer = document.getElementById('chat-container');

            // æ£€æŸ¥æ¨¡å‹æ˜¯å¦éœ€è¦é‡æ–°åŠ è½½ï¼ˆå¼¹å‡ºçª—å£å¯èƒ½ä¿®æ”¹äº†æ¨¡å‹é…ç½®ï¼‰
            try {
                console.log('æ£€æŸ¥æ¨¡å‹é…ç½®æ˜¯å¦æœ‰æ›´æ–°...');

                // 1. è·å–å½“å‰è§’è‰²åç§°
                let currentLanlanName = lanlan_config.lanlan_name;
                // 2. è·å–æœ€æ–°çš„è§’è‰²é…ç½®ï¼ˆåŒ…å«æ‰€æœ‰çŒ«å¨˜çš„å®Œæ•´é…ç½®ï¼‰
                const charResponse = await fetch('/api/characters');
                if (!charResponse.ok) {
                    console.warn('è·å–è§’è‰²é…ç½®å¤±è´¥ï¼Œè·³è¿‡æ¨¡å‹æ£€æŸ¥');
                    // å¦‚æœè·å–é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é€»è¾‘ï¼šæ˜¾ç¤º Live2D å®¹å™¨
                    if (live2dContainer) {
                        live2dContainer.style.display = '';
                    }
                    if (vrmContainer) {
                        vrmContainer.style.display = 'none';
                    }
                    if (chatContainer) {
                        chatContainer.style.display = '';
                    }
                    document.body.removeAttribute('data-ui-hidden');
                    return;
                }
                const charactersData = await charResponse.json();

                // ç¡®ä¿ lanlan_config.lanlan_name æ›´æ–°åˆ° chara_manager.html å½“å‰é€‰ä¸­çš„çŒ«å¨˜
                currentLanlanName = lanlan_config.lanlan_name = charactersData['å½“å‰çŒ«å¨˜'];
                
                // ä»çŒ«å¨˜é…ç½®ä¸­è·å–å½“å‰è§’è‰²çš„æ¨¡å‹ä¿¡æ¯ï¼ˆæ”¯æŒLive2Då’ŒVRMï¼‰
                const catgirlConfig = charactersData['çŒ«å¨˜']?.[currentLanlanName];
                if (!catgirlConfig) {
                    console.warn(`æœªæ‰¾åˆ°è§’è‰² ${currentLanlanName} çš„é…ç½®ï¼Œè·³è¿‡æ¨¡å‹æ£€æŸ¥`);
                    // å¦‚æœæ‰¾ä¸åˆ°é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é€»è¾‘ï¼šæ˜¾ç¤º Live2D å®¹å™¨
                    if (live2dContainer) {
                        live2dContainer.style.display = '';
                    }
                    if (vrmContainer) {
                        vrmContainer.style.display = 'none';
                    }
                    if (chatContainer) {
                        chatContainer.style.display = '';
                    }
                    document.body.removeAttribute('data-ui-hidden');
                    return;
                }
                
                // è·å–å½“å‰è§’è‰²çš„ model_typeï¼Œå†³å®šæ˜¾ç¤ºå“ªä¸ªå®¹å™¨
                let modelType = (catgirlConfig.model_type || 'live2d').toLowerCase();
                
                // æ ¹æ® model_type æ˜¾ç¤ºæ­£ç¡®çš„å®¹å™¨ï¼Œç¡®ä¿ä¸¤ä¸ªå®¹å™¨ä¸ä¼šåŒæ—¶å¯è§
                if (modelType === 'vrm') {
                    // VRM æ¨¡å¼ï¼šæ˜¾ç¤º VRM å®¹å™¨ï¼Œéšè— Live2D å®¹å™¨
                    if (vrmContainer) {
                        vrmContainer.style.display = 'block';
                    }
                    if (live2dContainer) {
                        live2dContainer.style.display = 'none';
                    }
                } else {
                    // Live2D æ¨¡å¼ï¼šæ˜¾ç¤º Live2D å®¹å™¨ï¼Œéšè— VRM å®¹å™¨
                    if (live2dContainer) {
                        live2dContainer.style.display = '';
                    }
                    if (vrmContainer) {
                        vrmContainer.style.display = 'none';
                    }
                }
                
                // æ˜¾ç¤ºèŠå¤©å®¹å™¨
                if (chatContainer) {
                    chatContainer.style.display = '';
                }
                
                // ç§»é™¤éšè—çŠ¶æ€æ ‡è®°
                document.body.removeAttribute('data-ui-hidden');

                // æ ¹æ®æ¨¡å‹ç±»å‹è·å–æ­£ç¡®çš„è·¯å¾„å­—æ®µ
                let newModelPath = '';
                if (modelType === 'vrm') {
                    newModelPath = catgirlConfig.vrm || '';
                } else {
                    newModelPath = catgirlConfig.live2d || '';
                }

                if (modelType === 'vrm') {
                    // æ£€æŸ¥ VRM æ¨¡å—æ˜¯å¦å¯ç”¨
                    if (window._vrmModulesAvailable === false) {
                        console.error('[ä¸»é¡µ] VRM æ¨¡å—ä¸å¯ç”¨ï¼Œæ— æ³•åˆ‡æ¢åˆ° VRM æ¨¡å¼');
                        const errorMsg = window.t 
                            ? window.t('vrm.error.modulesNotAvailable', { defaultValue: 'VRM æ¨¡å—åŠ è½½å¤±è´¥ï¼Œæ— æ³•åˆ‡æ¢åˆ° VRM æ¨¡å¼ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚' })
                            : 'VRM æ¨¡å—åŠ è½½å¤±è´¥ï¼Œæ— æ³•åˆ‡æ¢åˆ° VRM æ¨¡å¼ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚';
                        if (typeof window.showStatus === 'function') {
                            window.showStatus(errorMsg, 5000);
                        } else {
                            alert(errorMsg);
                        }
                        // å›é€€åˆ° Live2D æ¨¡å¼
                        if (catgirlConfig.live2d) {
                            newModelPath = catgirlConfig.live2d;
                            modelType = 'live2d';
                            window.lanlan_config.model_type = 'live2d';
                        } else {
                            console.error('[ä¸»é¡µ] æ— æ³•åˆ‡æ¢åˆ° VRM æ¨¡å¼ï¼Œä¸”æ²¡æœ‰ Live2D æ¨¡å‹å¯ç”¨');
                            return;
                        }
                    } else {
                        // ä½¿ç”¨å…¬å…±å‡½æ•°æ¸…ç†Live2Dèµ„æºå¹¶åˆ‡æ¢åˆ°VRM
                        cleanupLive2DAndSwitchToVRM();

                        // æ³¨æ„ï¼šè¿™é‡Œä¸ç«‹å³åŠ è½½æ¨¡å‹ï¼Œè€Œæ˜¯ç­‰å¾… needReload åˆ¤æ–­åå†å†³å®šæ˜¯å¦åŠ è½½
                        // é¿å…é‡å¤åŠ è½½ï¼ˆå¦‚æœ needReload ä¸º falseï¼Œè¯´æ˜æ¨¡å‹å·²ç»åŠ è½½ï¼Œä¸éœ€è¦é‡å¤åŠ è½½ï¼‰
                    }
                }

                // 5. æ£€æŸ¥å½“å‰åŠ è½½çš„æ¨¡å‹è·¯å¾„ï¼ˆä¼˜å…ˆä½¿ç”¨ _lastLoadedModelPathï¼‰
                let currentModelPath = '';
                let modelMayBeInvalid = false;
                
                // æ ¹æ®æ¨¡å‹ç±»å‹åˆ†åˆ«åˆ¤æ–­æ¨¡å‹æœ‰æ•ˆæ€§
                if (modelType === 'vrm') {
                    // VRM æ¨¡å‹ï¼šæ£€æŸ¥ VRM ç®¡ç†å™¨çš„å½“å‰æ¨¡å‹
                    const currentVrmModel = window.vrmManager?.currentModel;
                    if (currentVrmModel) {
                        // æ£€æŸ¥ VRM æ¨¡å‹æ˜¯å¦å®Œæ•´å¯ç”¨
                        if (!currentVrmModel.vrm || !currentVrmModel.vrm.scene) {
                            modelMayBeInvalid = true;
                        }
                        // æ£€æŸ¥æ¨¡å‹æ˜¯å¦åœ¨åœºæ™¯ä¸­
                        if (currentVrmModel.vrm?.scene && !currentVrmModel.vrm.scene.parent) {
                            modelMayBeInvalid = true;
                        }
                        // è·å–æ¨¡å‹è·¯å¾„
                        if (currentVrmModel.url) {
                            currentModelPath = currentVrmModel.url;
                        }
                    } else {
                        modelMayBeInvalid = true;
                    }
                } else {
                    // Live2D æ¨¡å‹ï¼šæ£€æŸ¥ Live2D ç®¡ç†å™¨çš„å½“å‰æ¨¡å‹
                    const currentModel = window.live2dManager?.getCurrentModel();
                    if (currentModel) {
                        // æ£€æŸ¥æ¨¡å‹æ˜¯å¦å®Œæ•´å¯ç”¨
                        if (!currentModel.internalModel || !currentModel.internalModel.coreModel) {
                            modelMayBeInvalid = true;
                        }
                        // æ£€æŸ¥æ¨¡å‹æ˜¯å¦åœ¨èˆå°ä¸Š
                        if (!currentModel.parent) {
                            modelMayBeInvalid = true;
                        }
                        // è·å–æ¨¡å‹è·¯å¾„
                        if (currentModel.url) {
                            currentModelPath = currentModel.url;
                        }
                    } else {
                        modelMayBeInvalid = true;
                    }
                    
                    // Live2D æ¨¡å‹çš„è·¯å¾„è·å–ï¼ˆä¼˜å…ˆä½¿ç”¨ _lastLoadedModelPathï¼‰
                    if (!currentModelPath && window.live2dManager?._lastLoadedModelPath) {
                        currentModelPath = window.live2dManager._lastLoadedModelPath;
                    } else if (!currentModelPath && window.live2dManager?.modelRootPath && window.live2dManager?.modelName) {
                        currentModelPath = `${window.live2dManager.modelRootPath}/${window.live2dManager.modelName}.model3.json`;
                    }
                }

                // 6. å¯¹äºLive2Dæ¨¡å‹ï¼Œé‡æ–°åŠ è½½ç”¨æˆ·åå¥½ï¼ˆä½ç½®ã€ç¼©æ”¾ç­‰å¯èƒ½è¢«ä¿®æ”¹ï¼‰
                let modelPreferences = null;
                if (modelType !== 'vrm' && window.live2dManager) {
                    const preferences = await window.live2dManager.loadUserPreferences();
                    if (preferences && preferences.length > 0) {
                        modelPreferences = preferences.find(p => p && p.model_path === newModelPath);
                    }
                }

                // 7. æ¯”è¾ƒæ¨¡å‹è·¯å¾„ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å®Œå…¨é‡æ–°åŠ è½½æ¨¡å‹ï¼ˆä½¿ç”¨æ›´å‡†ç¡®çš„è·¯å¾„æ¯”è¾ƒï¼‰
                let needReload = false;
                if (!currentModelPath || modelMayBeInvalid) {
                    needReload = true;
                    if (modelMayBeInvalid) {
                        console.log('æ¨¡å‹å¯èƒ½æŸåï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½');
                    }
                } else {
                    // æ ‡å‡†åŒ–è·¯å¾„è¿›è¡Œæ¯”è¾ƒ
                    const normalizePath = (path) => {
                        if (!path) return '';
                        return path.split('#')[0].split('?')[0].toLowerCase();
                    };
                    const normalizedCurrent = normalizePath(currentModelPath);
                    const normalizedNew = normalizePath(newModelPath);

                    // å¯¹äºVRMæ¨¡å‹ï¼Œæ¯”è¾ƒæ–‡ä»¶åï¼›å¯¹äºLive2Dæ¨¡å‹ï¼Œæ¯”è¾ƒå®Œæ•´è·¯å¾„
                    if (modelType === 'vrm') {
                        const currentFileName = normalizedCurrent.split('/').filter(Boolean).pop() || '';
                        const newFileName = normalizedNew.split('/').filter(Boolean).pop() || '';
                        needReload = currentFileName !== newFileName;
                    } else {
                        // æå–æ¨¡å‹åç§°è¿›è¡Œæ¯”è¾ƒ
                        const currentModelName = normalizedCurrent.split('/').filter(Boolean).pop()?.replace('.model3.json', '') || '';
                        const newModelNameCompare = normalizedNew.split('/').filter(Boolean).pop()?.replace('.model3.json', '') || '';

                        if (normalizedCurrent === normalizedNew) {
                            needReload = false;
                        } else if (currentModelName && newModelNameCompare && currentModelName === newModelNameCompare) {
                            needReload = false;
                        } else {
                            needReload = true;
                        }
                    }
                }

                if (needReload) {
                    // æ¨¡å‹æ”¹å˜äº†ï¼Œéœ€è¦å®Œå…¨é‡æ–°åŠ è½½
                    if (modelType === 'vrm') {
                        // VRMæ¨¡å‹ï¼šé‡æ–°åŠ è½½VRMæ¨¡å‹
                        if (window.vrmManager && newModelPath) {
                            // ä½¿ç”¨å…¬å…±å‡½æ•°æ¸…ç†Live2Dèµ„æºå¹¶åˆ‡æ¢åˆ°VRM
                            cleanupLive2DAndSwitchToVRM();

                            // ç¡®ä¿Three.jsåœºæ™¯å·²åˆå§‹åŒ–ï¼ˆå¦‚æœè¢«æ¸…ç†äº†ï¼Œéœ€è¦é‡æ–°åˆå§‹åŒ–ï¼‰
                            if (!window.vrmManager._isInitialized || !window.vrmManager.scene || !window.vrmManager.camera || !window.vrmManager.renderer) {
                                console.log('[ä¸»é¡µ] VRMåœºæ™¯æœªåˆå§‹åŒ–ï¼Œé‡æ–°åˆå§‹åŒ–...');
                                try {
                                    await window.vrmManager.initThreeJS('vrm-canvas', 'vrm-container');
                                } catch (initError) {
                                    console.error('[ä¸»é¡µ] VRMåœºæ™¯åˆå§‹åŒ–å¤±è´¥:', initError);
                                    return;
                                }
                            }

                            const modelUrl = convertVRMModelPath(newModelPath);
                            try {
                                await loadVRMModelWithIdleAnimation(modelUrl);
                            } catch (error) {
                                console.error('[ä¸»é¡µ] VRMæ¨¡å‹é‡æ–°åŠ è½½å¤±è´¥:', error);
                            }
                        } else {
                            console.warn('[ä¸»é¡µ] VRMç®¡ç†å™¨æœªåˆå§‹åŒ–æˆ–æ¨¡å‹è·¯å¾„ä¸ºç©ºï¼Œæ— æ³•åŠ è½½VRMæ¨¡å‹');
                        }
                    } else {
                        // Live2Dæ¨¡å‹ï¼šä½¿ç”¨åŸæœ‰é€»è¾‘
                        // ä½¿ç”¨ç»Ÿä¸€çš„ dispose() æ–¹æ³•æ¸…ç†VRMèµ„æºï¼Œç¡®ä¿å®Œå…¨åˆ‡æ¢
                        if (window.vrmManager) {
                            try {
                                console.log('[ä¸»é¡µ] åˆ‡æ¢åˆ°Live2Dï¼Œå¼€å§‹æ¸…ç†VRMèµ„æº...');
                                
                                // ä½¿ç”¨ç»Ÿä¸€çš„ dispose() æ–¹æ³•è¿›è¡Œå®Œæ•´æ¸…ç†
                                // è¿™ä¼šå–æ¶ˆåŠ¨ç”»å¾ªç¯ã€æ¸…ç†æ¨¡å‹èµ„æºã€æ¸…ç†åœºæ™¯/æ¸²æŸ“å™¨ã€é‡ç½®åˆå§‹åŒ–çŠ¶æ€
                                if (typeof window.vrmManager.dispose === 'function') {
                                    await window.vrmManager.dispose();
                                } else {
                                    // é™çº§æ–¹æ¡ˆï¼šæ‰‹åŠ¨æ¸…ç†ï¼ˆå¦‚æœ dispose æ–¹æ³•ä¸å­˜åœ¨ï¼‰
                                    console.warn('[ä¸»é¡µ] VRM Manager æ²¡æœ‰ dispose æ–¹æ³•ï¼Œä½¿ç”¨é™çº§æ¸…ç†æ–¹æ¡ˆ');
                                    if (window.vrmManager._animationFrameId) {
                                        cancelAnimationFrame(window.vrmManager._animationFrameId);
                                        window.vrmManager._animationFrameId = null;
                                    }
                                    if (window.vrmManager.core && typeof window.vrmManager.core.disposeVRM === 'function') {
                                        window.vrmManager.core.disposeVRM();
                                    }
                                    if (window.vrmManager.scene) {
                                        while (window.vrmManager.scene.children.length > 0) {
                                            window.vrmManager.scene.remove(window.vrmManager.scene.children[0]);
                                        }
                                    }
                                    if (window.vrmManager.renderer && window.vrmManager.renderer.domElement) {
                                        window.vrmManager.renderer.domElement.style.display = 'none';
                                        window.vrmManager.renderer.domElement.style.opacity = '0';
                                    }
                                    window.vrmManager.currentModel = null;
                                    window.vrmManager._isInitialized = false;
                                }
                                
                                console.log('[ä¸»é¡µ] VRMèµ„æºæ¸…ç†å®Œæˆ');
                            } catch (cleanupError) {
                                console.warn('[ä¸»é¡µ] VRMæ¸…ç†æ—¶å‡ºç°è­¦å‘Š:', cleanupError);
                            }
                        }
                        
                        // éšè—VRMå®¹å™¨ï¼Œæ˜¾ç¤ºLive2Då®¹å™¨
                        const live2dContainer = document.getElementById('live2d-container');
                        const vrmContainer = document.getElementById('vrm-container');
                        if (live2dContainer) {
                            live2dContainer.style.display = 'block';
                            live2dContainer.classList.remove('hidden');
                        }
                        if (vrmContainer) {
                            vrmContainer.style.display = 'none';
                            vrmContainer.classList.add('hidden');
                        }
                        
                        await window.live2dManager.loadModel(newModelPath, {
                            preferences: modelPreferences,
                            isMobile: window.innerWidth <= 768
                        });

                        // æ›´æ–°å…¨å±€å¼•ç”¨
                        window.LanLan1.live2dModel = window.live2dManager.getCurrentModel();
                        window.LanLan1.currentModel = window.live2dManager.getCurrentModel();
                        window.LanLan1.emotionMapping = window.live2dManager.getEmotionMapping();

                        console.log('Live2Dæ¨¡å‹å·²é‡æ–°åŠ è½½');
                    }
                } else {
                    // æ¨¡å‹æœªå˜ï¼Œä½†éœ€è¦ç¡®ä¿åœºæ™¯å·²åˆå§‹åŒ–ã€æ¨¡å‹å¯è§ã€æ¢å¤åŠ¨ç”»å¾ªç¯
                    if (modelType === 'vrm') {
                        // VRMæ¨¡å‹ï¼šç¡®ä¿åœºæ™¯å·²åˆå§‹åŒ– + æ¨¡å‹å¯è§ + éœ€è¦æ—¶æ¢å¤åŠ¨ç”»å¾ªç¯
                        if (window.vrmManager) {
                            if (!window.vrmManager._isInitialized || !window.vrmManager.scene || !window.vrmManager.camera || !window.vrmManager.renderer) {
                                console.log('[ä¸»é¡µ] VRMæ¨¡å‹å·²åŠ è½½ä½†åœºæ™¯æœªåˆå§‹åŒ–ï¼Œé‡æ–°åˆå§‹åŒ–...');
                                await window.vrmManager.initThreeJS('vrm-canvas', 'vrm-container');
                                if (window.vrmManager.currentModel && window.vrmManager.currentModel.vrm) {
                                    const modelUrl = convertVRMModelPath(newModelPath);
                                    try {
                                        await loadVRMModelWithIdleAnimation(modelUrl);
                                    } catch (error) {
                                        console.error('[ä¸»é¡µ] VRMæ¨¡å‹é‡æ–°åŠ è½½å¤±è´¥:', error);
                                    }
                                }
                            } else {
                                // åœºæ™¯å·²åˆå§‹åŒ–ï¼Œç¡®ä¿æ¨¡å‹å¯è§
                                if (window.vrmManager.currentModel && window.vrmManager.currentModel.vrm) {
                                    window.vrmManager.currentModel.vrm.scene.visible = true;
                                }
                                // ç¡®ä¿æ¸²æŸ“å™¨å¯è§
                                if (window.vrmManager.renderer && window.vrmManager.renderer.domElement) {
                                    window.vrmManager.renderer.domElement.style.display = 'block';
                                    window.vrmManager.renderer.domElement.style.opacity = '1';
                                }
                                // ç¡®ä¿åŠ¨ç”»å¾ªç¯æ­£åœ¨è¿è¡Œï¼ˆå¦‚æœè¢«åœæ­¢äº†ï¼Œéœ€è¦æ¢å¤ï¼‰
                                if (!window.vrmManager._animationFrameId && typeof window.vrmManager.startAnimateLoop === 'function') {
                                    console.log('[ä¸»é¡µ] æ¢å¤VRMåŠ¨ç”»å¾ªç¯...');
                                    window.vrmManager.startAnimateLoop();
                                }
                            }
                        }
                    } else {
                        // Live2Dæ¨¡å‹ï¼šæ›´æ–°ä½ç½®å’Œç¼©æ”¾è®¾ç½®
                        const currentModel = window.live2dManager?.getCurrentModel?.();
                        if (modelPreferences && currentModel) {
                            // åº”ç”¨ä½ç½®è®¾ç½®
                            if (modelPreferences.position) {
                                currentModel.x = modelPreferences.position.x || currentModel.x;
                                currentModel.y = modelPreferences.position.y || currentModel.y;
                            }

                            // åº”ç”¨ç¼©æ”¾è®¾ç½®
                            if (modelPreferences.scale) {
                                currentModel.scale.set(
                                    modelPreferences.scale.x || currentModel.scale.x,
                                    modelPreferences.scale.y || currentModel.scale.y
                                );
                            }

                            // åº”ç”¨ä¿å­˜çš„æ¨¡å‹å‚æ•°
                            if (modelPreferences.parameters && currentModel.internalModel && currentModel.internalModel.coreModel) {
                                window.live2dManager.applyModelParameters(currentModel, modelPreferences.parameters);
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('æ£€æŸ¥/é‡æ–°åŠ è½½æ¨¡å‹æ—¶å‡ºé”™:', error);
                // å‡ºé”™æ—¶ä¸å½±å“UIæ˜¾ç¤º
            }
        }

        // é‡æ–°åŠ è½½æ¨¡å‹å‚æ•°ï¼ˆç”¨äºå‚æ•°ç¼–è¾‘å™¨ä¿å­˜åï¼‰
        async function reloadModelParameters() {
            try {
                const currentModel = window.live2dManager?.getCurrentModel();
                if (!currentModel) {
                    return;
                }

                // è·å–å½“å‰æ¨¡å‹è·¯å¾„ï¼ˆå°è¯•å¤šç§æ–¹å¼ï¼‰
                let currentModelPath = '';

                // æ–¹å¼1: ä»live2dManagerçš„_lastLoadedModelPathè·å–ï¼ˆæœ€å¯é ï¼‰
                if (window.live2dManager?._lastLoadedModelPath) {
                    currentModelPath = window.live2dManager._lastLoadedModelPath;
                }
                // æ–¹å¼2: ä»æ¨¡å‹çš„urlè·å–
                else if (currentModel.url) {
                    currentModelPath = currentModel.url;
                }
                // æ–¹å¼3: ä»modelRootPathå’ŒmodelNameæ„å»º
                else if (window.live2dManager?.modelRootPath && window.live2dManager?.modelName) {
                    currentModelPath = `${window.live2dManager.modelRootPath}/${window.live2dManager.modelName}.model3.json`;
                }
                // æ–¹å¼4: ä»cubism4Modelè·å–
                else if (typeof cubism4Model !== 'undefined' && cubism4Model) {
                    currentModelPath = cubism4Model;
                }

                if (!currentModelPath) {
                    console.warn('æ— æ³•ç¡®å®šå½“å‰æ¨¡å‹è·¯å¾„ï¼Œè·³è¿‡å‚æ•°é‡æ–°åŠ è½½');
                    return;
                }

                // é‡æ–°åŠ è½½ç”¨æˆ·åå¥½
                const preferences = await window.live2dManager.loadUserPreferences();

                // å°è¯•å¤šç§åŒ¹é…æ–¹å¼
                let modelPreferences = null;

                // é¦–å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
                modelPreferences = preferences.find(p => {
                    if (!p || !p.model_path) return false;
                    return p.model_path === currentModelPath;
                });

                if (!modelPreferences) {
                    // å°è¯•ç²¾ç¡®çš„æ–‡ä»¶ååŒ¹é…
                    const currentFileName = currentModelPath.split('/').pop() || '';
                    const matchingPrefs = preferences.filter(p => {
                        if (!p || !p.model_path) return false;
                        const prefFileName = p.model_path.split('/').pop() || '';
                        return currentFileName && prefFileName && currentFileName === prefFileName;
                    });
                    
                    if (matchingPrefs.length === 1) {
                        modelPreferences = matchingPrefs[0];
                    } else if (matchingPrefs.length > 1) {
                        console.warn('[ä¸»é¡µ] å¤šä¸ªåå¥½è®¾ç½®åŒ¹é…æ–‡ä»¶åï¼Œè·³è¿‡æ¨¡ç³ŠåŒ¹é…:', currentFileName, matchingPrefs.map(p => p.model_path));
                    }
                }

                if (!modelPreferences) {
                    // å°è¯•è§„èŒƒåŒ–çš„ basename æ¯”è¾ƒï¼ˆç§»é™¤ç‰ˆæœ¬åç¼€ï¼‰
                    const normalizeBasename = (filename) => {
                        if (!filename) return '';
                        return filename.replace(/[._-]v\d+$/i, '').replace(/\.v\d+$/i, '');
                    };
                    
                    const currentFileName = currentModelPath.split('/').pop() || '';
                    const normalizedCurrent = normalizeBasename(currentFileName);
                    
                    if (normalizedCurrent) {
                        const matchingPrefs = preferences.filter(p => {
                            if (!p || !p.model_path) return false;
                            const prefFileName = p.model_path.split('/').pop() || '';
                            const normalizedPref = normalizeBasename(prefFileName);
                            return normalizedPref && normalizedCurrent === normalizedPref;
                        });
                        
                        if (matchingPrefs.length === 1) {
                            modelPreferences = matchingPrefs[0];
                        } else if (matchingPrefs.length > 1) {
                            console.warn('[ä¸»é¡µ] å¤šä¸ªåå¥½è®¾ç½®åŒ¹é…è§„èŒƒåŒ–æ–‡ä»¶åï¼Œè·³è¿‡æ¨¡ç³ŠåŒ¹é…:', normalizedCurrent, matchingPrefs.map(p => p.model_path));
                        }
                    }
                }

                // å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå°è¯•é€šè¿‡æ¨¡å‹åç§°åŒ¹é…ï¼ˆä½¿ç”¨è¾¹ç•Œå®‰å…¨çš„åŒ¹é…ï¼‰
                if (!modelPreferences && window.live2dManager?.modelName) {
                    const modelName = window.live2dManager.modelName;
                    const matchingPrefs = preferences.filter(p => {
                        if (!p || !p.model_path) return false;
                        const pathParts = p.model_path.split('/').filter(Boolean);
                        // æ£€æŸ¥ modelName æ˜¯å¦ä½œä¸ºè·¯å¾„æ®µå‡ºç°ï¼ˆè¾¹ç•Œå®‰å…¨ï¼‰
                        return pathParts.some(part => part === modelName || part.startsWith(modelName + '.') || part.startsWith(modelName + '_'));
                    });
                    
                    if (matchingPrefs.length === 1) {
                        modelPreferences = matchingPrefs[0];
                    } else if (matchingPrefs.length > 1) {
                        console.warn('[ä¸»é¡µ] å¤šä¸ªåå¥½è®¾ç½®åŒ¹é…æ¨¡å‹åç§°ï¼Œè·³è¿‡æ¨¡ç³ŠåŒ¹é…:', modelName, matchingPrefs.map(p => p.model_path));
                    }
                }

                if (modelPreferences && modelPreferences.parameters) {
                    // åº”ç”¨ä¿å­˜çš„å‚æ•°
                    if (currentModel.internalModel && currentModel.internalModel.coreModel) {
                        window.live2dManager.applyModelParameters(currentModel, modelPreferences.parameters);
                    }
                }
            } catch (error) {
                console.error('é‡æ–°åŠ è½½æ¨¡å‹å‚æ•°å¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
            }
        }

        // æ³¨å†ŒlocalStorageäº‹ä»¶ç›‘å¬å™¨
        window.addEventListener('storage', handlePageMessage);

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ£€æŸ¥å‚æ•°æ›´æ–°ï¼ˆç”¨æˆ·ä»å…¶ä»–é¡µé¢è¿”å›æ—¶ï¼‰
        let lastParameterCheckTime = 0;
        document.addEventListener('visibilitychange', async () => {
            const now = Date.now();
            // é˜²æ­¢åœ¨åˆå§‹åŠ è½½æ—¶ï¼ˆ3ç§’å†…ï¼‰è§¦å‘
            if (document.visibilityState === 'visible' && now - pageLoadTime > 3000 && now - lastParameterCheckTime > 1000) {
                lastParameterCheckTime = now;
                await reloadModelParameters();
            }
        });

        // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶ä¹Ÿæ£€æŸ¥ï¼ˆå¤‡ç”¨æœºåˆ¶ï¼‰
        window.addEventListener('focus', async () => {
            const now = Date.now();
            // é˜²æ­¢åœ¨åˆå§‹åŠ è½½æ—¶ï¼ˆ3ç§’å†…ï¼‰è§¦å‘
            if (now - pageLoadTime > 3000 && now - lastParameterCheckTime > 1000) {
                lastParameterCheckTime = now;
                await reloadModelParameters();
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåï¼Œç­‰å¾…æ¨¡å‹åŠ è½½å®Œæˆåå†æ£€æŸ¥å‚æ•°
        // ä½¿ç”¨MutationObserveræˆ–å®šæ—¶å™¨æ£€æŸ¥æ¨¡å‹æ˜¯å¦å·²åŠ è½½
        let modelLoadCheckInterval = null;
        function startModelLoadCheck() {
            if (modelLoadCheckInterval) return;

            modelLoadCheckInterval = setInterval(async () => {
                const currentModel = window.live2dManager?.getCurrentModel();
                if (currentModel && currentModel.internalModel && currentModel.internalModel.coreModel) {
                    // æ¨¡å‹å·²åŠ è½½ï¼Œåœæ­¢æ£€æŸ¥
                    clearInterval(modelLoadCheckInterval);
                    modelLoadCheckInterval = null;

                    // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿æ¨¡å‹å®Œå…¨åˆå§‹åŒ–
                    setTimeout(async () => {
                        await reloadModelParameters();
                    }, 500);
                }
            }, 500);

            // 30ç§’ååœæ­¢æ£€æŸ¥ï¼ˆé¿å…æ— é™æ£€æŸ¥ï¼‰
            setTimeout(() => {
                if (modelLoadCheckInterval) {
                    clearInterval(modelLoadCheckInterval);
                    modelLoadCheckInterval = null;
                }
            }, 30000);
        }

        // é¡µé¢åŠ è½½æ—¶å¼€å§‹æ£€æŸ¥
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startModelLoadCheck);
        } else {
            startModelLoadCheck();
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†ç›‘å¬å™¨
        window.addEventListener('beforeunload', () => {
            window.removeEventListener('storage', handlePageMessage);
            if (modelLoadCheckInterval) {
                clearInterval(modelLoadCheckInterval);
            }
        });


        // åŠ è½½ VRM æ¨¡å‹å¹¶æ’­æ”¾å¾…æœºåŠ¨ç”»çš„è¾…åŠ©å‡½æ•°
        async function loadVRMModelWithIdleAnimation(modelUrl) {
            if (!window.vrmManager) {
                console.error('[VRM] vrmManager æœªåˆå§‹åŒ–ï¼Œæ— æ³•åŠ è½½æ¨¡å‹å–µ');
                return;
            }
            const idleAnimationPath = window.lanlan_config?.vrmIdleAnimation || 
                '/static/vrm/animation/wait03.vrma';
            await window.vrmManager.loadModel(modelUrl, { 
                autoPlay: false,
                idleAnimation: idleAnimationPath
            });
            if (window.vrmManager.animation) {
                window.vrmManager.playVRMAAnimation(idleAnimationPath, { loop: true });
            }
        }

        // è·¯å¾„è½¬æ¢å‡½æ•°ï¼šå®Œå…¨ä¾èµ– vrm-init.js ä¸­çš„æƒå¨å®ç°
        // å¦‚æœ vrm-init.js å°šæœªåŠ è½½ï¼Œè¿”å›é»˜è®¤è·¯å¾„å¹¶è­¦å‘Š
        function convertVRMModelPath(modelPath, options = {}) {
            const defaultPath = options.defaultPath || '/static/vrm/sister1.0.vrm';
            
            // ä¼˜å…ˆä½¿ç”¨ vrm-init.js ä¸­çš„æƒå¨å®ç°
            const globalConverter = window._vrmConvertPath || window.convertVRMModelPath;
            
            if (globalConverter && typeof globalConverter === 'function' && globalConverter !== convertVRMModelPath) {
                try {
                    return globalConverter(modelPath, options);
                } catch (error) {
                    console.error('[VRM Path] è·¯å¾„è½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„:', error);
                    return defaultPath;
                }
            }
            
            // vrm-init.js å°šæœªåŠ è½½æ—¶çš„æœ€å°å¤„ç†ï¼ˆä»…ç”¨äºç´§æ€¥æƒ…å†µï¼‰
            if (!modelPath || 
                modelPath === 'undefined' ||
                modelPath === 'null' || 
                (typeof modelPath === 'string' && (modelPath.trim() === '' || modelPath.includes('undefined')))) {
                console.warn('[VRM Path] vrm-init.js å°šæœªåŠ è½½ï¼Œè·¯å¾„æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„:', modelPath);
                return defaultPath;
            }
            
            if (typeof modelPath !== 'string') {
                console.warn('[VRM Path] vrm-init.js å°šæœªåŠ è½½ï¼Œè·¯å¾„ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„:', modelPath);
                return defaultPath;
            }
            
            // HTTP/HTTPS URL ç›´æ¥è¿”å›
            if (/^https?:\/\//.test(modelPath)) {
                return modelPath;
            }
            
            // å…¶ä»–æƒ…å†µï¼šç­‰å¾… vrm-init.js åŠ è½½
            console.warn('[VRM Path] vrm-init.js å°šæœªåŠ è½½ï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„ã€‚å»ºè®®ç­‰å¾…æ¨¡å—åŠ è½½åå†è°ƒç”¨ã€‚');
            return defaultPath;
        }
    </script>
    <script src="/static/libs/live2d.min.js"></script> <!-- Cubism 2.1æ ¸å¿ƒåº“ï¼ˆæ”¯æŒæ—§æ¨¡å‹ï¼‰ -->
    <script src="/static/libs/pixi.min.js"></script> <!-- PixiJS v7 CDN -->
    <script src="/static/libs/index.min.js"></script> <!-- pixi-live2d-display v0.5.0-ls-6ï¼ˆRaSan147 forkï¼Œæ”¯æŒv7ï¼‰ -->
    <!-- Three.js å’Œ three-vrm çš„ importmapï¼ˆç”¨äºåŠ¨æ€å¯¼å…¥ ES æ¨¡å—ï¼‰ -->
    <!-- 
        é‡è¦ï¼šç¡®ä¿ @pixiv/three-vrm å’Œ @pixiv/three-vrm-animation ä½¿ç”¨ç›¸åŒçš„ @pixiv/three-vrm-core ç‰ˆæœ¬
        å¦‚æœå‡ºç°åŸå‹ä¸åŒ¹é…é”™è¯¯ï¼Œè¯·æ£€æŸ¥ï¼š
        1. three-vrm.module.min.js å’Œ three-vrm-animation.module.js æ˜¯å¦åŸºäºç›¸åŒçš„ three-vrm-core ç‰ˆæœ¬æ„å»º
        2. å»ºè®®ä½¿ç”¨ three-vrm-core v3.x+ çš„æ„å»ºç‰ˆæœ¬ï¼ˆæ¨èï¼‰
        3. æˆ–è€…ç¡®ä¿ä¸¤ä¸ªæ¨¡å—éƒ½ä½¿ç”¨ three-vrm-core v2.x å…¼å®¹ç‰ˆæœ¬
        4. åœ¨éƒ¨ç½²å‰ï¼Œæ£€æŸ¥æ¯ä¸ªæ–‡ä»¶å†…æ‰“åŒ…çš„ core ç‰ˆæœ¬å·æ˜¯å¦ä¸€è‡´
    -->
    <script type="importmap">
    {
        "imports": {
            "three": "/static/libs/three.module.js",
            "three/addons/": "/static/libs/three/addons/",
            "@pixiv/three-vrm": "/static/libs/three-vrm.module.min.js",
            "@pixiv/three-vrm-animation": "/static/libs/three-vrm-animation.module.js"
        }
    }
    </script>
    <!-- å°† THREE æŒ‚è½½åˆ° window å¯¹è±¡ï¼Œä»¥ä¾¿éæ¨¡å—è„šæœ¬å¯ä»¥ä½¿ç”¨ -->
    <script type="module">
        import * as THREE from 'three';
        // å¯¼å…¥ GLTFLoaderï¼ˆæ³¨æ„è·¯å¾„è¦å’Œ importmap å¯¹åº”ï¼‰
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        window.THREE = THREE;
        // æ‰‹åŠ¨å°† GLTFLoader æŒ‚è½½åˆ° window.THREE å¯¹è±¡ä¸Š
        // ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼é¿å… "Cannot redefine property" é”™è¯¯
        let gltfLoaderAttached = false;
        
        // æ–¹æ³•1: æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ä¸”å€¼ç›¸åŒ
        if (window.THREE.GLTFLoader === GLTFLoader) {
            console.log('[Three.js] GLTFLoader å·²å­˜åœ¨ä¸”å€¼ç›¸åŒï¼Œè·³è¿‡æŒ‚è½½');
            gltfLoaderAttached = true;
        } else {
            // æ–¹æ³•2: å°è¯•ç®€å•èµ‹å€¼
            try {
                const descriptor = Object.getOwnPropertyDescriptor(window.THREE, 'GLTFLoader');
                if (descriptor && !descriptor.configurable) {
                    // å±æ€§å­˜åœ¨ä¸”ä¸å¯é…ç½®ï¼Œæ£€æŸ¥å€¼
                    if (descriptor.value === GLTFLoader) {
                        console.log('[Three.js] GLTFLoader å·²å­˜åœ¨ä¸”å€¼ç›¸åŒï¼ˆä¸å¯é…ç½®ï¼‰ï¼Œè·³è¿‡æŒ‚è½½');
                        gltfLoaderAttached = true;
                    } else {
                        throw new Error('GLTFLoader å·²å­˜åœ¨ä¸”ä¸å¯é‡æ–°å®šä¹‰');
                    }
                } else {
                    // å°è¯•åˆ é™¤ï¼ˆå¦‚æœå­˜åœ¨ä¸”å¯é…ç½®ï¼‰æˆ–ç›´æ¥èµ‹å€¼
                    if (descriptor && descriptor.configurable) {
                        delete window.THREE.GLTFLoader;
                    }
                    window.THREE.GLTFLoader = GLTFLoader;
                    console.log('[Three.js] ES æ¨¡å—å·²åŠ è½½å¹¶æŒ‚è½½åˆ° window.THREE (å« GLTFLoader)');
                    gltfLoaderAttached = true;
                }
            } catch (error) {
                // æ–¹æ³•3: å¦‚æœç®€å•èµ‹å€¼å¤±è´¥ï¼Œå°è¯• definePropertyï¼ˆä»…åœ¨å¯¹è±¡ä¸å¯æ‰©å±•æ—¶ï¼‰
                if (!gltfLoaderAttached && !Object.isExtensible(window.THREE)) {
                    try {
                        Object.defineProperty(window.THREE, 'GLTFLoader', {
                            value: GLTFLoader,
                            writable: true,
                            enumerable: true,
                            configurable: true
                        });
                        console.log('[Three.js] ES æ¨¡å—å·²åŠ è½½å¹¶æŒ‚è½½åˆ° window.THREE (å« GLTFLoaderï¼Œä½¿ç”¨ defineProperty)');
                        gltfLoaderAttached = true;
                    } catch (defineError) {
                        console.error('[Three.js] æ— æ³•æ·»åŠ  GLTFLoader åˆ° window.THREE:', defineError);
                    }
                } else {
                    console.error('[Three.js] æ— æ³•æ·»åŠ  GLTFLoader åˆ° window.THREE:', error);
                }
            }
        }
        
        // æ–¹æ³•4: å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
        if (!gltfLoaderAttached) {
            window.THREE_GLTFLoader = GLTFLoader;
            console.warn('[Three.js] GLTFLoader å·²æŒ‚è½½åˆ° window.THREE_GLTFLoader ä½œä¸ºå¤‡ç”¨');
        }
    </script>
    <!-- i18next å·²åœ¨ head ä¸­åŠ è½½ï¼Œè¿™é‡Œä¸å†éœ€è¦ -->
    <!-- OGG OPUS WASM è§£ç å™¨ (@wasm-audio-decoders/ogg-opus-decoder) -->
    <script>window.webpackChunkogg_opus_decoder = window.webpackChunkogg_opus_decoder || [];</script>
    <script src="/static/libs/ogg-opus-decoder.min.js" charset="UTF-8"></script>
    <script src="/static/common_ui.js"></script>
    <script>
        // ç­‰å¾…é…ç½®åŠ è½½å®Œæˆåå†åŠ è½½ Live2D å’Œ app.js
        (async function () {
            try {
                // ç­‰å¾…é…ç½®åŠ è½½å®Œæˆ
                await window.pageConfigReady;

                // åŠ¨æ€åŠ è½½ live2d æ¨¡å—ï¼ˆæŒ‰é¡ºåºåŠ è½½æ‹†åˆ†åçš„æ–‡ä»¶ï¼‰
                const live2dModules = [
                    '/static/live2d-core.js',
                    '/static/live2d-emotion.js',
                    '/static/live2d-model.js',
                    '/static/live2d-interaction.js',
                    '/static/live2d-ui-buttons.js',
                    '/static/live2d-ui-popup.js',
                    '/static/live2d-ui-hud.js',
                    '/static/live2d-ui-drag.js',
                    '/static/live2d-init.js'
                ];

                // æŒ‰é¡ºåºåŠ è½½è„šæœ¬çš„è¾…åŠ©å‡½æ•°
                // å¯¹äºå…³é”®æ¨¡å—ï¼ˆcore/initï¼‰ï¼Œå¤±è´¥æ—¶ä¼šä¸­æ­¢å¹¶æç¤ºç”¨æˆ·
                async function loadScriptsSequentially(scripts, criticalModules = []) {
                    for (const src of scripts) {
                        try {
                            await new Promise((resolve, reject) => {
                                const script = document.createElement('script');
                                script.src = src;
                                script.onload = resolve;
                                script.onerror = (error) => {
                                    console.error(`è„šæœ¬åŠ è½½å¤±è´¥: ${src}`, error);
                                    reject(error);
                                };
                                document.body.appendChild(script);
                            });
                        } catch (error) {
                            // ä½¿ç”¨è·¯å¾„ç»“å°¾æˆ–æ–‡ä»¶åæ¥åŒ¹é…å…³é”®æ¨¡å—
                            const getBasename = (path) => {
                                const parts = path.split('/');
                                return parts[parts.length - 1];
                            };
                            const srcBasename = getBasename(src);
                            const isCritical = criticalModules.some(critical => 
                                src.endsWith(critical) || srcBasename === critical
                            );
                            if (isCritical) {
                                // å…³é”®æ¨¡å—å¤±è´¥ï¼šä¸­æ­¢å¹¶æç¤ºç”¨æˆ·
                                console.error(`å…³é”®æ¨¡å—åŠ è½½å¤±è´¥ï¼Œä¸­æ­¢åˆå§‹åŒ–: ${src}`, error);
                                const errorMsg = `Live2D å…³é”®æ¨¡å—åŠ è½½å¤±è´¥: ${src}\n\nè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚`;
                                alert(errorMsg);
                                throw new Error(`å…³é”®æ¨¡å—åŠ è½½å¤±è´¥: ${src}`);
                            } else {
                                console.error(`åŠ è½½è„šæœ¬å¤±è´¥ï¼Œä½†ç»§ç»­åŠ è½½å…¶ä»–è„šæœ¬: ${src}`, error);
                                // éå…³é”®æ¨¡å—å¤±è´¥ï¼šç»§ç»­åŠ è½½ä¸‹ä¸€ä¸ªè„šæœ¬
                            }
                        }
                    }
                }

                // åŠ è½½æ‰€æœ‰ live2d æ¨¡å—
                const criticalLive2DModules = ['live2dcubismcore', 'live2d.min.js', 'live2d-init.js'];
                await loadScriptsSequentially(live2dModules, criticalLive2DModules);

                // ç­‰å¾…Three.jsåŠ è½½å®Œæˆå¹¶ç¡®ä¿å®Œå…¨åˆå§‹åŒ–
                if (typeof window.THREE === 'undefined' || !window.THREE) {
                    await new Promise(resolve => {
                        let checkCount = 0;
                        const maxChecks = 50; // æœ€å¤šç­‰å¾… 5 ç§’
                        const checkThree = () => {
                            if (typeof window.THREE !== 'undefined' && window.THREE !== null) {
                                // ç¡®ä¿ THREE å¯¹è±¡æœ‰åŸºæœ¬å±æ€§ï¼ˆéªŒè¯å®Œæ•´æ€§ï¼‰
                                if (window.THREE.Scene && window.THREE.PerspectiveCamera) {
                                    console.log('[VRM æ¨¡å—] THREE.js å·²å®Œå…¨åŠ è½½');
                                    resolve();
                                } else if (checkCount < maxChecks) {
                                    checkCount++;
                                    setTimeout(checkThree, 100);
                                } else {
                                    console.warn('[VRM æ¨¡å—] THREE.js åŠ è½½è¶…æ—¶ï¼Œä½†ç»§ç»­å°è¯•åŠ è½½ VRM æ¨¡å—');
                                    resolve();
                                }
                            } else if (checkCount < maxChecks) {
                                checkCount++;
                                setTimeout(checkThree, 100);
                            } else {
                                console.warn('[VRM æ¨¡å—] THREE.js åŠ è½½è¶…æ—¶ï¼Œä½†ç»§ç»­å°è¯•åŠ è½½ VRM æ¨¡å—');
                                resolve();
                            }
                        };
                        checkThree();
                    });
                }

                // åŠ è½½VRMæ¨¡å—ï¼ˆæŒ‰é¡ºåºåŠ è½½ï¼Œå¤±è´¥ä¸å½±å“Live2Dï¼‰
                try {
                    const vrmModules = [
                        '/static/vrm-orientation.js',
                        '/static/vrm-core.js',
                        '/static/vrm-expression.js',
                        '/static/vrm-animation.js',
                        '/static/vrm-interaction.js',
                        '/static/vrm-manager.js',
                        '/static/vrm-ui-popup.js',
                        '/static/vrm-ui-buttons.js'
                    ];

                    for (const moduleSrc of vrmModules) {
                        const script = document.createElement('script');
                        script.src = moduleSrc;
                        await new Promise((resolve, reject) => {
                            script.onload = () => resolve();
                            script.onerror = (error) => resolve(); // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­ï¼Œä¸ä¸­æ–­æµç¨‹
                            document.body.appendChild(script);
                        });
                    }

                    // åŠ è½½VRMåˆå§‹åŒ–è„šæœ¬
                    const vrmInitScript = document.createElement('script');
                    vrmInitScript.src = '/static/vrm-init.js';
                    await new Promise((resolve, reject) => {
                        vrmInitScript.onload = () => resolve();
                        vrmInitScript.onerror = (error) => resolve(); // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­
                        document.body.appendChild(vrmInitScript);
                    });
                    
                    // æœ€ç»ˆ readiness åˆ¤å®šï¼šæ£€æŸ¥å…³é”®å¯¹è±¡æ˜¯å¦å­˜åœ¨
                    const checkVRMReadiness = () => {
                        const hasTHREE = typeof window.THREE !== 'undefined' && window.THREE !== null;
                        const hasVRMCore = typeof window.VRMCore !== 'undefined' && window.VRMCore !== null;
                        const hasVRMManager = typeof window.VRMManager !== 'undefined' && window.VRMManager !== null;
                        
                        if (hasTHREE && hasVRMCore && hasVRMManager) {
                            console.log('[VRM æ¨¡å—] æ‰€æœ‰å…³é”®å¯¹è±¡å·²åŠ è½½ï¼Œå‘é€ vrm-modules-ready äº‹ä»¶');
                            window.dispatchEvent(new Event('vrm-modules-ready'));
                        } else {
                            console.warn('[VRM æ¨¡å—] å…³é”®å¯¹è±¡ç¼ºå¤±ï¼Œå‘é€ vrm-modules-failed äº‹ä»¶', {
                                hasTHREE,
                                hasVRMCore,
                                hasVRMManager
                            });
                            window.dispatchEvent(new CustomEvent('vrm-modules-failed', {
                                detail: {
                                    hasTHREE,
                                    hasVRMCore,
                                    hasVRMManager
                                }
                            }));
                        }
                    };
                    
                    // å»¶è¿Ÿä¸€ç‚¹æ£€æŸ¥ï¼Œç»™è„šæœ¬æ‰§è¡Œæ—¶é—´
                    setTimeout(checkVRMReadiness, 100);
                } catch (vrmError) {
                    console.warn('VRMæ¨¡å—åŠ è½½è¿‡ç¨‹ä¸­å‡ºé”™ï¼ˆä¸å½±å“Live2Dï¼‰:', vrmError);
                    // å³ä½¿ catch åˆ°é”™è¯¯ï¼Œä¹Ÿå‘é€ failed äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('vrm-modules-failed', {
                        detail: { error: vrmError }
                    }));
                }
                
                // ç›‘å¬ VRM æ¨¡å—åŠ è½½å¤±è´¥äº‹ä»¶ï¼Œç¦ç”¨ VRM ç›¸å…³åŠŸèƒ½å¹¶æç¤ºç”¨æˆ·
                window.addEventListener('vrm-modules-failed', (event) => {
                    console.error('[VRM æ¨¡å—] åŠ è½½å¤±è´¥ï¼Œç¦ç”¨ VRM ç›¸å…³åŠŸèƒ½', event.detail);
                    
                    // æ˜¾ç¤ºç”¨æˆ·æç¤º
                    const errorDetail = event.detail || {};
                    let errorMessage = 'VRM æ¨¡å—åŠ è½½å¤±è´¥ï¼ŒVRM åŠŸèƒ½å·²ç¦ç”¨ã€‚';
                    if (errorDetail.error) {
                        errorMessage += `\né”™è¯¯: ${errorDetail.error.message || errorDetail.error}`;
                    } else if (errorDetail.hasTHREE === false || errorDetail.hasVRMCore === false || errorDetail.hasVRMManager === false) {
                        const missing = [];
                        if (errorDetail.hasTHREE === false) missing.push('Three.js');
                        if (errorDetail.hasVRMCore === false) missing.push('VRM Core');
                        if (errorDetail.hasVRMManager === false) missing.push('VRM Manager');
                        errorMessage += `\nç¼ºå¤±æ¨¡å—: ${missing.join(', ')}`;
                    }
                    
                    // åœ¨æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†é”™è¯¯
                    console.error('[VRM æ¨¡å—]', errorMessage);
                    
                    // å¯é€‰ï¼šæ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„æç¤ºï¼ˆä½¿ç”¨ toast æˆ–çŠ¶æ€æ ï¼‰
                    if (typeof window.showStatus === 'function') {
                        window.showStatus(errorMessage, 5000);
                    } else {
                        // å¦‚æœæ²¡æœ‰ showStatusï¼Œä½¿ç”¨ console è­¦å‘Š
                        console.warn('[VRM æ¨¡å—]', errorMessage);
                    }
                    
                    // æ ‡è®° VRM æ¨¡å—ä¸ºä¸å¯ç”¨
                    window._vrmModulesAvailable = false;
                    
                    // ç¦ç”¨ VRM ç›¸å…³çš„ UI å…ƒç´ ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const vrmContainer = document.getElementById('vrm-container');
                    if (vrmContainer) {
                        vrmContainer.style.display = 'none';
                        vrmContainer.classList.add('vrm-disabled');
                    }
                    
                    // å¦‚æœå½“å‰æ˜¯ VRM æ¨¡å¼ï¼Œå°è¯•åˆ‡æ¢å› Live2D
                    if (window.lanlan_config?.model_type === 'vrm') {
                        console.warn('[VRM æ¨¡å—] å½“å‰ä¸º VRM æ¨¡å¼ä½†æ¨¡å—åŠ è½½å¤±è´¥ï¼Œå»ºè®®åˆ‡æ¢åˆ° Live2D æ¨¡å¼');
                        // ä¸è‡ªåŠ¨åˆ‡æ¢ï¼Œè®©ç”¨æˆ·å†³å®š
                    }
                });
                
                // ç›‘å¬ VRM æ¨¡å—åŠ è½½æˆåŠŸäº‹ä»¶ï¼Œå¯ç”¨ VRM ç›¸å…³åŠŸèƒ½
                window.addEventListener('vrm-modules-ready', () => {
                    console.log('[VRM æ¨¡å—] åŠ è½½æˆåŠŸï¼Œå¯ç”¨ VRM ç›¸å…³åŠŸèƒ½');
                    window._vrmModulesAvailable = true;
                    
                    // ç§»é™¤ç¦ç”¨æ ‡è®°
                    const vrmContainer = document.getElementById('vrm-container');
                    if (vrmContainer) {
                        vrmContainer.classList.remove('vrm-disabled');
                    }
                });


                // ç­‰å¾… live2d æ¨¡å—åŠ è½½å®Œæˆåå†åŠ è½½ app.js
                const appScript = document.createElement('script');
                appScript.src = '/static/app.js';
                document.body.appendChild(appScript);
            } catch (error) {
                console.error('åŠ è½½è„šæœ¬æ—¶å‡ºé”™:', error);
            }
        })();
    </script>
    <script>
        // å¯¹è¯åŒºæç¤ºæ¡†é€»è¾‘ - ä»…åœ¨ç¬¬ä¸€æ¬¡è®¿é—®æ—¶æ˜¾ç¤º
        (function () {

            // ç­‰å¾… DOM å’Œæ‰€æœ‰è„šæœ¬å®Œå…¨åŠ è½½
            window.addEventListener('load', function () {
                // å†ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿ common_ui.js çš„äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®
                setTimeout(function () {
                    const chatTooltip = document.getElementById('chat-tooltip');
                    const textInputBox = document.getElementById('textInputBox');
                    const chatContainer = document.getElementById('chat-container');
                    const toggleBtn = document.getElementById('toggle-chat-btn');
                    let autoCollapseTimer = null;

                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼ˆåªå½±å“æç¤ºæ¡†æ˜¾ç¤ºï¼‰
                    const hasVisitedBefore = localStorage.getItem('chat_tooltip_shown');

                    if (chatTooltip && textInputBox && chatContainer && toggleBtn) {
                        // æç¤ºæ¡†åªåœ¨ç¬¬ä¸€æ¬¡è®¿é—®æ—¶æ˜¾ç¤º
                        if (!hasVisitedBefore) {
                            chatTooltip.classList.remove('hidden');
                            localStorage.setItem('chat_tooltip_shown', 'true');
                        } else {
                            chatTooltip.classList.add('hidden');
                        }

                        // ç›‘å¬æ–‡æœ¬æ¡†ç„¦ç‚¹äº‹ä»¶
                        const handleFocus = () => {
                            // ç”¨æˆ·èšç„¦äº†æ–‡æœ¬æ¡†ï¼Œç«‹å³éšè—æç¤ºå¹¶å–æ¶ˆè‡ªåŠ¨æŠ˜å 
                            if (autoCollapseTimer) {
                                clearTimeout(autoCollapseTimer);
                                autoCollapseTimer = null;
                            }
                            chatTooltip.classList.add('hidden');
                            // ç§»é™¤ç›‘å¬å™¨ï¼Œå› ä¸ºå·²ç»å®Œæˆä»»åŠ¡
                            textInputBox.removeEventListener('focus', handleFocus);
                        };

                        // ç›‘å¬æ‰‹åŠ¨æŠ˜å æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                        const handleToggleClick = () => {
                            // ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»äº†æŠ˜å æŒ‰é’®ï¼Œå–æ¶ˆè‡ªåŠ¨æŠ˜å 
                            if (autoCollapseTimer) {
                                clearTimeout(autoCollapseTimer);
                                autoCollapseTimer = null;
                            }
                            chatTooltip.classList.add('hidden');
                            // ç§»é™¤ç›‘å¬å™¨ï¼Œå› ä¸ºå·²ç»å®Œæˆä»»åŠ¡
                            toggleBtn.removeEventListener('click', handleToggleClick);
                        };

                        // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
                        textInputBox.addEventListener('focus', handleFocus);
                        toggleBtn.addEventListener('click', handleToggleClick);

                        // æ¯æ¬¡é¡µé¢åŠ è½½éƒ½æ‰§è¡Œï¼š5ç§’åè‡ªåŠ¨æŠ˜å æ•´ä¸ªå¯¹è¯åŒºï¼ˆé™¤éæœ‰æ´»åŠ¨èœå•ï¼‰
                        autoCollapseTimer = setTimeout(() => {
                            // æ£€æŸ¥æ˜¯å¦æœ‰æ´»åŠ¨èœå•ï¼Œå¦‚æœæœ‰åˆ™ä¸è‡ªåŠ¨æŠ˜å 
                            if (window.activeMenuCount > 0) {
                                return;
                            }

                            // å…ˆéšè—æç¤ºæ¡†ï¼ˆå¸¦åŠ¨ç”»ï¼‰
                            chatTooltip.classList.add('hidden');
                            // ç­‰å¾…æç¤ºæ¡†åŠ¨ç”»å®Œæˆåå†æŠ˜å å¯¹è¯åŒº
                            setTimeout(() => {
                                // å†æ¬¡æ£€æŸ¥æ˜¯å¦æœ‰æ´»åŠ¨èœå•
                                if (window.activeMenuCount > 0) {
                                    return;
                                }
                                // ç›´æ¥æ¨¡æ‹Ÿç‚¹å‡»äº‹ä»¶
                                toggleBtn.click();
                            }, 300);
                        }, 5000);
                    }
                }, 100); // 100ms å»¶è¿Ÿç¡®ä¿æ‰€æœ‰åˆå§‹åŒ–å®Œæˆ
            });
        })();
    </script>
    <script>
        // ç›‘å¬è®¾ç½®é¢æ¿åˆ‡æ¢äº‹ä»¶ï¼ˆæ”¯æŒ Live2D å’Œ VRMï¼‰
        // æ³¨æ„ï¼šå ä½ settings-panel å·²ç§»é™¤ï¼Œè¿™äº›äº‹ä»¶ç›‘å¬å™¨ä¿ç•™ç”¨äºæœªæ¥å¯èƒ½çš„å®ç°
        window.addEventListener('live2d-settings-toggle', (e) => {
            // å®‰å…¨åœ°è¯»å– active æ ‡å¿—ï¼Œå¦‚æœ e.detail ä¸å­˜åœ¨åˆ™é»˜è®¤ä¸º false
            const active = e?.detail?.active ?? false;
            console.log('[ä¸»é¡µ] æ”¶åˆ°è®¾ç½®å¼€å…³ä¿¡å·:', active);
            // å ä½é¢æ¿å·²ç§»é™¤ï¼Œæ­¤äº‹ä»¶æš‚æ—¶æ— æ“ä½œ
        });
        
        // ç›‘å¬é€šç”¨è®¾ç½®é¢æ¿åˆ‡æ¢äº‹ä»¶ï¼ˆneko-settings-toggleï¼‰
        window.addEventListener('neko-settings-toggle', (e) => {
            // å®‰å…¨åœ°è¯»å– active æ ‡å¿—ï¼Œå¦‚æœ e.detail ä¸å­˜åœ¨åˆ™é»˜è®¤ä¸º false
            const active = e?.detail?.active ?? false;
            console.log('[ä¸»é¡µ] æ”¶åˆ°é€šç”¨è®¾ç½®å¼€å…³ä¿¡å·:', active);
            // å ä½é¢æ¿å·²ç§»é™¤ï¼Œæ­¤äº‹ä»¶æš‚æ—¶æ— æ“ä½œ
        });
    </script>
</body>

</html>